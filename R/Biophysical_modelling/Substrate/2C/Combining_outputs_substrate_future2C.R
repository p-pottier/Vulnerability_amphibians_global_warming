library(purrr)
library(dplyr)

# List of folders for each type of file
folders <- c("1st_batch", "2nd_batch", "3rd_batch", "4th_batch", "5th_batch", 
             "6th_batch", "7th_batch", "8th_batch", "9th_batch", "10th_batch",
             "11th_batch", "12th_batch", "13th_batch", "14th_batch")

# Initialize empty lists to store the combined dataframes
combined_daily_temp <- list()
combined_daily_temp_warmest_days <- list()

# Loop over each folder
for (folder in folders) {
  # Get the path to the folder
  path_to_rds <- paste("RData/Biophysical_modelling/Substrate/2C/results", folder, sep = "/")
  
  # Get the list of all rds files in the folder
  rds_files <- list.files(path = path_to_rds, pattern = "*.rds", full.names = TRUE)
  
  # Read all the files into a list
  nested_list_results <- lapply(rds_files, readRDS)
  
  # Extract 'result' from each sublist in nested_list_results
  nested_list_results <- lapply(nested_list_results, function(x) lapply(x, function(y) y[["result"]]))
  
  # Flatten the list
  flattened_list <- do.call("c", nested_list_results)
  
  # Combine all dataframes for each metric and store them in the respective lists
  combined_daily_temp[[folder]] <- do.call("rbind", lapply(flattened_list, function(x) x[[1]]))
  combined_daily_temp_warmest_days[[folder]] <- do.call("rbind", lapply(flattened_list, function(x) x[[2]]))
}

# Combine the dataframes from all folders
combined_daily_temp <- do.call("rbind", combined_daily_temp)
combined_daily_temp_warmest_days <- do.call("rbind", combined_daily_temp_warmest_days)

# Convert to numeric values
combined_daily_temp$lon <- as.numeric(combined_daily_temp$lon)
combined_daily_temp$lat <- as.numeric(combined_daily_temp$lat)

combined_daily_temp_warmest_days$lon <- as.numeric(combined_daily_temp_warmest_days$lon)
combined_daily_temp_warmest_days$lat <- as.numeric(combined_daily_temp_warmest_days$lat)

######################################################################################################

# Initialize empty lists to store the combined dataframes
combined_daily_temp_problematic <- list()
combined_daily_temp_warmest_days_problematic <- list()

# Loop over each folder
for (folder in folders) {
  # Get the path to the subfolder "problematic_locations"
  path_to_subfolder <- paste("RData/Biophysical_modelling/Substrate/2C/results", folder, "problematic_locations", sep = "/")
  
  # Check if the subfolder exists
  if (dir.exists(path_to_subfolder)) {
    # Get the list of all rds files in the subfolder
    rds_files <- list.files(path = path_to_subfolder, pattern = "*.rds", full.names = TRUE)
    
    # Read all the files into a list
    nested_list_results <- lapply(rds_files, readRDS)
    
    # Extract the four dataframes from each list and unlist 'lat' and 'lon' columns
    combined_daily_temp_subfolder <- do.call("rbind", lapply(nested_list_results, function(x) {
      df <- x[[1]]
      if (is.list(df$lat)) df$lat <- unlist(df$lat)
      if (is.list(df$lon)) df$lon <- unlist(df$lon)
      df
    }))
    combined_daily_temp_warmest_days_subfolder <- do.call("rbind", lapply(nested_list_results, function(x) {
      df <- x[[2]]
      if (is.list(df$lat)) df$lat <- unlist(df$lat)
      if (is.list(df$lon)) df$lon <- unlist(df$lon)
      df
    }))
    
    # Store the combined dataframes in the respective lists
    combined_daily_temp_problematic[[folder]] <- combined_daily_temp_subfolder
    combined_daily_temp_warmest_days_problematic[[folder]] <- combined_daily_temp_warmest_days_subfolder
  }
}

# Combine the dataframes from all subfolders
combined_daily_temp_problematic <- do.call("rbind", combined_daily_temp_problematic)
combined_daily_temp_warmest_days_problematic <- do.call("rbind", combined_daily_temp_warmest_days_problematic)

#################################################################################################################

# Get the path to the "failed_locations" folder
path_to_failed_locations <- "RData/Biophysical_modelling/Substrate/2C/results/failed_locations"

# Initialize empty lists to store the combined dataframes
combined_daily_temp_failed <- list()
combined_daily_temp_warmest_days_failed <- list()

# Get the list of .rds files in the "failed_locations" folder
rds_files_failed <- list.files(path = path_to_failed_locations, pattern = "*.rds", full.names = TRUE)

# Loop over each .rds file
for (file_failed in rds_files_failed) {
  # Read the .rds file into a list
  nested_list_results_failed <- readRDS(file_failed)
  
  # Extract the four dataframes from the list
  combined_daily_temp_failed_subfolder <- nested_list_results_failed[["result"]][[1]]
  combined_daily_temp_warmest_days_failed_subfolder <- nested_list_results_failed[["result"]][[2]]

  # Store the combined dataframes in the respective lists
  combined_daily_temp_failed[[file_failed]] <- combined_daily_temp_failed_subfolder
  combined_daily_temp_warmest_days_failed[[file_failed]] <- combined_daily_temp_warmest_days_failed_subfolder
}

# Combine the dataframes from all files in the "failed_locations" folder
combined_daily_temp_failed <- do.call("rbind", combined_daily_temp_failed)
combined_daily_temp_warmest_days_failed <- do.call("rbind", combined_daily_temp_warmest_days_failed)

#####################################################################################################

# Combine files
combined_daily_temp_all <- rbind(combined_daily_temp, combined_daily_temp_problematic, combined_daily_temp_failed)
combined_daily_temp_warmest_days_all <- rbind(combined_daily_temp_warmest_days, combined_daily_temp_warmest_days_problematic, combined_daily_temp_warmest_days_failed)

# Remove the first year (burn-in)
combined_daily_temp_all <- filter(combined_daily_temp_all, YEAR!="2005")
combined_daily_temp_warmest_days_all <- filter(combined_daily_temp_warmest_days_all, YEAR!="2005")

# Calculate the overall temperature across coordinates
combined_overall_temp_all <- combined_daily_temp_warmest_days_all %>%
  dplyr::group_by(lon, lat) %>%
  dplyr::summarize(mean = mean(max_temp),
                   median = median(max_temp),
                   fifth_percentile = quantile(max_temp, 0.05),
                   first_quartile = quantile(max_temp, 0.25),
                   third_quartile = quantile(max_temp, 0.75),
                   ninetyfifth_percentile = quantile(max_temp, 0.95),
                   min = min(max_temp),
                   max = max(max_temp), .groups = 'drop')

# Save files
saveRDS(combined_daily_temp_all, file= "RData/Biophysical_modelling/Substrate/2C/daily_temp_substrate_2C.rds")
saveRDS(combined_daily_temp_warmest_days_all, file="RData/Biophysical_modelling/Substrate/2C/daily_temp_warmest_days_substrate_2C.rds")
saveRDS(combined_overall_temp_all, file="RData/Biophysical_modelling/Substrate/2C/overall_temp_warmest_days_substrate_2C.rds")


####################################################################################################

## Check for missing coordinates again

distinct_coord <- readRDS("RData/General_data/distinct_coordinates_adjusted.rds")
distinct_coord <- mutate(distinct_coord, lon_lat = paste(lon, lat))

combined_daily_temp_warmest_days_all <- mutate(combined_daily_temp_warmest_days_all, lon_lat = paste(lon, lat))

# Function opposite of %in%
'%!in%' <- function(x,y)!('%in%'(x,y)) 

missing_coord <- distinct_coord[distinct_coord$lon_lat %!in% combined_daily_temp_warmest_days_all$lon_lat,]
missing_coord
missing_coord_row_numbers <- data.frame(row_n = which(distinct_coord$lon_lat %!in% combined_daily_temp_warmest_days_all$lon_lat))
missing_coord_row_numbers

### 
check_dup<- group_by(combined_daily_temp_all, lon, lat, YEAR, DOY) %>% summarise(n=n())
loc_with_more_than_one<- filter(check_dup, n>1)
loc_with_more_than_one<- mutate(loc_with_more_than_one, lon_lat = paste(lon, lat))
row_n_dup<- data.frame(row_n = which(distinct_coord$lon_lat %in% loc_with_more_than_one$lon_lat))
row_n_dup
dup_coord <- distinct_coord[distinct_coord$lon_lat %in% loc_with_more_than_one$lon_lat,]
dup_coord

# Save the combined data
saveRDS(missing_coord, file= "RData/Biophysical_modelling/Substrate/2C/missing_coordinates.rds")
saveRDS(missing_coord_row_numbers, file="RData/Biophysical_modelling/Substrate/2C/missing_coordinates_row_n.rds")
saveRDS(row_n_dup, file="RData/Biophysical_modelling/Substrate/2C/row_n_duplicated_coordinates.rds")
saveRDS(dup_coord, file="RData/Biophysical_modelling/Substrate/2C/duplicated_coordinates.rds")

