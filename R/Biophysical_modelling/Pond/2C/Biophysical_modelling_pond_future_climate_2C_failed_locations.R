
pacman::p_load(tidyverse,
               raster, 
               rgdal,
               rgeos,
               purrr,
               raster,
               parallel,
               doParallel,
               abind,
               curl,
               zoo,
               sf,
               data.table,
               RNetCDF, 
               NicheMapR, 
               microclima,
               letsR,
               R.utils,
               rlang,
               future,
               furrr,
               future.apply, 
               futile.logger)


## ------------------------------------------------------------------------------------------------------------------------------------

presence <- readRDS(file="RData/General_data/species_coordinates_adjusted.rds")

data_for_imp <- readRDS(file="RData/General_data/pre_data_for_imputation.rds")

presence_body_mass <- merge(presence, dplyr::select(data_for_imp, tip.label, body_mass), by = "tip.label")
median_body_mass <- presence_body_mass %>%
  dplyr::group_by(lon, lat) %>%
  dplyr::summarise(median_mass = median(body_mass, na.rm = TRUE)) %>%
  dplyr::ungroup()

median_body_mass <- mutate(median_body_mass,
                           median_mass = ifelse(is.na(median_mass)==TRUE,
                                                8.4,
                                                median_mass))

# Define a function that replaces NA, NaN, and Inf with 0 
replace_na_inf <- function(lst){
  lapply(lst, function(item){
    if(is.numeric(item)){
      item[is.na(item) | is.nan(item) | is.infinite(item)] <- 0
    } else if(is.character(item)){
      item[is.na(item) | item == "NaN" | item == "Inf"] <- "Unknown"
    } 
    return(item)
  })
}


## -------------------------------------------------------------------------------------------------------------------------------------------

distinct_coord <- readRDS("RData/General_data/distinct_coordinates_adjusted.rds")

distinct_coord <- distinct_coord[,3:4]
distinct_coord <- rename(distinct_coord, 
                         x= lon,
                         y= lat)

indices <- c(154, 155, 359, 1156, 1391, 1629, 1874, 
             4012, 4063, 4238, 4461, 4671, 9304) # Coordinates of failed locations in distinct_coord

run_locations <- function(i) {
  loc <- c(distinct_coord$x[i], distinct_coord$y[i])
  
  dstart <- "01/01/2005"
  dfinish <- "31/12/2015"
  
  ERR <- 2
  
  micro <- NicheMapR::micro_ncep(loc = loc, 
                                 dstart = dstart, 
                                 dfinish = dfinish, 
                                 scenario=2,
                                 minshade=85,
                                 maxshade=90,
                                 Usrhyt = 0.01,
                                 cap = 1,
                                 ERR = ERR, 
                                 spatial = 'data/NCEP',
                                 terra_source = 'data/TerraClimate/data',
                                 run.gads=2)
  
  while(min(micro$metout[,1])==0){
    
    cat("model crashed, trying a higher error tolerance \n")
    
    ERR <- ERR + 0.5
    
    micro <- NicheMapR::micro_ncep(loc = loc, 
                                   dstart = dstart, 
                                   dfinish = dfinish, 
                                   scenario=2,
                                   minshade=85,
                                   maxshade=90,
                                   Usrhyt = 0.01,
                                   cap = 1,
                                   ERR = ERR, 
                                   spatial = 'data/NCEP',
                                   terra_source = 'data/TerraClimate/data',
                                   run.gads=2)
  }
  
  micro <- replace_na_inf(micro)
  
  micro$metout[, 13] <- 0 # Make sure the pond stays in the shade
  
  assign("micro", micro, envir = globalenv())
  
  ecto <- NicheMapR::ectotherm(
    container=1, # container model
    conth=1500, # shallow pond of 1.5m depth
    contw=12000,# pond of 12m width
    contype=1, # container sunk into the ground like a pond
    rainmult = 1000000000, # rainfall multiplier, to keep the pond wet
    continit = 1500, # Initial container water level (1.5m)
    conthole = 0, # Daily loss of height (mm) due to hole in container (e.g. infiltration)
    contwet=100, # 100% of container surface area acting as free water exchanger
    contonly=1)
  
  environ <- as.data.frame(ecto$environ)
  environ <- environ %>% mutate(lon=loc[1], lat=loc[2])
  
  # Max and mean daily temperatures
  daily_temp <- environ %>%
    dplyr::mutate(YEAR = YEAR + 2004,
                  ERR = ERR) %>%
    dplyr::group_by(ERR, YEAR, DOY, lon, lat) %>%
    dplyr::summarize(max_temp = max(TC),
                     mean_temp = mean(TC), .groups = 'drop')
  
  # Create a function to calculate the rolling weekly temperature
  calc_yearly_rolling_mean <- function(data) {
    data$mean_weekly_temp <- zoo::rollapply(data$mean_temp, width = 7, FUN = mean, align = "right", partial = TRUE, fill = NA)
    data$max_weekly_temp <- zoo::rollapply(data$max_temp, width = 7, FUN = mean, align = "right", partial = TRUE, fill = NA)
    return(data)
  }
  
  # Calculate the rolling mean for each year and location
  daily_temp <- daily_temp %>%
    dplyr::group_by(YEAR, lon, lat) %>%
    dplyr::group_modify(~calc_yearly_rolling_mean(.))
  
  # Identify the warmest 91 days (3 months) of each year
  daily_temp_warmest_days <- daily_temp %>%
    dplyr::group_by(YEAR, lon, lat) %>%
    dplyr::top_n(91, max_temp)
  
  # Calculate the mean overall maximum temperature for the warmest days of each year
  overall_temp_warmest_days <- daily_temp_warmest_days %>%
    dplyr::group_by(lon, lat) %>%
    dplyr::summarize(mean = mean(max_temp),
                     median = median(max_temp),
                     fifth_percentile = quantile(max_temp, 0.05),
                     first_quartile = quantile(max_temp, 0.25),
                     third_quartile = quantile(max_temp, 0.75),
                     ninetyfifth_percentile = quantile(max_temp, 0.95),
                     min = min(max_temp),
                     max = max(max_temp), .groups = 'drop')
  
  result <- list(daily_temp, 
                  daily_temp_warmest_days, 
                  overall_temp_warmest_days)
  
  results<- list(success=TRUE, result=result)
  
  saveRDS(results, file=paste0("RData/Biophysical_modelling/Pond/2C/results/failed_locations/results_biophysical_modelling_pond_future2C_", loc[1], "-", loc[2], ".rds"))
  
}

# Run for loop

for(i in 1:length(indices)){
  run_locations(indices[i])
}




