# This code is here to demonstrate how to download and reorder data dimensions from NCEP. This is necessary to run biophysical models. 

library(curl)
years <- seq(2004,2016) # Range of dates
vars <- c('tmax.2m.gauss.','dswrf.sfc.gauss.', 'prate.sfc.gauss.')
vars <- c('tmax.2m.gauss.','dswrf.sfc.gauss.', 'prate.sfc.gauss.', 'vwnd.10m.gauss.',
          'uwnd.10m.gauss.', 'air.2m.gauss.', 'tmin.2m.gauss.', 'shum.2m.gauss.',
          'pres.sfc.gauss.', 'dlwrf.sfc.gauss.', 'ulwrf.sfc.gauss.', 'tcdc.eatm.gauss.')
for(year in years){
  for(j in 1:length(vars)){
    curl_download(paste0("ftp://ftp.cdc.noaa.gov/Datasets/ncep.reanalysis2/gaussian_grid/",vars[j],year, ".nc"), paste0("C:/nco/",vars[j],year, ".nc"),quiet=TRUE, mode="wb")   
  }
} # You can replace the folder you want to save the data in. It is recommended to save it to your local nco/ folder to make sure nco operators communicate properly.


library(ncdf4)
YOUR_LOCATION <- "C:/nco" # Change to desired location.
dir2do <- YOUR_LOCATION
setwd(dir2do)
files<-list.files()
files<-files[grep(".nc", x = files)]
vars4 <- c("tmin", "tmax", "air", "shum", "uwnd", "vwnd")
vars3 <- c("pres", "tcdc", "dswrf", "dlwrf", "ulwrf", "prate")

allvars <- c(vars4, vars3)

for(i in 1:length(files)){
  filenm <- files[i]
  orig <- nc_open(filenm)
  t<-ncvar_get(nc = orig, varid = "time", start = 1, count = -1)
  
  varid <- names(orig$var)[which(names(orig$var) %in% allvars)]
  
  if(length(varid) == 0) {
    cat("No matching variables found in file:", filenm, "\n")
    next # Skip the rest of the loop for this file
  }
  
  if(varid %in% vars3){
    start <- c(1,1,1) # compose the start location vector for getting the data out of the ncdf file for this location
    count <- c(-1,-1,-1) # how much data are wanted? (-1 means all)
  }else{
    start <- c(1,1,1,1) # compose the start location vector for getting the data out of the ncdf file for this location
    count <- c(-1,-1,-1,-1) # how much data are wanted? (-1 means all)
  }
  
  data <- as.numeric(ncvar_get(orig, varid = varid, start = start, count)) # get the data
  lon<-ncvar_get(nc = orig, varid = "lon", start = 1, count = -1) # longitudes
  lat<-ncvar_get(nc = orig, varid = "lat", start = 1, count = -1) # latitudes
  t2 <- ncdim_def(name = "time", units = " hours since 1800-1-1 00:00:0.0", vals = t, unlim=FALSE) # define a time variable
  lon2 <- ncdim_def(name = "lon", units = "degrees_east", vals = lon, unlim=FALSE) # define a longitude variable
  lat2 <- ncdim_def(name = "lat", units = "degrees_north", vals = lat, unlim=FALSE) # define a latitude variable
  att<-ncatt_get(orig, varid, attname=NA, verbose=FALSE) # get attributes from original file
  if(varid %in% vars4){
    level<-ncvar_get(nc = orig, varid = "level", start = 1, count = -1) # levels
    level2 <- ncdim_def(name = "level", units = "m", vals = level, unlim=FALSE) # define a latitude variable
  }
  
  
  if(varid %in% vars3){
    var1 <- ncvar_def(name = varid, units = att$units, dim = list(lon2,lat2,t2), missval = att$missing_value, longname = att$long_name, prec='float') # define the variable
  }else{
    var1 <- ncvar_def(name = varid, units = att$units, dim = list(lon2,lat2,level2,t2), missval = att$missing_value, longname = att$long_name, prec='float') # define the variable
  }
  
  vars <- list(var1) # get variable definition
  file2<-gsub('.nc', replacement = '_time2.nc', x = filenm) # make a new file name
  file3<-gsub('.nc', replacement = '_time.nc', x = filenm) # make a new file name
  ncnew <- nc_create(file2,vars) # create a new ncdf file to put the data in
  ncvar_put(ncnew,var1,data) # put the data in
  nc_close(ncnew) # close the new file
  if(varid %in% vars3){
    cmd<-paste0("ncpdq -a lon,lat,time ",file2," ",file3) # command for ncpdq - permute to reverse order
  }else{
    cmd<-paste0("ncpdq -a lon,lat,level,time ",file2," ",file3) # command for ncpdq - permute to reverse order
  }
  
  system(cmd) # run ncpdq
  
  file.remove(file2) # delete the temporary file
}
