---
title: "Generating data for cross validation"
author: "Patrice Pottier"
date: "latest update: `r format(Sys.time(), '%d %B %Y')`"
output: rmdformats::readthedown
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
# knitr setting
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE, 
  tidy = TRUE,
  cache = TRUE
)
```

# **Load packages and data**

##**Load packages** 

```{r}
pacman::p_load(tidyverse,
               kableExtra,
               DataExplorer,
               viridis,
               viridisLite,
               maps,
               rotl,
               ape,
               patchwork,
               R.utils,
               ggtree, # devtools::install_github("YuLab-SMU/ggtree")
               ggtreeExtra, # devtools::install_github("xiangpin/ggtreeExtra")
               phytools,
               tidytree,
               ggnewscale, # this package is necessary for building trees
               RColorBrewer,
               ggdist,
               ggstatsplot,
               here,
               ggExtra,
               MCMCglmm,
               ggbeeswarm,
               raster,
               sp,
               rasterSp,# remotes::install_github("RS-eco/rasterSp", build_vignettes = T)
               rgeos,
               letsR, 
               rredlist,
               mice,
               phylomice, # devtools::install_github("pdrhlik/phylomice")
               Rphylopars, # devtools::install_github("ericgoolsby/Rphylopars",dependencies = TRUE)
               miceadds,
               GGally,
               mulTree,
               rlist,
               hdrcde,
               forcats,
               bayesplot,
               VIM,
               hmi,
               taxize,# remotes::install_github("ropensci/taxize")
               rredlist)  #remotes::install_github("ropensci/rredlist")

'%!in%' <- function(x,y)!('%in%'(x,y)) # Function opposite of %in%

```


# **Datasets for cross-validation**

Here, we remove ~5% of the original adult species (16 species out of 319), and 5% of the species to impute (234 species out of 4689). 

We specifically removed original data that fit the characteristics of the data to be imputed, i.e., 
                                           ramping=1, # most common ramping
                                           acclimated="acclimated", # acclimated animals
                                           endpoint="OS", # Most common endpoint; most precise one too
                                           life_stage_tested=="adults"
                                           
I generated 5 samples of 16 species. 

```{r, Datasets for cross-validation}
data_for_imp<- readRDS("RData/General_data/data_for_imputation_with_temp.rds")

# Only consider observations that are comparable to the data we impute
training_data_for_crossV <- filter(data_for_imp, imputed=="no" & 
                                           ramping=="1" &
                                           acclimated=="acclimated" &
                                           endpoint=="OS"&
                                           life_stage_tested=="adults") 

training_species_crossV<- distinct(data.frame(tip.label=training_data_for_crossV$tip.label)) # 77 species 

imp_data_for_crossV <- filter(data_for_imp, imputed=="yes")
imp_data_for_crossV <- imp_data_for_crossV[imp_data_for_crossV $tip.label %!in% training_data_for_crossV$tip.label, ] # Make sure we get species not in the original data
imp_species_crossV<- distinct(data.frame(tip.label=imp_data_for_crossV$tip.label)) 

```


```{r}
### First set
set.seed(123)
first_training_sample_16sp_crossV<-data.frame(tip.label=sample(training_species_crossV$tip.label, 16)) # Sample of 16 
first_imp_sample_234sp_crossV<-data.frame(tip.label=sample(imp_species_crossV$tip.label, 234)) # Sample of 234 species

first_crossV <- mutate(data_for_imp, sp_to_validate = ifelse((data_for_imp$tip.label %in% first_training_sample_16sp_crossV$tip.label) == TRUE, "yes", "no")) # flag species to validate

first_crossV <- mutate(first_crossV, dat_to_validate = ifelse(sp_to_validate=="yes"&
                                                              ramping==1&
                                                              endpoint=="OS"&
                                                              life_stage_tested=="adults", "yes", "no")) # flag data to validate

first_crossV<-filter(first_crossV, !(dat_to_validate=="yes"&imputed=="yes")) # Remove the fake data for species we want to cross-validate

first_crossV <- mutate(first_crossV, mean_UTL = ifelse(dat_to_validate == "yes", NA, mean_UTL)) # Set values as NA for these 16 species

first_crossV <- first_crossV[first_crossV$tip.label %!in% first_imp_sample_234sp_crossV$tip.label, ] # Remove the data for 234 fully imputed species

saveRDS(first_crossV, "RData/Imputation/data/Data_crossV_1st_set.rds")
```


```{r}
### Second set 
remaining_sp<- data.frame(tip.label = training_species_crossV[training_species_crossV$tip.label %!in% first_training_sample_16sp_crossV$tip.label,])
  
set.seed(385)
second_training_sample_16sp_crossV<-data.frame(tip.label=sample(remaining_sp$tip.label, 16)) # Sample of 16 species
second_imp_sample_234sp_crossV<-data.frame(tip.label=sample(imp_species_crossV$tip.label, 234)) # Sample of 234 species

second_crossV <- mutate(data_for_imp, sp_to_validate = ifelse((data_for_imp$tip.label %in% second_training_sample_16sp_crossV$tip.label) == TRUE, "yes", "no")) # flag species to validate

second_crossV <- mutate(second_crossV, dat_to_validate = ifelse(sp_to_validate=="yes"&
                                                              ramping==1&
                                                              endpoint=="OS"&
                                                              life_stage_tested=="adults", "yes", "no")) # flag data to validate

second_crossV<-filter(second_crossV, !(dat_to_validate=="yes"&imputed=="yes")) # Remove the fake data for species we want to cross-validate

second_crossV <- mutate(second_crossV, mean_UTL = ifelse(dat_to_validate == "yes", NA, mean_UTL)) # Set values as NA for these 16 species

second_crossV <- second_crossV[second_crossV$tip.label %!in% second_imp_sample_234sp_crossV$tip.label, ] # Remove the data for 234 fully imputed species

saveRDS(second_crossV, "RData/Imputation/data/Data_crossV_2nd_set.rds")

```


```{r}
### Third set
remaining_sp<- data.frame(tip.label=remaining_sp[remaining_sp$tip.label %!in% second_training_sample_16sp_crossV$tip.label,])
set.seed(390)
third_training_sample_16sp_crossV<-data.frame(tip.label=sample(remaining_sp$tip.label, 16)) # Sample of 16 species
third_imp_sample_234sp_crossV<-data.frame(tip.label=sample(imp_species_crossV$tip.label, 234)) # Sample of 234 species

third_crossV <- mutate(data_for_imp, sp_to_validate = ifelse((data_for_imp$tip.label %in% third_training_sample_16sp_crossV$tip.label) == TRUE, "yes", "no")) # flag species to validate

third_crossV <- mutate(third_crossV, dat_to_validate = ifelse(sp_to_validate=="yes"&
                                                                ramping==1&
                                                                endpoint=="OS"&
                                                                life_stage_tested=="adults", "yes", "no")) # flag data relevant for validation for these species

third_crossV<-filter(third_crossV, !(dat_to_validate=="yes"&imputed=="yes")) # Remove the fake data for species we want to cross-validate

third_crossV <- mutate(third_crossV, mean_UTL = ifelse(dat_to_validate == "yes", NA, mean_UTL)) # Set values as NA for these 15 species 15 species

third_crossV <- third_crossV [third_crossV$tip.label %!in% third_imp_sample_234sp_crossV$tip.label, ] # Remove the data 234 fully-imputed species

saveRDS(third_crossV, "RData/Imputation/data/Data_crossV_3rd_set.rds")

```



```{r}

### Fourth set 
remaining_sp<- data.frame(tip.label=remaining_sp[remaining_sp$tip.label %!in% third_training_sample_16sp_crossV$tip.label,])
set.seed(369)
fourth_training_sample_16sp_crossV<-data.frame(tip.label=sample(remaining_sp$tip.label, 16)) # Sample of 16 species
fourth_imp_sample_234sp_crossV<-data.frame(tip.label=sample(imp_species_crossV$tip.label, 234)) # Sample of 234 species

fourth_crossV <- mutate(data_for_imp, sp_to_validate = ifelse((data_for_imp$tip.label %in% fourth_training_sample_16sp_crossV$tip.label) == TRUE, "yes", "no")) # flag species to validate

fourth_crossV <- mutate(fourth_crossV, dat_to_validate = ifelse(sp_to_validate=="yes"&
                                                                  ramping==1&
                                                                  endpoint=="OS"&
                                                                  life_stage_tested=="adults", "yes", "no")) # flag data relevant for validation for these species

fourth_crossV<-filter(fourth_crossV, !(dat_to_validate=="yes"&imputed=="yes")) # Remove the fake data for species we want to cross-validate

fourth_crossV <- mutate(fourth_crossV, mean_UTL = ifelse(dat_to_validate == "yes", NA, mean_UTL)) # Set values as NA for these 15 species 15 species

fourth_crossV <- fourth_crossV [fourth_crossV$tip.label %!in% fourth_imp_sample_234sp_crossV$tip.label, ] # Remove the data 234 fully-imputed species

saveRDS(fourth_crossV, "RData/Imputation/data/Data_crossV_4th_set.rds")

```


```{r}

### Fifth set 
remaining_sp<- data.frame(tip.label=remaining_sp[remaining_sp$tip.label %!in% fourth_training_sample_16sp_crossV$tip.label,]) # 13
set.seed(536)
fifth_training_sample_16sp_crossV<-rbind(data.frame(tip.label=sample(training_species_crossV$tip.label, 3)), 
                                   remaining_sp) # Sample of 3 extra species species because we have only 13 remaining

fifth_imp_sample_234sp_crossV<-data.frame(tip.label=sample(imp_species_crossV$tip.label, 234)) # Sample of 234 species

fifth_crossV <- mutate(data_for_imp, sp_to_validate = ifelse((data_for_imp$tip.label %in% fifth_training_sample_16sp_crossV$tip.label) == TRUE, "yes", "no")) # flag species to validate

fifth_crossV <- mutate(fifth_crossV, dat_to_validate = ifelse(sp_to_validate=="yes"&
                                                                ramping==1&
                                                                endpoint=="OS"&
                                                                life_stage_tested=="adults", "yes", "no")) # flag data relevant for validation for these species

fifth_crossV<-filter(fifth_crossV, !(dat_to_validate=="yes"&imputed=="yes")) # Remove the fake data for species we want to cross-validate

fifth_crossV <- mutate(fifth_crossV, mean_UTL = ifelse(dat_to_validate == "yes", NA, mean_UTL)) # Set values as NA for these 15 species 15 species

fifth_crossV <- fifth_crossV [fifth_crossV$tip.label %!in% fifth_imp_sample_234sp_crossV$tip.label, ] # Remove the data 234 fully-imputed species

saveRDS(fifth_crossV, "RData/Imputation/data/Data_crossV_5th_set.rds")
```

