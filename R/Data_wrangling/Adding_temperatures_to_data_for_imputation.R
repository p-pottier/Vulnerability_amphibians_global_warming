
pacman::p_load(tidyverse,
               raster, 
               rgdal,
               rgeos,
               purrr,
               raster,
               parallel,
               doParallel,
               abind,
               curl,
               zoo,
               sf,
               data.table,
               RNetCDF, 
               NicheMapR, 
               microclima,
               letsR)


## ---- Match species to coordinates-----------------------------------------------------------------------------------------------

## Load preliminary data for imputation
data_for_imp <- readRDS(file="RData/General_data/pre_data_for_imputation.rds")

## Load occurence data
species_occurrence <- readRDS(file="RData/General_data/species_coordinates_adjusted.rds")
# Combine temperature data 

### Maximum temperature

overall_temp<-readRDS("Rdata/Biophysical_modelling/Substrate/current/overall_temp_warmest_days_substrate.rds")

overall_temp$lon <- as.numeric(overall_temp$lon)
overall_temp$lat <- as.numeric(overall_temp$lat)

# Merge coordinates with the mean maximum temperature of the warmest days across the species distribution
species_occurrence_temp <- merge(species_occurrence, overall_temp, by.x = c("lat", "lon"), by.y = c("lat", "lon"))

# Group by species and calculate mean for each variable
species_temp_values <- species_occurrence_temp %>%
  group_by(tip.label) %>%
  summarize(
    mean_mean = mean(mean),
    mean_median = mean(median),
    mean_fifth_percentile = mean(fifth_percentile),
    mean_first_quartile = mean(first_quartile),
    mean_third_quartile = mean(third_quartile),
    mean_ninetyfifth_percentile = mean(ninetyfifth_percentile),
    mean_min = mean(min),
    mean_max = mean(max),
    .groups = 'drop'
  )


# Filter the relevant columns (here adding data from the 5th and 95th percentiles)
species_temp_values_filtered <- species_temp_values %>% 
  dplyr::select(tip.label, mean_median, mean_fifth_percentile, mean_ninetyfifth_percentile)

# Pivot the data frame into long format
species_temp_values_long <- species_temp_values_filtered %>% 
  pivot_longer(cols = c(mean_median, mean_fifth_percentile, mean_ninetyfifth_percentile),
               names_to = "temp_range",
               values_to = "acclimation_temp") %>% 
  mutate(tip.label = gsub("\\.", "_", tip.label), # replace dots with underscores
         temp_range = gsub("^mean_", "", temp_range)) # remove "mean_" from temp_range

# Reorder the columns
species_temp_values_long <- species_temp_values_long %>% 
  dplyr::select(tip.label, temp_range, acclimation_temp)

# Rename the "mean_median" column to "median", etc.
names(species_temp_values_long)[2:3] <- c("temp_range", "acclimation_temp")
species_temp_values_long$tip.label <-  gsub("_", " ", species_temp_values_long$tip.label)

# Join with data for imputation

species_temp_values_long$tip.label[species_temp_values_long$tip.label=="Scinax x signatus"] <- "Scinax x-signatus" # Rename
species_temp_values_long$tip.label[species_temp_values_long$tip.label=="Pristimantis w nigrum"] <- "Pristimantis w-nigrum" # Rename

# Split data_for_imp into two data frames
data_for_imp_nonNA <- data_for_imp %>% 
  filter(!is.na(acclimation_temp))

data_for_imp_NA <- data_for_imp %>% 
  filter(is.na(acclimation_temp)) %>% 
  dplyr::select(-acclimation_temp)  # Remove the NA acclimation_temp column


# Perform a full join on data_for_imp_NA and species_temp_values_long
data_for_imp_NA <- full_join(data_for_imp_NA, species_temp_values_long, by = "tip.label")

# Combine the two data frames
data_for_imp_with_temp <- bind_rows(data_for_imp_nonNA, data_for_imp_NA)


saveRDS(data_for_imp_with_temp, file="RData/General_data/data_for_imputation_with_temp.rds")
