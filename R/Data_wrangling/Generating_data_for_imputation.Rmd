---
title: "Data_wrangling with larvae"
author: "Patrice Pottier"
date: "latest update: `r format(Sys.time(), '%d %B %Y')`"
output: rmdformats::readthedown
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
# knitr setting
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE, 
  tidy = TRUE,
  cache = TRUE
)
```

# **Load packages and data**

##**Load packages** 

```{r}
pacman::p_load(tidyverse,
               kableExtra,
               DataExplorer,
               viridis,
               viridisLite,
               maps,
               rotl,
               ape,
               patchwork,
               R.utils,
               ggtree, # devtools::install_github("YuLab-SMU/ggtree")
               ggtreeExtra, # devtools::install_github("xiangpin/ggtreeExtra")
               phytools,
               tidytree,
               ggnewscale, # this package is necessary for building trees
               RColorBrewer,
               ggdist,
               ggstatsplot,
               here,
               ggExtra,
               MCMCglmm,
               ggbeeswarm,
               raster,
               sp,
               rasterSp,# remotes::install_github("RS-eco/rasterSp", build_vignettes = T)
               rgeos,
               letsR, 
               rredlist,
               mice,
               phylomice, # devtools::install_github("pdrhlik/phylomice")
               Rphylopars, # devtools::install_github("ericgoolsby/Rphylopars",dependencies = TRUE)
               miceadds,
               GGally,
               mulTree,
               rlist,
               hdrcde,
               forcats,
               bayesplot,
               VIM,
               hmi,
               taxize,# remotes::install_github("ropensci/taxize")
               rredlist)  #remotes::install_github("ropensci/rredlist")

'%!in%' <- function(x,y)!('%in%'(x,y)) # Function opposite of %in%

```


## **Load data and phylogenetic tree**

```{r}
d <- read_csv("data/data_Pottier_et_al_2022.csv") # Curated data from Pottier et al. (2022) Scientific Data
tree <- read.tree("data/Jetz_Pyron_2018_consensus.tre") # Load consensus tree from Jetz and Pyron (2018) Nature Ecology and Evolution
tree_metadata <- read_csv("data/Jetz_Pyron_metadata_tree.csv") # Metadata for species in the tree
Johnson <- read_csv("data/data_Johnson_et_al_2023.csv") # Body mass data from Johnson et al. (2023) Global Ecology and Biogeography
ecotype <- read_csv("data/ecotype_data.csv") # Ecotype data from Nicholas Wu & Jacinta Kong; supplemented by data from Pietro Pollo and A. Nayelli Rivera-Villanueva

#TODO Add citations. 
```

## **Load and process data from the IUCN**

```{r}
IUCN_polygons<- shapefile('data/amphibian_IUCN_maps/AMPHIBIANS.shp')

IUCN_polygons<-IUCN_polygons[IUCN_polygons$presence==1,] # Only keep extant amphibians
IUCN_polygons<-IUCN_polygons[IUCN_polygons$category!="EX", ] # Remove extinct species 
IUCN_polygons<-IUCN_polygons[IUCN_polygons$category!="EW", ]
IUCN_polygons@data$binomial <- IUCN_polygons@data$sci_name

saveRDS(IUCN_polygons, file="RData/General_data/raster_IUCN_polygons.rds")

# create a table with IUCN species names, taxonomic information, and threat status
IUCN_data<- data.frame(tip.label = IUCN_polygons@data$binomial, 
                       order = IUCN_polygons@data$order_, 
                       family = IUCN_polygons@data$family,
                       IUCN_status = IUCN_polygons@data$category)
```

# **Generate training data for the imputation**

Here, we generate a dataset with 3 acclimation temperatures per species with 90% missing data (3000 species in total).

## *Data wrangling for the training data*

```{r, filtering training data}
# Process data from Pottier et al. 2022
d.training <- filter(d, 
                      d$acclimation_temp!="NA"|
                        ambient_temp!="NA"|
                        substrate_temp!="NA"|
                        water_temp!="NA"|
                        field_body_temp!="NA", # Remove data without acclimation or acclimatisation temperatures
                     life_stage_tested=="adults"|life_stage_tested=="larvae") # Take data from both adults and larvae

# Take the acclimatisation temperature (preferably the field body temperature or microenvironmental temperature) as the acclimation temperature
d.training <- d.training %>% 
  mutate(acclimation_temp = ifelse(!is.na(acclimation_temp), acclimation_temp, # Take acclimation temperature when available
                                   ifelse(!is.na(field_body_temp), field_body_temp, # Otherwise take the field body temperature
                                          ifelse(!is.na(substrate_temp), substrate_temp, # Otherwise take the substrate temperature
                                                 ifelse(!is.na(water_temp), water_temp, ambient_temp))))) # Otherwise take the water temperature or ambient temperature


```


## **Match species names with the IUCN** 
```{r}

d.training$tip.label <- d.training$species # Rename species name to tip.label

tree$tip.label <- gsub("_", " ", tree$tip.label) # Remove underscore between species names in the tree

d.training <- data.frame(d.training[d.training$tip.label %in% tree$tip.label, ] ) # Only get species for which we have phylogenetic information

d.not_IUCN <- d.training[d.training$tip.label %!in% IUCN_data$tip.label, ] # Identify species not listed in the IUCN
d.not_IUCN$tip.label <- as.factor(d.not_IUCN$tip.label) # 63 species not matching IUCN red list 

# Rename species name in the data and phylogenetic tree to match IUCN data

### Dendropsophus labialis --> Dendropsophus molitor in redlist 
d.training$tip.label[d.training$tip.label =="Dendropsophus labialis"] <- "Dendropsophus molitor"
tree$tip.label[tree$tip.label =="Dendropsophus labialis"] <- "Dendropsophus molitor"

### Hyla andersonii --> Dryophytes andersonii in redlist
d.training$tip.label[d.training$tip.label =="Hyla andersonii"] <- "Dryophytes andersonii"
tree$tip.label[tree$tip.label =="Hyla andersonii"] <- "Dryophytes andersonii"

### Hyla chrysoscelis --> Dryophytes chrysoscelis in redlist 
d.training$tip.label[d.training$tip.label =="Hyla chrysoscelis"] <- "Dryophytes chrysoscelis"
tree$tip.label[tree$tip.label =="Hyla chrysoscelis"] <- "Dryophytes chrysoscelis"

### Hyla cinerea --> Dryophytes cinereus in redlist
d.training$tip.label[d.training$tip.label =="Hyla cinerea"] <- "Dryophytes cinereus"
tree$tip.label[tree$tip.label =="Hyla cinerea"] <- "Dryophytes cinereus"

### Hyla squirella --> Dryophytes squirellus in redlist 
d.training$tip.label[d.training$tip.label =="Hyla squirella"] <- "Dryophytes squirellus"
tree$tip.label[tree$tip.label =="Hyla squirella"] <- "Dryophytes squirellus"

### Hyla versicolor --> Dryophytes versicolor in redlist 
d.training$tip.label[d.training$tip.label =="Hyla versicolor"] <- "Dryophytes versicolor"
tree$tip.label[tree$tip.label =="Hyla versicolor"] <- "Dryophytes versicolor"

### Hyla walkeri --> Dryophytes walkeri in redlist 
d.training$tip.label[d.training$tip.label =="Hyla walkeri"] <- "Dryophytes walkeri"
tree$tip.label[tree$tip.label =="Hyla walkeri"] <- "Dryophytes walkeri"

### Hynobius fuca --> Hynobius fucus in redlist 
d.training$tip.label[d.training$tip.label =="Hynobius fuca"] <- "Hynobius fucus"
tree$tip.label[tree$tip.label =="Hynobius fuca"] <- "Hynobius fucus"

### Hypsiboas cinerascens --> Boana cinerascens in redlist 
d.training$tip.label[d.training$tip.label =="Hypsiboas cinerascens"] <- "Boana cinerascens"
tree$tip.label[tree$tip.label =="Hypsiboas cinerascens"] <- "Boana cinerascens"

### Hypsiboas faber ---> Boana faber in redlist 
d.training$tip.label[d.training$tip.label =="Hypsiboas faber"] <- "Boana faber"
tree$tip.label[tree$tip.label =="Hypsiboas faber"] <- "Boana faber"

### Hypsiboas geographicus --> Boana geographica in redlist 
d.training$tip.label[d.training$tip.label =="Hypsiboas geographicus"] <- "Boana geographica"
tree$tip.label[tree$tip.label =="Hypsiboas geographicus"] <- "Boana geographica"

### Hypsiboas lanciformis --> Boana lanciformis in redlist
d.training$tip.label[d.training$tip.label =="Hypsiboas lanciformis"] <- "Boana lanciformis"
tree$tip.label[tree$tip.label =="Hypsiboas lanciformis"] <- "Boana lanciformis"

### Hypsiboas punctatus --> Boana punctata in redlist 
d.training$tip.label[d.training$tip.label =="Hypsiboas punctatus"] <- "Boana punctata"
tree$tip.label[tree$tip.label =="Hypsiboas punctatus"] <- "Boana punctata"

### Pachymedusa dacnicolor --> Agalychnis dacnicolor in redlist 
d.training$tip.label[d.training$tip.label =="Pachymedusa dacnicolor"] <- "Agalychnis dacnicolor"
tree$tip.label[tree$tip.label =="Pachymedusa dacnicolor"] <- "Agalychnis dacnicolor"

### Rana berlandieri --> Lithobates berlandieri in redlist 
d.training$tip.label[d.training$tip.label =="Rana berlandieri"] <- "Lithobates berlandieri"
tree$tip.label[tree$tip.label =="Rana berlandieri"] <- "Lithobates berlandieri"

### Rana catesbeiana --> Lithobates catesbeianus
d.training$tip.label[d.training$tip.label =="Rana catesbeiana"] <- "Lithobates catesbeianus"
tree$tip.label[tree$tip.label =="Rana catesbeiana"] <- "Lithobates catesbeianus"

### Rana clamitans --> Lithobates clamitans in redlist 
d.training$tip.label[d.training$tip.label =="Rana clamitans"] <- "Lithobates clamitans"
tree$tip.label[tree$tip.label =="Rana clamitans"] <- "Lithobates clamitans"

### Rana palmipes --> Lithobates palmipes in redlist 
d.training$tip.label[d.training$tip.label =="Rana palmipes"] <- "Lithobates palmipes"
tree$tip.label[tree$tip.label =="Rana palmipes"] <- "Lithobates palmipes"

### Rana palustris --> Lithobates palustris in redlist 
d.training$tip.label[d.training$tip.label =="Rana palustris"] <- "Lithobates palustris"
tree$tip.label[tree$tip.label =="Rana palustris"] <- "Lithobates palustris"

### Rana pipiens --> Lithobates pipiens in redlist 
d.training$tip.label[d.training$tip.label =="Rana pipiens"] <- "Lithobates pipiens"
tree$tip.label[tree$tip.label =="Rana pipiens"] <- "Lithobates pipiens"

### Rana sphenocephala --> Lithobates sphenocephalus in redlist 
d.training$tip.label[d.training$tip.label =="Rana sphenocephala"] <- "Lithobates sphenocephalus"
tree$tip.label[tree$tip.label =="Rana sphenocephala"] <- "Lithobates sphenocephalus"

### Rana sylvatica --> Lithobates sylvaticus in redlist 
d.training$tip.label[d.training$tip.label =="Rana sylvatica"] <- "Lithobates sylvaticus"
tree$tip.label[tree$tip.label =="Rana sylvatica"] <- "Lithobates sylvaticus"

### Rana virgatipes --> Lithobates virgatipes in redlist 
d.training$tip.label[d.training$tip.label =="Rana virgatipes"] <- "Lithobates virgatipes"
tree$tip.label[tree$tip.label =="Rana virgatipes"] <- "Lithobates virgatipes"

### Rana warszewitschii --> Lithobates warszewitschii in redlist
d.training$tip.label[d.training$tip.label =="Rana warszewitschii"] <- "Lithobates warszewitschii"
tree$tip.label[tree$tip.label =="Rana warszewitschii"] <- "Lithobates warszewitschii"

### Rhinella schneideri ---> Rhinella diptycha in redlist
d.training$tip.label[d.training$tip.label =="Rhinella schneideri"] <- "Rhinella diptycha"

### Syncope bassleri --> Chiasmocleis bassleri in redlist
d.training$tip.label[d.training$tip.label =="Syncope bassleri"] <- "Chiasmocleis bassleri"
tree$tip.label[tree$tip.label =="Syncope bassleri"] <- "Chiasmocleis bassleri"

### Ecnomiohyla miotympanum --> Rheohyla miotympanum in redlist 
d.training$tip.label[d.training$tip.label =="Ecnomiohyla miotympanum"] <- "Rheohyla miotympanum"
tree$tip.label[tree$tip.label =="Ecnomiohyla miotympanum"] <- "Rheohyla miotympanum"

### Eupemphix nattereri --> Physalaemus nattereri
d.training$tip.label[d.training$tip.label =="Eupemphix nattereri"] <- "Physalaemus nattereri"
tree$tip.label[tree$tip.label =="Eupemphix nattereri"] <- "Physalaemus nattereri"

### Hylarana labialis --> Chalcorana labialis 
d.training$tip.label[d.training$tip.label =="Hylarana labialis"] <- "Chalcorana labialis"
tree$tip.label[tree$tip.label =="Hylarana labialis"] <- "Chalcorana labialis"

### Hypsiboas albomarginatus --> Boana albomarginata
d.training$tip.label[d.training$tip.label =="Hypsiboas albomarginatus"] <- "Boana albomarginata"
tree$tip.label[tree$tip.label =="Hypsiboas albomarginatus"] <- "Boana albomarginata"

### Hypsiboas albopunctatus --> Boana albopunctata
d.training$tip.label[d.training$tip.label =="Hypsiboas albopunctatus"] <- "Boana albopunctata"
tree$tip.label[tree$tip.label =="Hypsiboas albopunctatus"] <- "Boana albopunctata"

### Hypsiboas boans --> Boana boans
d.training$tip.label[d.training$tip.label =="Hypsiboas boans"] <- "Boana boans"
tree$tip.label[tree$tip.label =="Hypsiboas boans"] <- "Boana boans"

### Hypsiboas crepitans --> Boana crepitans
d.training$tip.label[d.training$tip.label =="Hypsiboas crepitans"] <- "Boana crepitans"
tree$tip.label[tree$tip.label =="Hypsiboas crepitans"] <- "Boana crepitans"

### Hypsiboas curupi --> Boana curupi
d.training$tip.label[d.training$tip.label =="Hypsiboas curupi"] <- "Boana curupi"
tree$tip.label[tree$tip.label =="Hypsiboas curupi"] <- "Boana curupi"

### Hypsiboas fasciatus --> Boana fasciata
d.training$tip.label[d.training$tip.label =="Hypsiboas fasciatus"] <- "Boana fasciata"
tree$tip.label[tree$tip.label =="Hypsiboas fasciatus"] <- "Boana fasciata"

### Hypsiboas pardalis --> Boana pardalis 
d.training$tip.label[d.training$tip.label =="Hypsiboas pardalis"] <- "Boana pardalis"
tree$tip.label[tree$tip.label =="Hypsiboas pardalis"] <- "Boana pardalis"

### Hypsiboas pellucens --> Boana pellucens
d.training$tip.label[d.training$tip.label =="Hypsiboas pellucens"] <- "Boana pellucens"
tree$tip.label[tree$tip.label =="Hypsiboas pellucens"] <- "Boana pellucens"

### Hypsiboas pulchellus --> Boana pulchella
d.training$tip.label[d.training$tip.label =="Hypsiboas pulchellus"] <- "Boana pulchella"
tree$tip.label[tree$tip.label =="Hypsiboas pulchellus"] <- "Boana pulchella"

### Hypsiboas raniceps --> Boana raniceps
d.training$tip.label[d.training$tip.label =="Hypsiboas raniceps"] <- "Boana raniceps"

### Hypsiboas rosenbergi --> Boana raniceps
d.training$tip.label[d.training$tip.label =="Hypsiboas rosenbergi"] <- "Boana raniceps"
tree$tip.label[tree$tip.label =="Hypsiboas rosenbergi"] <- "Boana raniceps"

### Hypsiboas semilineatus --> Boana semilineata
d.training$tip.label[d.training$tip.label =="Hypsiboas semilineatus"] <- "Boana semilineata"
tree$tip.label[tree$tip.label =="Hypsiboas semilineatus"] <- "Boana semilineata"

### Phyllomedusa nordestina --> Pithecopus nordestinus
d.training$tip.label[d.training$tip.label =="Phyllomedusa nordestina"] <- "Pithecopus nordestinus"
tree$tip.label[tree$tip.label =="Phyllomedusa nordestina"] <- "Pithecopus nordestinus"

### Phyllomedusa rohdei --> Pithecopus rohdei
d.training$tip.label[d.training$tip.label =="Phyllomedusa rohdei"] <- "Pithecopus rohdei"
tree$tip.label[tree$tip.label =="Phyllomedusa rohdei"] <- "Pithecopus rohdei"

### Rana bwana--> Lithobates bwana
d.training$tip.label[d.training$tip.label =="Rana bwana"] <- "Lithobates bwana"
tree$tip.label[tree$tip.label =="Rana bwana"] <- "Lithobates bwana"

### Rana vaillanti --> Lithobates vaillanti
d.training$tip.label[d.training$tip.label =="Rana vaillanti"] <- "Lithobates vaillanti"
tree$tip.label[tree$tip.label =="Rana vaillanti"] <- "Lithobates vaillanti"

### Rhinella humboldti --> Rhinella granulosa
d.training$tip.label[d.training$tip.label =="Rhinella humboldti"] <- "Rhinella granulosa"

### Scinax agilis --> Ololygon agilis
d.training$tip.label[d.training$tip.label =="Scinax agilis"] <- "Ololygon agilis"
tree$tip.label[tree$tip.label =="Scinax agilis"] <- "Ololygon agilis"

### Scinax aromothyella --> Ololygon aromothyella
d.training$tip.label[d.training$tip.label =="Scinax aromothyella"] <- "Ololygon aromothyella"
tree$tip.label[tree$tip.label =="Scinax aromothyella"] <- "Ololygon aromothyella"

### Scinax strigilatus --> Ololygon strigilata
d.training$tip.label[d.training$tip.label =="Scinax strigilatus"] <- "Ololygon strigilata"
tree$tip.label[tree$tip.label =="Scinax strigilatus"] <- "Ololygon strigilata"

### Sphaenorhynchus pauloalvini --> Gabohyla pauloalvini
d.training$tip.label[d.training$tip.label =="Sphaenorhynchus pauloalvini"] <- "Gabohyla pauloalvini"
tree$tip.label[tree$tip.label =="Sphaenorhynchus pauloalvini"] <- "Gabohyla pauloalvini"

####### Species not matching IUCN or not having distribution ranges #######

# Hypsiboas almendarizae --> not in IUCN
# Elachistocleis muiraquitan --> not in IUCN
# Epipedobates darwinwallacei --> not in IUCN
# Hyloxalus yasuni --> not in IUCN
# Pristimantis reichlei --> not in IUCN
# Pristimantis bicantus --> not in IUCN
# Plethodon chlorobryonis --> not in IUCN
# Plethodon grobmani --> not in IUCN
# Plethodon ocmulgee --> not in IUCN
# Plethodon variolatus --> not in IUCN
# Rhinella azarai --> not in IUCN
# Trachycephalus cunauaru --> not in IUCN
# Scinax strigilatus --> in the IUCN, but no geographical distribution
# Uperoleia marmorata --> in the IUCN, but no geographical distribution

saveRDS(tree, "Rdata/General_data/tree_for_imputation.rds")  # Save the modified phylogenetic tree

d.not_IUCN<-d.training[d.training$tip.label %!in% IUCN_data$tip.label, ] # Check if all replacements were done correctly
unique(d.not_IUCN$species) # All good, 14 species not captured

d.training<-d.training[d.training$tip.label %in% IUCN_data$tip.label, ] # Only get species for which we have IUCN ranges
d.training<-unique(d.training)

species<-distinct(data.frame(tip.label=d.training$tip.label)) # List of unique species names (524 species with phylogeny and distribution range)

```



## *Merge ecotype data with the training data and do additional processing*
```{r}
# Select relevant variables
d.training <- dplyr::select(d.training,
                            tip.label, 
                            order,
                            family,
                            acclimated, 
                            acclimation_temp,
                            acclimation_time,  
                            life_stage_tested,
                            SVL,
                            body_mass,
                            endpoint, 
                            medium_test_temp, 
                            ramping, 
                            mean_UTL, 
                            error_UTL,
                            n_UTL,
                            error_type)

d.training <- left_join(d.training, dplyr::select(unique(IUCN_data), tip.label, IUCN_status)) # Update IUCN status

# Process ecotype data 
ecotype$tip.label <- ecotype$binomial # Rename species name
ecotype$order_name <- str_to_title(ecotype$order_name)
ecotype$family_name <- str_to_title(ecotype$family_name)
ecotype$binomial_tree_phylo <- gsub("_", " ", ecotype$binomial_tree_phylo)

ecotype_sp<-ecotype

# Match the different variables in the ecotype data to the training data
ecotype_IUCN_match <- ecotype_sp[ecotype_sp$binomial_IUCN %in% d.training$tip.label, ] %>% mutate(matched_var="binomial_IUCN")
ecotype_binomial_match <- ecotype_sp[ecotype_sp$binomial %in% d.training$tip.label, ] %>%   mutate(matched_var = "binomial")
ecotype_phylo_match <- ecotype_sp[ecotype_sp$binomial_tree_phylo %in% d.training$tip.label, ] %>%  mutate(matched_var = "binomial_tree_phylo")


# Combine the datasets and create the 'tip.label' column based on the 'matched_var' colum
combined_data <- bind_rows(ecotype_IUCN_match, ecotype_binomial_match, ecotype_phylo_match) %>%
  mutate(tip.label = case_when(
    matched_var == "binomial_IUCN" ~ binomial_IUCN,
    matched_var == "binomial" ~ binomial,
    matched_var == "binomial_tree_phylo" ~ binomial_tree_phylo
  ))

ecotype_sp <- combined_data %>%
  distinct(tip.label, .keep_all = TRUE) 

# Merge ecotype information in the training data
d.training <- left_join(d.training, dplyr::select(ecotype_sp, tip.label, ecotype, second_ecotype, strategy, Notes)) 


d.training <- d.training %>% mutate(sd_UTL= ifelse(error_type=="se" & is.na(n_UTL)=="TRUE", 
                                                   NA, 
                                                   ifelse(error_type=="sd", 
                                                          error_UTL, 
                                                          error_UTL*sqrt(n_UTL)))) # Convert SE to SD
```

## *Select a sample of species to be imputed*

Here, we focus on species for which we have ecotype data.

```{r, selecting species we don't have data for, and inferring their distribution range}

# Filter species for which we have IUCN distribution range and phylogenetic position

tree_sp<-data.frame(tip.label = tree$tip.label) # Data frame with all species in the phylogenetic tree

tree_sp<-data.frame(tip.label = tree_sp[tree_sp$tip.label %in% IUCN_data$tip.label, ] )# Only get species for which we have IUCN ranges (5792)

ecotype_sp<-dplyr::select(ecotype, order_name, family_name, ecotype, second_ecotype, strategy, Notes, SVL_cm, mass_g, binomial, binomial_IUCN, binomial_tree_phylo)

# Match the different variables in the ecotype data to the phylogenetic tree
ecotype_IUCN_match <- ecotype_sp[ecotype_sp$binomial_IUCN %in% tree_sp$tip.label, ] %>% mutate(matched_var="binomial_IUCN")
ecotype_binomial_match <- ecotype_sp[ecotype_sp$binomial %in% tree_sp$tip.label, ] %>%   mutate(matched_var = "binomial")
ecotype_phylo_match <- ecotype_sp[ecotype_sp$binomial_tree_phylo %in% tree_sp$tip.label, ] %>%  mutate(matched_var = "binomial_tree_phylo")

# Combine the datasets and create the 'tip.label' column based on the 'matched_var' colum
combined_data <- bind_rows(ecotype_IUCN_match, ecotype_binomial_match, ecotype_phylo_match) %>%
  mutate(tip.label = case_when(
    matched_var == "binomial_IUCN" ~ binomial_IUCN,
    matched_var == "binomial" ~ binomial,
    matched_var == "binomial_tree_phylo" ~ binomial_tree_phylo
  ))

ecotype_sp <- combined_data %>%
  distinct(tip.label, .keep_all = TRUE) 


# Remove obligate cave-dwellers
ecotype_sp <- ecotype_sp %>% 
   filter(strategy != "Obligate cave-dweller" | is.na(strategy)==TRUE)

# Add a mention for paedomorphic species 
ecotype_sp <- ecotype_sp %>% 
  mutate(strategy = ifelse(strategy == "Paedomorphic"| Notes == "Paedomorphic", "Paedomorphic", NA)) %>% 
  dplyr::select(-Notes)

## Now we create a list of data-deficient species that match the phylogeny and for which we know the ecotype

data_deficient_sp<-data.frame(tip.label = tree_sp[tree_sp$tip.label %!in% d.training$tip.label, ]) # Data frame with all species we do not have data for (5268)

data_deficient_sp <- data.frame(tip.label = data_deficient_sp[data_deficient_sp$tip.label %in% ecotype_sp$tip.label, ]) # Focus on species we have ecotype data (4822)


data_deficient_sp<-left_join(data_deficient_sp, ecotype_sp, by="tip.label") # Assign ecotype data to each species. 
data_deficient_sp<-left_join(data_deficient_sp, dplyr::select(unique(IUCN_data), tip.label, IUCN_status))

data_deficient_sp<-dplyr::select(data_deficient_sp, tip.label, order=order_name, family=family_name, IUCN_status, ecotype, second_ecotype, strategy, SVL=SVL_cm, mass_g) # 4874 species

# Add body mass data from Johnson et al. 2023 

Johnson$tip.label <- Johnson$Species
Johnson$tip.label <- gsub("_", " ", Johnson$tip.label)
Johnson$mass_Johnson <- Johnson$Body_mass

data_deficient_sp <- left_join(data_deficient_sp, dplyr::select(Johnson, tip.label, mass_Johnson),
                               by = "tip.label")

# Choose the body mass from Niky and Wu (2023) when available, otherwise take it from Johnson et al. 2023 
data_deficient_sp <- data_deficient_sp %>%  mutate(body_mass = ifelse(is.na(mass_g)==FALSE,
                                                                mass_g, 
                                                                mass_Johnson))


# Remove Caecilians because we did not have data for this Order. 
data_deficient_sp<-filter(data_deficient_sp, order!="Gymnophiona")


# All species that will be imputed (4679 species)
all_species <- dplyr::select(data_deficient_sp, -mass_g, -mass_Johnson)
```


## *Process species in the training data that will be imputed*

We will also generate 3 new estimates per species, for the species we already have in the training dataset. This will allow us to standardise CTmax estimates using the same parameters. 

```{r}
species_training <- dplyr::select(d.training, 
                                  tip.label,
                                  order,
                                  family,
                                  IUCN_status)
# Match with the ecotype dataset
species_training <- left_join(species_training, dplyr::select(ecotype_sp, 
                                                              tip.label,
                                                              ecotype, 
                                                              second_ecotype,
                                                              SVL=SVL_cm,
                                                              mass_g))
# Match with Johnson et al. body mass data
species_training <- left_join(species_training, dplyr::select(Johnson, 
                                                              tip.label, 
                                                              mass_Johnson))
# Take the data from Johnson et al. when available
species_training <- species_training %>%  mutate(body_mass = ifelse(is.na(mass_g)==FALSE,
                                                             mass_g, 
                                                             mass_Johnson)) %>% 
                                          dplyr::select(-mass_g, -mass_Johnson)
```



## *Merge datasets of species we need to impute and assign predictors*

```{r}
data_to_imp <- full_join(species_training, all_species) 
data_to_imp <- distinct(data_to_imp)

data_to_imp  <- data_to_imp %>% mutate(ramping=1, # most common ramping
                                       acclimated="acclimated", # acclimated animals
                                       acclimation_temp = NA, #  TBD with biophysical models
                                       acclimation_time=10, # most common acclimation time
                                       endpoint="OS", # Most common endpoint; most precise one too
                                       medium_test_temp="body_water", # Body or water temperature recorded during assay
                                       life_stage_tested="adults",
                                       imputed="yes") 
```


## *Combine with training data*

```{r}

d.training<-mutate(d.training, imputed="no") # add a column "imputed"

d.training <- mutate(d.training, medium_test_temp = ifelse(medium_test_temp=="body"|medium_test_temp=="water", "body_water", "ambient")) 

data_for_imp<- full_join(d.training, data_to_imp) # Join the train data to the data to impute 

data_for_imp<-mutate(data_for_imp, species=tip.label) # Add another column for species so we can use this as a random effect as well.

data_for_imp<-mutate(data_for_imp, row_n = as.character(row_number()))


# Manually add missing ecotypes

# subset the data_for_imp dataframe to remove the rows with missing ecotype values
data_with_ecotypes <- data_for_imp[!is.na(data_for_imp$ecotype),]

# Identify missing species
missing_ecotypes <- data_for_imp[is.na(data_for_imp$ecotype),]


missing_ecotypes[missing_ecotypes$tip.label == "Cophixalus australis", "ecotype"] <- "Ground-dwelling"
missing_ecotypes[missing_ecotypes$tip.label == "Oreobates gemcare", "ecotype"] <- "Ground-dwelling"
missing_ecotypes[missing_ecotypes$tip.label == "Oreobates granulosus", "ecotype"] <- "Ground-dwelling"
missing_ecotypes[missing_ecotypes$tip.label == "Dryophytes walkeri", "ecotype"] <- "Ground-dwelling"
missing_ecotypes[missing_ecotypes$tip.label == "Hynobius fucus", "ecotype"] <- "Ground-dwelling"
missing_ecotypes[missing_ecotypes$tip.label == "Kalophrynus limbooliati", "ecotype"] <- "Ground-dwelling"
missing_ecotypes[missing_ecotypes$tip.label == "Pristimantis festae", "ecotype"] <- "Ground-dwelling"
missing_ecotypes[missing_ecotypes$tip.label == "Pristimantis matidiktyo", "ecotype"] <- "Ground-dwelling"
missing_ecotypes[missing_ecotypes$tip.label == "Pristimantis pharangobates", "ecotype"] <- "Ground-dwelling"

missing_ecotypes[missing_ecotypes$tip.label == "Chalcorana labialis", "ecotype"] <- "Stream-dwelling"
missing_ecotypes[missing_ecotypes$tip.label == "Hyloxalus italoi", "ecotype"] <- "Stream-dwelling"

missing_ecotypes[missing_ecotypes$tip.label == "Cynops orientalis", "ecotype"] <- "Aquatic"
missing_ecotypes[missing_ecotypes$tip.label == "Paramesotriton labiatus", "ecotype"] <- "Aquatic"

missing_ecotypes[missing_ecotypes$tip.label == "Dendropsophus molitor", "ecotype"] <- "Arboreal"
missing_ecotypes[missing_ecotypes$tip.label == "Polypedates braueri", "ecotype"] <- "Arboreal"

# merge the two data frames based on matching tip.label values
data_for_imp <- rbind(data_with_ecotypes, missing_ecotypes)

# Save the preliminary data for the imputation (we still need to add the temperature)
saveRDS(data_for_imp, "RData/General_data/pre_data_for_imputation.rds")
```

## *Get species coordinates*

```{r}
IUCN_polygons <- readRDS(file="RData/General_data/raster_IUCN_polygons.rds") # Save processed IUCN polygons

polygon<-subset(IUCN_polygons, IUCN_polygons@data$binomial %in% data_for_imp$tip.label)

# Rasterize at a 1-degree resolution
raster_polygon<-lets.presab(polygon, resol=1) 
presence_absence<-data.frame(raster_polygon$Presence_and_Absence_Matrix)

# Pivot longer
presence_absence<-pivot_longer(presence_absence, cols=Acanthixalus.sonjae:Zachaenus.parvulus, names_to = "tip.label", values_to = "Presence") 
presence<-filter(presence_absence, Presence=="1") # Only keep rows where species are present

saveRDS(presence, file="RData/General_data/species_coordinates.rds")

distinct_coord<- distinct(dplyr::select(presence, -Presence, - tip.label)) # Coordinates where species are present (14119 grid cells)
distinct_coord<-distinct_coord %>% rename(x=Longitude.x., y=Latitude.y.)

saveRDS(distinct_coord, file="RData/General_data/distinct_coordinates.rds")
```



