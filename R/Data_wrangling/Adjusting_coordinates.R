
pacman::p_load(tidyverse,
               raster, 
               rgdal,
               rgeos,
               purrr,
               raster,
               parallel,
               doParallel,
               abind,
               curl,
               zoo,
               sf,
               data.table,
               RNetCDF, 
               NicheMapR, 
               microclima,
               letsR,
               R.utils,
               rlang,
               future,
               furrr,
               future.apply, 
               futile.logger,
               rnaturalearth,
               rnaturalearthdata,
               rnaturalearthhires)

################


# Create land polygon
world_sf <- ne_countries(scale = "large", returnclass = "sf")
world_sf$geometry <- st_make_valid(world_sf$geometry)
land_polygon <- st_union(world_sf)

# Function to check if coordinate is on land
check_if_point_on_land <- function(lon, lat) {
  point <- st_point(c(lon, lat))
  point_sf <- st_sf(geometry = st_sfc(point), crs = 4326)  # specify the CRS when you create the st_point
  st_transform(point_sf, st_crs(land_polygon))  # transform the point to match the CRS of the land_polygon
  st_intersects(land_polygon, point_sf, sparse = FALSE)[1, 1]
}


adjust_coordinates_to_land <- function(lon, lat) {
  if(check_if_point_on_land(lon, lat)) {
    return(c(lon, lat))
  }
  
  steps <- seq(-0.45, 0.45, by = 0.05)
  
  # Iterate over both longitude and latitude in the full range of steps
  for(dx in steps) {
    for(dy in steps) {
      if(check_if_point_on_land(lon + dx, lat + dy)) {
        return(c(lon + dx, lat + dy))
      }
    }
  }
  
  return(NULL)  # return NULL if no land found
}

distinct_coord <- readRDS(file="RData/General_data/distinct_coordinates.rds")

distinct_coord_adj <- as.data.frame(distinct_coord %>% rename(lon=x, lat=y))

# Iterate through each row in the dataframe
for(i in 1:nrow(distinct_coord_adj)) {
  print(paste("Processing lon: ", distinct_coord_adj$lon[i], ", lat: ", distinct_coord_adj$lat[i]))
  adjusted_coords <- adjust_coordinates_to_land(distinct_coord_adj$lon[i], distinct_coord_adj$lat[i])
  if (!is.null(adjusted_coords)) {
    print(paste("Adjusted lon: ", adjusted_coords[1], ", lat: ", adjusted_coords[2]))
    distinct_coord_adj$lon[i] <- adjusted_coords[1]
    distinct_coord_adj$lat[i] <- adjusted_coords[2]
  } else {
    print(paste("No suitable land coordinates found for lon: ", distinct_coord_adj$lon[i], ", lat: ", distinct_coord_adj$lat[i]))
  }
}

saveRDS(distinct_coord_adj, file="RData/General_data/distinct_coordinates_adj.rds")

### 


# Adjusting coordinates

species_occurrence<- readRDS("RData/General_data/species_coordinates.rds")
species_occurrence<- rename(species_occurrence,lon=Longitude.x., lat=Latitude.y.)

n_species<- unique(species_occurrence$tip.label) # 5213 

distinct_coord_adj <- readRDS("RData/General_data/distinct_coordinates_adj.rds")

# Identify coordinates that did not intersect with land masses
failed_coords <- data.frame(
  lon = c(-124.5, 38.5, -123.5, 129.5, -107.5, -74.5, -68.5, -65.5, 122.5, 97.5, 
          120.5, 126.5, -14.5, -9.5, 107.5, -0.5, 0.5, -0.5, 0.5, 6.5, 150.5, -5.5, 
          50.5, 17.5, 25.5, 122.5, -64.5),
  lat = c(45.5, 41.5, 37.5, 27.5, 23.5, 19.5, 19.5, 17.5, 15.5, 13.5, 10.5, 10.5, 
          9.5, 4.5, 3.5, 0.5, 0.5, -0.5, -0.5, -0.5, -8.5, -16.5, -16.5, -33.5, -34.5, 
          -34.5, -41.5)
)


distinct_coord_adj <- distinct_coord_adj %>%
  mutate(id = paste(lon, lat))

failed_coords <- failed_coords %>%
  mutate(id = paste(lon, lat))

# Replace the coordinates 
distinct_coord_adj <- distinct_coord_adj %>%
  rowwise() %>%
  mutate(
    across(c(lon, lat), ~ if_else(id %in% failed_coords$id, NA_real_, .))
  ) %>%
  dplyr::select(-id)

# Get original distinct coordinates
distinct_coord <- readRDS("RData/General_data/distinct_coordinates.rds")

distinct_coord_adj<- cbind(distinct_coord, distinct_coord_adj)


distinct_coord_adj<- filter(distinct_coord_adj, is.na(lat)==FALSE)

saveRDS(distinct_coord_adj, file="RData/General_data/distinct_coordinates_adjusted.rds")

##
species_occurrence <- species_occurrence %>%
  mutate(id = paste(lon, lat))

species_occurrence  <- species_occurrence %>%
  rowwise() %>%
  mutate(
    across(c(lon, lat), ~ if_else(id %in% failed_coords$id, NA_real_, .))
  ) %>%
  dplyr::select(-id)

species_occurrence <- filter(species_occurrence, is.na(lat)==FALSE)

n_species<- unique(species_occurrence$tip.label) # 5203. All good.


### Updating species occurrence dataset

distinct_coord<- readRDS(file="RData/General_data/distinct_coordinates_adjusted.rds")

# Match body mass data to coordinates
presence <- readRDS(file="RData/General_data/species_coordinates.rds")
presence <- dplyr::rename(presence,lon=Longitude.x., lat=Latitude.y.)
presence$tip.label <- gsub("\\.", " ", presence$tip.label)

presence_adjusted <- presence %>%
  dplyr::left_join(distinct_coord, by = c("lon" = "x", "lat" = "y"))

presence <- dplyr::rename(presence_adjusted, 
                          original_lon = lon, 
                          original_lat = lat,
                          lon = lon.y,
                          lat = lat.y)

presence <- dplyr::filter(presence, is.na(lon)==FALSE)


saveRDS(presence, file="RData/General_data/species_coordinates_adjusted.rds")


##### Adjust coordinates that were not properly adjusted ############

distinct_coord <- readRDS("RData/General_data/distinct_coordinates_adjusted.rds")

distinct_coord <- distinct_coord %>%
  mutate(
    lon = case_when(
      lon == -17.95 & lat == 27.70 ~ -17.95,
      lon == 54.05 & lat == 26.50 ~ 54.05,
      lon == 107.50 & lat == 10.50 ~ 107.5,
      lon == "0.05" & lat == 5.65 ~ 0.05,
      lon == 134.05 & lat == -0.95 ~ 134.05,
      lon == 55.25 & lat == -4.50 ~ 55.23,
      lon == 133.50 & lat == -11.50 ~ 133.45,
      lon == -38.95 & lat == -14.10 ~ -38.97,
      lon == -5.75 & lat == -15.95 ~ -5.70,
      lon == 49.05 & lat == -19.15 ~ 49.02,
      lon == 30.05 & lat == -31.25 ~ 30.05,
      lon == 147.05 & lat == -38.50 ~ 147.05,
      lon == 174.5 & lat == -35.5 ~ 174.45,
      TRUE ~ lon
    ),
    lat = case_when(
      lon == -17.95 & lat == 27.70 ~ 27.75,
      lon == 54.05 & lat == 26.50 ~ 26.8,
      lon == 107.50 & lat == 10.50 ~ 10.55,
      lon == "0.05" & lat == 5.65 ~ 5.70,
      lon == 134.05 & lat == -0.95 ~ -0.85,
      lon == 55.25 & lat == -4.50 ~ -4.5,
      lon == 133.50 & lat == -11.50 ~ -11.5,
      lon == -38.95 & lat == -14.10 ~ -14.1,
      lon == -5.75 & lat == -15.95 ~ -15.95,
      lon == 49.05 & lat == -19.15 ~ -19.15,
      lon == 30.05 & lat == -31.25 ~ -31.20,
      lon == 147.05 & lat == -38.50 ~ -38.45,
      lon == 174.5 & lat == -35.5 ~ -35.5,
      TRUE ~ lat
    )
  )
saveRDS(distinct_coord, file="RData/General_data/distinct_coordinates_adjusted.rds")

### Same for species coordinates

species_coordinates <- readRDS("RData/General_data/species_coordinates_adjusted.rds")

species_coordinates <- species_coordinates %>% 
  mutate(
    lon = case_when(
      lon == -17.95 & lat == 27.70 ~ -17.95,
      lon == 54.05 & lat == 26.50 ~ 54.05,
      lon == 107.50 & lat == 10.50 ~ 107.5,
      lon == "0.05" & lat == 5.65 ~ 0.05,
      lon == 134.05 & lat == -0.95 ~ 134.05,
      lon == 55.25 & lat == -4.50 ~ 55.23,
      lon == 133.50 & lat == -11.50 ~ 133.45,
      lon == -38.95 & lat == -14.10 ~ -38.97,
      lon == -5.75 & lat == -15.95 ~ -5.70,
      lon == 49.05 & lat == -19.15 ~ 49.02,
      lon == 30.05 & lat == -31.25 ~ 30.05,
      lon == 147.05 & lat == -38.50 ~ 147.05,
      lon == 174.5 & lat == -35.5 ~ 174.45,
      TRUE ~ lon
    ),
    lat = case_when(
      lon == -17.95 & lat == 27.70 ~ 27.75,
      lon == 54.05 & lat == 26.50 ~ 26.8,
      lon == 107.50 & lat == 10.50 ~ 10.55,
      lon == "0.05" & lat == 5.65 ~ 5.70,
      lon == 134.05 & lat == -0.95 ~ -0.85,
      lon == 55.25 & lat == -4.50 ~ -4.5,
      lon == 133.50 & lat == -11.50 ~ -11.5,
      lon == -38.95 & lat == -14.10 ~ -14.1,
      lon == -5.75 & lat == -15.95 ~ -15.95,
      lon == 49.05 & lat == -19.15 ~ -19.15,
      lon == 30.05 & lat == -31.25 ~ -31.20,
      lon == 147.05 & lat == -38.50 ~ -38.45,
      lon == 174.5 & lat == -35.5 ~ -35.5,
      TRUE ~ lat
    )
  )

saveRDS(species_coordinates, file="RData/General_data/species_coordinates_adjusted.rds")

