
pacman::p_load(tidyverse,
               phytools,
               here,
               MCMCglmm,
               ape,
               naniar)


## -------------------------------------------------------------------------------------------------------------------------------------------
# Load functions for the Bayesian Augmentation with Chain Equations (BACE)
source("R/Functions_BACE.R")

# Load data and tree
tree<- readRDS("RData/General_data/tree_for_imputation.rds")

# Load data
data_for_imp<- readRDS("RData/Imputation/data/Data_crossV_5th_set.rds")



# Transform variables

data_for_imp <- data_for_imp %>% 
  mutate(
    acclimated = factor(acclimated),
    life_stage_tested = factor(life_stage_tested),
    ln_acclimation_time = log(acclimation_time),
    ln_sd_UTL = log(sd_UTL),
    ln_body_mass = log(body_mass),
    medium_test_temp2 = factor(medium_test_temp),
    life_stage_tested=factor(life_stage_tested,
                             levels=c("adult", "adults", "larvae"),
                             labels=c("adults", "adults", "larvae")), # Correct typo
    endpoint2 = factor(endpoint, 
                       levels=c("LRR", "OS", "LOE", "prodding", "other", "death"),
                       labels=c("LRR", "OS", "LRR", "other", "other", "other")) # Take LOE as LRR 
  )

data_for_imp<- dplyr::select(data_for_imp, -family) # Remove family to run MCMCglmm

length(unique(data_for_imp$species))

# Make sure everything matches

matchpos <- match(data_for_imp$tip.label, tree$tip.label)

data_for_imp$matchpos <- matchpos

dat <- data_for_imp %>% filter(is.na(matchpos) == F) 

tree_imputation <- drop.tip(tree, tree$tip.label[-match(dat$tip.label, tree$tip.label)]) # Pruned tree that only contains species in the data 

tree_imputation<-force.ultrametric(tree_imputation, method="extend") # Force the tree to be ultrametric

# Phylogenetic co-variance matrix
Ainv<-inverseA(tree_imputation)$Ainv

# Standardize variables
#######################

# acclimation_temp
dat$acclimation_temp_stand<- stand(dat$acclimation_temp)[,1]

# mean_UTL
mean_UTL_mpos <- is.na(dat$mean_UTL) 
dat$mean_UTL_stand1 <- stand(dat$mean_UTL)[,1]
dat$mean_UTL_stand1[mean_UTL_mpos] <- 0


# acclimation_time
acclimation_time_mpos <- is.na(dat$ln_acclimation_time)
dat$ln_acclimation_time_stand1 <- stand(dat$ln_acclimation_time)[,1]
dat$ln_acclimation_time_stand1[acclimation_time_mpos] <- 0

# ramping
ramping_mpos <- is.na(dat$ramping) 
dat$ramping_stand1 <- stand(dat$ramping)[,1]
dat$ramping_stand1[ramping_mpos] <- 0

# medium_test_temp2 
medium_test_temp2_mpos <- is.na(dat$medium_test_temp2)
dat$medium_test_temp2_fill1 <- sample_imp(dat$medium_test_temp2)[[1]]

# sd_UTL 
sd_UTL_mpos <- is.na(dat$ln_sd_UTL)
dat$ln_sd_UTL_stand1 <- stand(dat$ln_sd_UTL)[,1]
dat$ln_sd_UTL_stand1[sd_UTL_mpos] <- 0

# body_mass
body_mass_mpos <- is.na(dat$ln_body_mass)
dat$ln_body_mass_stand1 <- stand(dat$ln_body_mass)[,1]
dat$ln_body_mass_stand1[body_mass_mpos] <- 0

## -------------------------------------------------------------------------------------------------------------------------------------------

# cycle 1
system.time(dat1_crossV <- b_mice(cycle = 1, data = dat, Ainv = Ainv))

saveRDS(dat1_crossV, file = "RData/Imputation/results/5th_cross_validation_1st_cycle.Rds")

#########

# cycle 2
system.time(dat2_crossV <- b_mice(cycle = 2, data = dat1_crossV, Ainv = Ainv))

saveRDS(dat2_crossV, file = "RData/Imputation/results/5th_cross_validation_2nd_cycle.Rds")

########

# cycle 3
system.time(dat3_crossV<- b_mice(cycle = 3, data = dat2_crossV, Ainv = Ainv))

saveRDS(dat3_crossV, file = "RData/Imputation/results/5th_cross_validation_3rd_cycle.Rds")

########

# cycle 4
system.time(dat4_crossV<- b_mice(cycle = 4, data = dat3_crossV, Ainv = Ainv))

saveRDS(dat4_crossV, file = "RData/Imputation/results/5th_cross_validation_4th_cycle.Rds")

########

# cycle 5
system.time(dat5_crossV<- b_mice(cycle = 5, data = dat4_crossV, Ainv = Ainv))

saveRDS(dat5_crossV, file = "RData/Imputation/results/5th_cross_validation_5th_cycle.Rds")