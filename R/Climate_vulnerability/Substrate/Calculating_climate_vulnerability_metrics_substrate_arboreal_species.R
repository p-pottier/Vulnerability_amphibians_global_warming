
pacman::p_load(devtools,
               tidyverse,
               purrr,
               parallel,
               doParallel,
               abind,
               curl,
               zoo,
               data.table,
               metafor,
               future,
               furrr,
               future.apply,
               parallel)

##############################################################################################################
############### Acclimation to mean weekly temperature on substrate, current climate ######################

pop_vulnerability_mean_current <- readRDS("RData/Climate_vulnerability/Substrate/current/population_vulnerability_substrate_mean_acc_current.rds")
pop_vulnerability_mean_current_arb <- readRDS("RData/Climate_vulnerability/Arboreal/current/population_vulnerability_arboreal_mean_acc_current.rds")

# Filter to arboreal species
pop_vulnerability_mean_current <- pop_vulnerability_mean_current[pop_vulnerability_mean_current$tip.label %in% pop_vulnerability_mean_current_arb$tip.label,]

######## Community-level patterns ################

community_vulnerability_mean_current <- pop_vulnerability_mean_current %>%
  mutate(TSM_weights = 1/(TSM_se^2),
         CTmax_weights = 1/(CTmax_se^2)) %>%
  group_by(lon, lat) %>%
  summarise(# ifelse statement is used here because in some locations, only one species is present.
    # Mean CTmax and maximum temperature at the community-level (weighted average and SE)
    community_CTmax = if_else(n() == 1, first(CTmax), sum(CTmax * CTmax_weights)/sum(CTmax_weights)), 
    community_CTmax_se = if_else(n() == 1, first(CTmax_se), sqrt(sum(CTmax_weights) * (n() - 1) / (((sum(CTmax_weights)^2) - (sum(CTmax_weights^2)))))),
    community_max_temp = first(max_temp),  
    community_max_temp_se = first(max_temp_se), 
    # Mean TSM (weighted average and SE)
    community_TSM = if_else(n() == 1, first(TSM), sum(TSM * TSM_weights)/sum(TSM_weights)), 
    community_TSM_se = if_else(n() == 1, first(TSM_se), sqrt(sum(TSM_weights) * (n() - 1) / (((sum(TSM_weights)^2) - (sum(TSM_weights^2)))))),
    # Number of species
    n_species = n_distinct(tip.label), 
    # Number of species overheating
    n_species_overheating = sum(overheating_risk), 
    # Proportion of species overheating
    proportion_species_overheating = if_else(n() == 1, first(overheating_risk), mean(overheating_risk)), 
    proportion_species_overheating_se = if_else(n() == 1, 0, sd(overheating_risk)),
    # Conservative metrics for sensitivity analysis
    n_species_overheating_strict = sum(overheating_risk_strict), 
    proportion_species_overheating_strict = if_else(n() == 1, first(overheating_risk_strict), mean(overheating_risk_strict)), 
    proportion_species_overheating_se_strict = if_else(n() == 1, 0, sd(overheating_risk_strict)), 
    .groups = 'drop'
  )

rm(pop_vulnerability_mean_current)

saveRDS(community_vulnerability_mean_current, file="RData/Climate_vulnerability/Substrate/current/community_vulnerability_substrate_mean_acc_current_arboreal_sp.rds")

rm(community_vulnerability_mean_current)

###################################################################################################################
############### Acclimation to mean weekly temperature on substrate, future climate (+2C) ######################

pop_vulnerability_mean_2C <- readRDS("RData/Climate_vulnerability/Substrate/future2C/population_vulnerability_substrate_mean_acc_future2C.rds")
pop_vulnerability_mean_2C_arb <- readRDS("RData/Climate_vulnerability/Arboreal/future2C/population_vulnerability_arboreal_mean_acc_future2C.rds")

# Filter to arboreal species
pop_vulnerability_mean_2C <- pop_vulnerability_mean_2C[pop_vulnerability_mean_2C$tip.label %in% pop_vulnerability_mean_2C_arb$tip.label,]

######## Community-level patterns ################

community_vulnerability_mean_2C <- pop_vulnerability_mean_2C %>%
  mutate(TSM_weights = 1/(TSM_se^2),
         CTmax_weights = 1/(CTmax_se^2)) %>%
  group_by(lon, lat) %>%
  summarise(# ifelse statement is used here because in some locations, only one species is present.
    # Mean CTmax and maximum temperature at the community-level (weighted average and SE)
    community_CTmax = if_else(n() == 1, first(CTmax), sum(CTmax * CTmax_weights)/sum(CTmax_weights)), 
    community_CTmax_se = if_else(n() == 1, first(CTmax_se), sqrt(sum(CTmax_weights) * (n() - 1) / (((sum(CTmax_weights)^2) - (sum(CTmax_weights^2)))))),
    community_max_temp = first(max_temp),  
    community_max_temp_se = first(max_temp_se), 
    # Mean TSM (weighted average and SE)
    community_TSM = if_else(n() == 1, first(TSM), sum(TSM * TSM_weights)/sum(TSM_weights)), 
    community_TSM_se = if_else(n() == 1, first(TSM_se), sqrt(sum(TSM_weights) * (n() - 1) / (((sum(TSM_weights)^2) - (sum(TSM_weights^2)))))),
    # Number of species
    n_species = n_distinct(tip.label), 
    # Number of species overheating
    n_species_overheating = sum(overheating_risk), 
    # Proportion of species overheating
    proportion_species_overheating = if_else(n() == 1, first(overheating_risk), mean(overheating_risk)), 
    proportion_species_overheating_se = if_else(n() == 1, 0, sd(overheating_risk)),
    # Conservative metrics for sensitivity analysis
    n_species_overheating_strict = sum(overheating_risk_strict), 
    proportion_species_overheating_strict = if_else(n() == 1, first(overheating_risk_strict), mean(overheating_risk_strict)), 
    proportion_species_overheating_se_strict = if_else(n() == 1, 0, sd(overheating_risk_strict)), 
    .groups = 'drop'
  )

rm(pop_vulnerability_mean_2C)

saveRDS(community_vulnerability_mean_2C, file="RData/Climate_vulnerability/Substrate/future2C/community_vulnerability_substrate_mean_acc_future2C_arboreal_sp.rds")

rm(community_vulnerability_mean_2C)

###################################################################################################################
############### Acclimation to mean weekly temperature on substrate, future climate (+4C) ######################

pop_vulnerability_mean_4C <- readRDS("RData/Climate_vulnerability/Substrate/future4C/population_vulnerability_substrate_mean_acc_future4C.rds")
pop_vulnerability_mean_4C_arb <- readRDS("RData/Climate_vulnerability/Arboreal/future4C/population_vulnerability_arboreal_mean_acc_future4C.rds")

# Filter to arboreal species
pop_vulnerability_mean_4C <- pop_vulnerability_mean_4C[pop_vulnerability_mean_4C$tip.label %in% pop_vulnerability_mean_4C_arb$tip.label,]

######## Community-level patterns ################

community_vulnerability_mean_4C <- pop_vulnerability_mean_4C %>%
  mutate(TSM_weights = 1/(TSM_se^2),
         CTmax_weights = 1/(CTmax_se^2)) %>%
  group_by(lon, lat) %>%
  summarise(# ifelse statement is used here because in some locations, only one species is present.
    # Mean CTmax and maximum temperature at the community-level (weighted average and SE)
    community_CTmax = if_else(n() == 1, first(CTmax), sum(CTmax * CTmax_weights)/sum(CTmax_weights)), 
    community_CTmax_se = if_else(n() == 1, first(CTmax_se), sqrt(sum(CTmax_weights) * (n() - 1) / (((sum(CTmax_weights)^2) - (sum(CTmax_weights^2)))))),
    community_max_temp = first(max_temp),  
    community_max_temp_se = first(max_temp_se), 
    # Mean TSM (weighted average and SE)
    community_TSM = if_else(n() == 1, first(TSM), sum(TSM * TSM_weights)/sum(TSM_weights)), 
    community_TSM_se = if_else(n() == 1, first(TSM_se), sqrt(sum(TSM_weights) * (n() - 1) / (((sum(TSM_weights)^2) - (sum(TSM_weights^2)))))),
    # Number of species
    n_species = n_distinct(tip.label), 
    # Number of species overheating
    n_species_overheating = sum(overheating_risk), 
    # Proportion of species overheating
    proportion_species_overheating = if_else(n() == 1, first(overheating_risk), mean(overheating_risk)), 
    proportion_species_overheating_se = if_else(n() == 1, 0, sd(overheating_risk)),
    # Conservative metrics for sensitivity analysis
    n_species_overheating_strict = sum(overheating_risk_strict), 
    proportion_species_overheating_strict = if_else(n() == 1, first(overheating_risk_strict), mean(overheating_risk_strict)), 
    proportion_species_overheating_se_strict = if_else(n() == 1, 0, sd(overheating_risk_strict)), 
    .groups = 'drop'
  )

rm(pop_vulnerability_mean_4C)

saveRDS(community_vulnerability_mean_4C, file="RData/Climate_vulnerability/Substrate/future4C/community_vulnerability_substrate_mean_acc_future4C_arboreal_sp.rds")
