
pacman::p_load(devtools,
               tidyverse,
               purrr,
               parallel,
               doParallel,
               abind,
               curl,
               zoo,
               data.table,
               metafor,
               future,
               furrr,
               future.apply,
               parallel)



##############################################################################################################
############### Acclimation to mean weekly temperature on substrate, current climate ######################

daily_CTmax_mean_current <- readRDS(file="RData/Climate_vulnerability/Substrate/current/daily_CTmax_substrate_mean_acc_current.rds")

###### Daily TSM and overheating risk ##########

daily_vulnerability_mean_current <- daily_CTmax_mean_current %>% 
  mutate(daily_TSM = predicted_CTmax - max_temp,
         daily_TSM_se = predicted_CTmax_se,
         overheating_day = as.integer((predicted_CTmax - max_temp) < 0),
         upper_95CI_CTmax = predicted_CTmax + 1.96 * predicted_CTmax_se, # 95% CI
         upper_50CI_CTmax = predicted_CTmax + 0.6745 * predicted_CTmax_se) %>% # 50% CI
  # Here, overheating is considered when the upper bound of the confidence interval of CTmax is below max_temp
  mutate(overheating_day_strict95 = as.integer((upper_95CI_CTmax - max_temp) < 0),
         overheating_day_strict50 = as.integer((upper_50CI_CTmax - max_temp) < 0)) 

# Number of consecutive days of overheating
daily_consecutive_mean_current <- daily_CTmax_mean_current %>%  
  mutate(overheating_day = as.integer((predicted_CTmax - max_temp) < 0),
         upper_95CI_CTmax = predicted_CTmax + 1.96 * predicted_CTmax_se, 
         upper_50CI_CTmax = predicted_CTmax + 0.6745 * predicted_CTmax_se) %>% 
  mutate(overheating_day_strict95 = as.integer((upper_95CI_CTmax - max_temp) < 0),
         overheating_day_strict50 = as.integer((upper_50CI_CTmax - max_temp) < 0)) %>% 
  # Arrange by day and year
  group_by(tip.label, lon, lat, YEAR) %>%
  arrange(DOY) %>%
  # Calculate consecutive days of overheating
  mutate(consecutive_overheating_day = {
    rle_run <- rle(overheating_day)
    rep(rle_run$lengths * rle_run$values, times = rle_run$lengths)
  })


rm(daily_CTmax_mean_current)

########## Climate vulnerability metrics at the population-level  ###########

pop_vulnerability_mean_current <- daily_vulnerability_mean_current %>%
  mutate(TSM_weights = 1/(daily_TSM_se^2),
         CTmax_weights = 1/(predicted_CTmax_se^2)) %>% 
  group_by(tip.label, lon, lat) %>%
  summarise(
    # Mean CTmax and maximum temperature (weighted average and SE)
    CTmax = sum(predicted_CTmax * CTmax_weights)/sum(CTmax_weights), 
    CTmax_se = sqrt(sum(CTmax_weights) * (n() - 1) / (((sum(CTmax_weights)^2) - (sum(CTmax_weights^2))))),
    mean_max_temp = mean(max_temp),
    max_temp_se = sd(max_temp),
    # Mean TSM (weighted average and SE)
    TSM = sum(daily_TSM * TSM_weights)/sum(TSM_weights), 
    TSM_se = sqrt(sum(TSM_weights) * (n() - 1) / (((sum(TSM_weights)^2) - (sum(TSM_weights^2))))),
    # Number of overheating days and overheating risk
    overheating_days = sum(overheating_day),
    overheating_risk = as.integer(sum(overheating_day) > 0),
    # Sensitivity analyses accounting for uncertainty in CTmax
    overheating_days_strict95 = sum(overheating_day_strict95),
    overheating_days_strict50 = sum(overheating_day_strict50),
    overheating_risk_strict95 = as.integer(sum(overheating_day_strict95) > 0),
    overheating_risk_strict50 = as.integer(sum(overheating_day_strict50) > 0),
    .groups = 'drop'
  )

pop_vulnerability_mean_current <- pop_vulnerability_mean_current %>% rename(max_temp = mean_max_temp)

rm(daily_vulnerability_mean_current)

## Calculate number of consecutive overheating days
consecutive_overheating_days_current <- daily_consecutive_mean_current %>% 
  group_by(tip.label, lon, lat) %>%
  summarise(consecutive_overheating_days = max(consecutive_overheating_day),
            .groups = 'drop')

rm(daily_consecutive_mean_current)

pop_vulnerability_mean_current <- pop_vulnerability_mean_current %>%
  left_join(consecutive_overheating_days_current, by = c("tip.label", "lon", "lat"))

rm(consecutive_overheating_days_current)

## Add original coordinates
pop_vulnerability_mean_current   <- pop_vulnerability_mean_current  %>% 
  rename(lon_adj = lon, lat_adj = lat) %>% 
  mutate(lon_lat = paste(lon_adj, lat_adj)) 

distinct_coord <- readRDS("RData/General_data/distinct_coordinates_adjusted.rds")
distinct_coord <- distinct_coord %>% 
  dplyr::select(lon_adj = lon, lat_adj = lat, lon = x, lat = y) %>% 
  mutate(lon_lat = paste(lon_adj, lat_adj)) %>% 
  dplyr::select(-lon_adj, -lat_adj)

pop_vulnerability_mean_current  <- left_join(pop_vulnerability_mean_current , distinct_coord, by="lon_lat")
pop_vulnerability_mean_current  <- pop_vulnerability_mean_current  %>% 
  dplyr::select(-lon_lat)

# Remove data from one coordinate because it is not in the TerraClimate database and can't be compared to future climate scenario
pop_vulnerability_mean_current <- subset(pop_vulnerability_mean_current, !(lon_adj == -5.7 & lat_adj == -15.95))

saveRDS(pop_vulnerability_mean_current, file="RData/Climate_vulnerability/Substrate/current/population_vulnerability_substrate_mean_acc_current.rds")

######## Community-level patterns ################

community_vulnerability_mean_current <- pop_vulnerability_mean_current %>%
  mutate(TSM_weights = 1/(TSM_se^2),
         CTmax_weights = 1/(CTmax_se^2)) %>%
  group_by(lon, lat) %>%
  summarise(# ifelse statement is used here because in some locations, only one species is present.
    # Mean CTmax and maximum temperature at the community-level (weighted average and SE)
    community_CTmax = if_else(n() == 1, first(CTmax), sum(CTmax * CTmax_weights)/sum(CTmax_weights)), 
    community_CTmax_se = if_else(n() == 1, first(CTmax_se), sqrt(sum(CTmax_weights) * (n() - 1) / (((sum(CTmax_weights)^2) - (sum(CTmax_weights^2)))))),
    community_max_temp = first(max_temp),  
    community_max_temp_se = first(max_temp_se), 
    # Mean TSM (weighted average and SE)
    community_TSM = if_else(n() == 1, first(TSM), sum(TSM * TSM_weights)/sum(TSM_weights)), 
    community_TSM_se = if_else(n() == 1, first(TSM_se), sqrt(sum(TSM_weights) * (n() - 1) / (((sum(TSM_weights)^2) - (sum(TSM_weights^2)))))),
    # Number of species
    n_species = n_distinct(tip.label), 
    # Number of species overheating
    n_species_overheating = sum(overheating_risk), 
    # Proportion of species overheating
    proportion_species_overheating = if_else(n() == 1, first(overheating_risk), mean(overheating_risk)), 
    proportion_species_overheating_se = if_else(n() == 1, 0, sd(overheating_risk)),
    # Sensitivity analyses accounting for uncertainty in CTmax
    n_species_overheating_strict95 = sum(overheating_risk_strict95), 
    n_species_overheating_strict50 = sum(overheating_risk_strict50),
    proportion_species_overheating_strict95 = if_else(n() == 1, first(overheating_risk_strict95), mean(overheating_risk_strict95)),
    proportion_species_overheating_se_strict95 = if_else(n() == 1, 0, sd(overheating_risk_strict95)),
    proportion_species_overheating_strict50 = if_else(n() == 1, first(overheating_risk_strict50), mean(overheating_risk_strict50)),
    proportion_species_overheating_se_strict50 = if_else(n() == 1, 0, sd(overheating_risk_strict50)),
    .groups = 'drop'
  )

rm(pop_vulnerability_mean_current)

saveRDS(community_vulnerability_mean_current, file="RData/Climate_vulnerability/Substrate/current/community_vulnerability_substrate_mean_acc_current.rds")

rm(community_vulnerability_mean_current)


###################################################################################################################
############### Acclimation to mean weekly temperature on substrate, future climate (+2C) ######################


daily_CTmax_mean_2C <- readRDS(file="RData/Climate_vulnerability/Substrate/future2C/daily_CTmax_substrate_mean_acc_future2C.rds")

###### Daily TSM and overheating risk ##########

daily_vulnerability_mean_2C <- daily_CTmax_mean_2C %>% 
  mutate(daily_TSM = predicted_CTmax - max_temp,
         daily_TSM_se = predicted_CTmax_se,
         overheating_day = as.integer((predicted_CTmax - max_temp) < 0),
         upper_95CI_CTmax = predicted_CTmax + 1.96 * predicted_CTmax_se, # 95% CI
         upper_50CI_CTmax = predicted_CTmax + 0.6745 * predicted_CTmax_se) %>% # 50% CI
  # Here, overheating is considered when the upper bound of the confidence interval of CTmax is below max_temp
  mutate(overheating_day_strict95 = as.integer((upper_95CI_CTmax - max_temp) < 0),
         overheating_day_strict50 = as.integer((upper_50CI_CTmax - max_temp) < 0)) 

# Number of consecutive days of overheating
daily_consecutive_mean_2C <- daily_CTmax_mean_2C %>%  
  mutate(overheating_day = as.integer((predicted_CTmax - max_temp) < 0),
         upper_95CI_CTmax = predicted_CTmax + 1.96 * predicted_CTmax_se, 
         upper_50CI_CTmax = predicted_CTmax + 0.6745 * predicted_CTmax_se) %>% 
  mutate(overheating_day_strict95 = as.integer((upper_95CI_CTmax - max_temp) < 0),
         overheating_day_strict50 = as.integer((upper_50CI_CTmax - max_temp) < 0)) %>% 
  # Arrange by day and year
  group_by(tip.label, lon, lat, YEAR) %>%
  arrange(DOY) %>%
  # Calculate consecutive days of overheating
  mutate(consecutive_overheating_day = {
    rle_run <- rle(overheating_day)
    rep(rle_run$lengths * rle_run$values, times = rle_run$lengths)
  })


rm(daily_CTmax_mean_2C)

########## Climate vulnerability metrics at the population-level  ###########

pop_vulnerability_mean_2C <- daily_vulnerability_mean_2C %>%
  mutate(TSM_weights = 1/(daily_TSM_se^2),
         CTmax_weights = 1/(predicted_CTmax_se^2)) %>% 
  group_by(tip.label, lon, lat) %>%
  summarise(
    # Mean CTmax and maximum temperature (weighted average and SE)
    CTmax = sum(predicted_CTmax * CTmax_weights)/sum(CTmax_weights), 
    CTmax_se = sqrt(sum(CTmax_weights) * (n() - 1) / (((sum(CTmax_weights)^2) - (sum(CTmax_weights^2))))),
    mean_max_temp = mean(max_temp),
    max_temp_se = sd(max_temp),
    # Mean TSM (weighted average and SE)
    TSM = sum(daily_TSM * TSM_weights)/sum(TSM_weights), 
    TSM_se = sqrt(sum(TSM_weights) * (n() - 1) / (((sum(TSM_weights)^2) - (sum(TSM_weights^2))))),
    # Number of overheating days and overheating risk
    overheating_days = sum(overheating_day),
    overheating_risk = as.integer(sum(overheating_day) > 0),
    # Sensitivity analyses accounting for uncertainty in CTmax
    overheating_days_strict95 = sum(overheating_day_strict95),
    overheating_days_strict50 = sum(overheating_day_strict50),
    overheating_risk_strict95 = as.integer(sum(overheating_day_strict95) > 0),
    overheating_risk_strict50 = as.integer(sum(overheating_day_strict50) > 0),
    .groups = 'drop'
  )

pop_vulnerability_mean_2C <- pop_vulnerability_mean_2C %>% rename(max_temp = mean_max_temp)

rm(daily_vulnerability_mean_2C)

## Calculate number of consecutive overheating days
consecutive_overheating_days_2C <- daily_consecutive_mean_2C %>% 
  group_by(tip.label, lon, lat) %>%
  summarise(consecutive_overheating_days = max(consecutive_overheating_day),
            .groups = 'drop')

rm(daily_consecutive_mean_2C)

pop_vulnerability_mean_2C <- pop_vulnerability_mean_2C %>%
  left_join(consecutive_overheating_days_2C, by = c("tip.label", "lon", "lat"))

rm(consecutive_overheating_days_2C)

## Add original coordinates
pop_vulnerability_mean_2C   <- pop_vulnerability_mean_2C  %>% 
  rename(lon_adj = lon, lat_adj = lat) %>% 
  mutate(lon_lat = paste(lon_adj, lat_adj)) 

distinct_coord <- readRDS("RData/General_data/distinct_coordinates_adjusted.rds")
distinct_coord <- distinct_coord %>% 
  dplyr::select(lon_adj = lon, lat_adj = lat, lon = x, lat = y) %>% 
  mutate(lon_lat = paste(lon_adj, lat_adj)) %>% 
  dplyr::select(-lon_adj, -lat_adj)

pop_vulnerability_mean_2C  <- left_join(pop_vulnerability_mean_2C , distinct_coord, by="lon_lat")
pop_vulnerability_mean_2C  <- pop_vulnerability_mean_2C  %>% 
  dplyr::select(-lon_lat)

# Remove data from one coordinate because it is not in the TerraClimate database and can't be compared to future climate scenario
pop_vulnerability_mean_2C <- subset(pop_vulnerability_mean_2C, !(lon_adj == -5.7 & lat_adj == -15.95))

saveRDS(pop_vulnerability_mean_2C, file="RData/Climate_vulnerability/Substrate/future2C/population_vulnerability_substrate_mean_acc_future2C.rds")

######## Community-level patterns ################

community_vulnerability_mean_2C <- pop_vulnerability_mean_2C %>%
  mutate(TSM_weights = 1/(TSM_se^2),
         CTmax_weights = 1/(CTmax_se^2)) %>%
  group_by(lon, lat) %>%
  summarise(# ifelse statement is used here because in some locations, only one species is present.
    # Mean CTmax and maximum temperature at the community-level (weighted average and SE)
    community_CTmax = if_else(n() == 1, first(CTmax), sum(CTmax * CTmax_weights)/sum(CTmax_weights)), 
    community_CTmax_se = if_else(n() == 1, first(CTmax_se), sqrt(sum(CTmax_weights) * (n() - 1) / (((sum(CTmax_weights)^2) - (sum(CTmax_weights^2)))))),
    community_max_temp = first(max_temp),  
    community_max_temp_se = first(max_temp_se), 
    # Mean TSM (weighted average and SE)
    community_TSM = if_else(n() == 1, first(TSM), sum(TSM * TSM_weights)/sum(TSM_weights)), 
    community_TSM_se = if_else(n() == 1, first(TSM_se), sqrt(sum(TSM_weights) * (n() - 1) / (((sum(TSM_weights)^2) - (sum(TSM_weights^2)))))),
    # Number of species
    n_species = n_distinct(tip.label), 
    # Number of species overheating
    n_species_overheating = sum(overheating_risk), 
    # Proportion of species overheating
    proportion_species_overheating = if_else(n() == 1, first(overheating_risk), mean(overheating_risk)), 
    proportion_species_overheating_se = if_else(n() == 1, 0, sd(overheating_risk)),
    # Sensitivity analyses accounting for uncertainty in CTmax
    n_species_overheating_strict95 = sum(overheating_risk_strict95), 
    n_species_overheating_strict50 = sum(overheating_risk_strict50),
    proportion_species_overheating_strict95 = if_else(n() == 1, first(overheating_risk_strict95), mean(overheating_risk_strict95)),
    proportion_species_overheating_se_strict95 = if_else(n() == 1, 0, sd(overheating_risk_strict95)),
    proportion_species_overheating_strict50 = if_else(n() == 1, first(overheating_risk_strict50), mean(overheating_risk_strict50)),
    proportion_species_overheating_se_strict50 = if_else(n() == 1, 0, sd(overheating_risk_strict50)),
    .groups = 'drop'
  )

rm(pop_vulnerability_mean_2C)

saveRDS(community_vulnerability_mean_2C, file="RData/Climate_vulnerability/Substrate/future2C/community_vulnerability_substrate_mean_acc_future2C.rds")

rm(community_vulnerability_mean_2C)


###################################################################################################################
############### Acclimation to mean weekly temperature on substrate, future climate (+4C) ######################


daily_CTmax_mean_4C <- readRDS(file="RData/Climate_vulnerability/Substrate/future4C/daily_CTmax_substrate_mean_acc_future4C.rds")

###### Daily TSM and overheating risk ##########

daily_vulnerability_mean_4C <- daily_CTmax_mean_4C %>% 
  mutate(daily_TSM = predicted_CTmax - max_temp,
         daily_TSM_se = predicted_CTmax_se,
         overheating_day = as.integer((predicted_CTmax - max_temp) < 0),
         upper_95CI_CTmax = predicted_CTmax + 1.96 * predicted_CTmax_se, # 95% CI
         upper_50CI_CTmax = predicted_CTmax + 0.6745 * predicted_CTmax_se) %>% # 50% CI
  # Here, overheating is considered when the upper bound of the confidence interval of CTmax is below max_temp
  mutate(overheating_day_strict95 = as.integer((upper_95CI_CTmax - max_temp) < 0),
         overheating_day_strict50 = as.integer((upper_50CI_CTmax - max_temp) < 0)) 

# Number of consecutive days of overheating
daily_consecutive_mean_4C <- daily_CTmax_mean_4C %>%  
  mutate(overheating_day = as.integer((predicted_CTmax - max_temp) < 0),
         upper_95CI_CTmax = predicted_CTmax + 1.96 * predicted_CTmax_se, 
         upper_50CI_CTmax = predicted_CTmax + 0.6745 * predicted_CTmax_se) %>% 
  mutate(overheating_day_strict95 = as.integer((upper_95CI_CTmax - max_temp) < 0),
         overheating_day_strict50 = as.integer((upper_50CI_CTmax - max_temp) < 0)) %>% 
  # Arrange by day and year
  group_by(tip.label, lon, lat, YEAR) %>%
  arrange(DOY) %>%
  # Calculate consecutive days of overheating
  mutate(consecutive_overheating_day = {
    rle_run <- rle(overheating_day)
    rep(rle_run$lengths * rle_run$values, times = rle_run$lengths)
  })


rm(daily_CTmax_mean_4C)

########## Climate vulnerability metrics at the population-level  ###########

pop_vulnerability_mean_4C <- daily_vulnerability_mean_4C %>%
  mutate(TSM_weights = 1/(daily_TSM_se^2),
         CTmax_weights = 1/(predicted_CTmax_se^2)) %>% 
  group_by(tip.label, lon, lat) %>%
  summarise(
    # Mean CTmax and maximum temperature (weighted average and SE)
    CTmax = sum(predicted_CTmax * CTmax_weights)/sum(CTmax_weights), 
    CTmax_se = sqrt(sum(CTmax_weights) * (n() - 1) / (((sum(CTmax_weights)^2) - (sum(CTmax_weights^2))))),
    mean_max_temp = mean(max_temp),
    max_temp_se = sd(max_temp),
    # Mean TSM (weighted average and SE)
    TSM = sum(daily_TSM * TSM_weights)/sum(TSM_weights), 
    TSM_se = sqrt(sum(TSM_weights) * (n() - 1) / (((sum(TSM_weights)^2) - (sum(TSM_weights^2))))),
    # Number of overheating days and overheating risk
    overheating_days = sum(overheating_day),
    overheating_risk = as.integer(sum(overheating_day) > 0),
    # Sensitivity analyses accounting for uncertainty in CTmax
    overheating_days_strict95 = sum(overheating_day_strict95),
    overheating_days_strict50 = sum(overheating_day_strict50),
    overheating_risk_strict95 = as.integer(sum(overheating_day_strict95) > 0),
    overheating_risk_strict50 = as.integer(sum(overheating_day_strict50) > 0),
    .groups = 'drop'
  )

pop_vulnerability_mean_4C <- pop_vulnerability_mean_4C %>% rename(max_temp = mean_max_temp)

rm(daily_vulnerability_mean_4C)

## Calculate number of consecutive overheating days
consecutive_overheating_days_4C <- daily_consecutive_mean_4C %>% 
  group_by(tip.label, lon, lat) %>%
  summarise(consecutive_overheating_days = max(consecutive_overheating_day),
            .groups = 'drop')

rm(daily_consecutive_mean_4C)

pop_vulnerability_mean_4C <- pop_vulnerability_mean_4C %>%
  left_join(consecutive_overheating_days_4C, by = c("tip.label", "lon", "lat"))

rm(consecutive_overheating_days_4C)

## Add original coordinates
pop_vulnerability_mean_4C   <- pop_vulnerability_mean_4C  %>% 
  rename(lon_adj = lon, lat_adj = lat) %>% 
  mutate(lon_lat = paste(lon_adj, lat_adj)) 

distinct_coord <- readRDS("RData/General_data/distinct_coordinates_adjusted.rds")
distinct_coord <- distinct_coord %>% 
  dplyr::select(lon_adj = lon, lat_adj = lat, lon = x, lat = y) %>% 
  mutate(lon_lat = paste(lon_adj, lat_adj)) %>% 
  dplyr::select(-lon_adj, -lat_adj)

pop_vulnerability_mean_4C  <- left_join(pop_vulnerability_mean_4C , distinct_coord, by="lon_lat")
pop_vulnerability_mean_4C  <- pop_vulnerability_mean_4C  %>% 
  dplyr::select(-lon_lat)

# Remove data from one coordinate because it is not in the TerraClimate database and can't be compared to future climate scenario
pop_vulnerability_mean_4C <- subset(pop_vulnerability_mean_4C, !(lon_adj == -5.7 & lat_adj == -15.95))

saveRDS(pop_vulnerability_mean_4C, file="RData/Climate_vulnerability/Substrate/future4C/population_vulnerability_substrate_mean_acc_future4C.rds")

######## Community-level patterns ################

community_vulnerability_mean_4C <- pop_vulnerability_mean_4C %>%
  mutate(TSM_weights = 1/(TSM_se^2),
         CTmax_weights = 1/(CTmax_se^2)) %>%
  group_by(lon, lat) %>%
  summarise(# ifelse statement is used here because in some locations, only one species is present.
    # Mean CTmax and maximum temperature at the community-level (weighted average and SE)
    community_CTmax = if_else(n() == 1, first(CTmax), sum(CTmax * CTmax_weights)/sum(CTmax_weights)), 
    community_CTmax_se = if_else(n() == 1, first(CTmax_se), sqrt(sum(CTmax_weights) * (n() - 1) / (((sum(CTmax_weights)^2) - (sum(CTmax_weights^2)))))),
    community_max_temp = first(max_temp),  
    community_max_temp_se = first(max_temp_se), 
    # Mean TSM (weighted average and SE)
    community_TSM = if_else(n() == 1, first(TSM), sum(TSM * TSM_weights)/sum(TSM_weights)), 
    community_TSM_se = if_else(n() == 1, first(TSM_se), sqrt(sum(TSM_weights) * (n() - 1) / (((sum(TSM_weights)^2) - (sum(TSM_weights^2)))))),
    # Number of species
    n_species = n_distinct(tip.label), 
    # Number of species overheating
    n_species_overheating = sum(overheating_risk), 
    # Proportion of species overheating
    proportion_species_overheating = if_else(n() == 1, first(overheating_risk), mean(overheating_risk)), 
    proportion_species_overheating_se = if_else(n() == 1, 0, sd(overheating_risk)),
    # Sensitivity analyses accounting for uncertainty in CTmax
    n_species_overheating_strict95 = sum(overheating_risk_strict95), 
    n_species_overheating_strict50 = sum(overheating_risk_strict50),
    proportion_species_overheating_strict95 = if_else(n() == 1, first(overheating_risk_strict95), mean(overheating_risk_strict95)),
    proportion_species_overheating_se_strict95 = if_else(n() == 1, 0, sd(overheating_risk_strict95)),
    proportion_species_overheating_strict50 = if_else(n() == 1, first(overheating_risk_strict50), mean(overheating_risk_strict50)),
    proportion_species_overheating_se_strict50 = if_else(n() == 1, 0, sd(overheating_risk_strict50)),
    .groups = 'drop'
  )

rm(pop_vulnerability_mean_4C)

saveRDS(community_vulnerability_mean_4C, file="RData/Climate_vulnerability/Substrate/future4C/community_vulnerability_substrate_mean_acc_future4C.rds")

rm(community_vulnerability_mean_4C)

##############################################################################################################
############### Acclimation to maximum weekly temperature on substrate, current climate ######################

daily_CTmax_max_current <- readRDS(file="RData/Climate_vulnerability/Substrate/current/daily_CTmax_substrate_max_acc_current.rds")

###### Daily TSM and overheating risk ##########

daily_vulnerability_max_current <- daily_CTmax_max_current %>% 
  mutate(daily_TSM = predicted_CTmax - max_temp,
         daily_TSM_se = predicted_CTmax_se,
         overheating_day = as.integer((predicted_CTmax - max_temp) < 0),
         upper_95CI_CTmax = predicted_CTmax + 1.96 * predicted_CTmax_se, # 95% CI
         upper_50CI_CTmax = predicted_CTmax + 0.6745 * predicted_CTmax_se) %>% # 50% CI
  # Here, overheating is considered when the upper bound of the confidence interval of CTmax is below max_temp
  mutate(overheating_day_strict95 = as.integer((upper_95CI_CTmax - max_temp) < 0),
         overheating_day_strict50 = as.integer((upper_50CI_CTmax - max_temp) < 0)) 

# Number of consecutive days of overheating
daily_consecutive_max_current <- daily_CTmax_max_current %>%  
  mutate(overheating_day = as.integer((predicted_CTmax - max_temp) < 0),
         upper_95CI_CTmax = predicted_CTmax + 1.96 * predicted_CTmax_se, 
         upper_50CI_CTmax = predicted_CTmax + 0.6745 * predicted_CTmax_se) %>% 
  mutate(overheating_day_strict95 = as.integer((upper_95CI_CTmax - max_temp) < 0),
         overheating_day_strict50 = as.integer((upper_50CI_CTmax - max_temp) < 0)) %>% 
  # Arrange by day and year
  group_by(tip.label, lon, lat, YEAR) %>%
  arrange(DOY) %>%
  # Calculate consecutive days of overheating
  mutate(consecutive_overheating_day = {
          rle_run <- rle(overheating_day)
          rep(rle_run$lengths * rle_run$values, times = rle_run$lengths)
  })
  

rm(daily_CTmax_max_current)

########## Climate vulnerability metrics at the population-level  ###########

pop_vulnerability_max_current <- daily_vulnerability_max_current %>%
  mutate(TSM_weights = 1/(daily_TSM_se^2),
         CTmax_weights = 1/(predicted_CTmax_se^2)) %>% 
  group_by(tip.label, lon, lat) %>%
  summarise(
    # Mean CTmax and maximum temperature (weighted average and SE)
    CTmax = sum(predicted_CTmax * CTmax_weights)/sum(CTmax_weights), 
    CTmax_se = sqrt(sum(CTmax_weights) * (n() - 1) / (((sum(CTmax_weights)^2) - (sum(CTmax_weights^2))))),
    mean_max_temp = mean(max_temp),
    max_temp_se = sd(max_temp),
    # Mean TSM (weighted average and SE)
    TSM = sum(daily_TSM * TSM_weights)/sum(TSM_weights), 
    TSM_se = sqrt(sum(TSM_weights) * (n() - 1) / (((sum(TSM_weights)^2) - (sum(TSM_weights^2))))),
    # Number of overheating days and overheating risk
    overheating_days = sum(overheating_day),
    overheating_risk = as.integer(sum(overheating_day) > 0),
    # Sensitivity analyses accounting for uncertainty in CTmax
    overheating_days_strict95 = sum(overheating_day_strict95),
    overheating_days_strict50 = sum(overheating_day_strict50),
    overheating_risk_strict95 = as.integer(sum(overheating_day_strict95) > 0),
    overheating_risk_strict50 = as.integer(sum(overheating_day_strict50) > 0),
    .groups = 'drop'
  )

pop_vulnerability_max_current <- pop_vulnerability_max_current %>% rename(max_temp = mean_max_temp)

rm(daily_vulnerability_max_current)

## Calculate number of consecutive overheating days
consecutive_overheating_days_current <- daily_consecutive_max_current %>% 
  group_by(tip.label, lon, lat) %>%
  summarise(consecutive_overheating_days = max(consecutive_overheating_day),
            .groups = 'drop')

rm(daily_consecutive_max_current)

pop_vulnerability_max_current <- pop_vulnerability_max_current %>%
  left_join(consecutive_overheating_days_current, by = c("tip.label", "lon", "lat"))

rm(consecutive_overheating_days_current)

## Add original coordinates
pop_vulnerability_max_current  <- pop_vulnerability_max_current %>% 
  rename(lon_adj = lon, lat_adj = lat) %>% 
  mutate(lon_lat = paste(lon_adj, lat_adj)) 

distinct_coord <- readRDS("RData/General_data/distinct_coordinates_adjusted.rds")
distinct_coord <- distinct_coord %>% 
  dplyr::select(lon_adj = lon, lat_adj = lat, lon = x, lat = y) %>% 
  mutate(lon_lat = paste(lon_adj, lat_adj)) %>% 
  dplyr::select(-lon_adj, -lat_adj)

pop_vulnerability_max_current <- left_join(pop_vulnerability_max_current, distinct_coord, by="lon_lat")
pop_vulnerability_max_current <- pop_vulnerability_max_current %>% 
  dplyr::select(-lon_lat)

# Remove data from one coordinate because it is not in the TerraClimate database and can't be compared to future climate scenario
pop_vulnerability_max_current <- subset(pop_vulnerability_max_current, !(lon_adj == -5.7 & lat_adj == -15.95))

saveRDS(pop_vulnerability_max_current, file="RData/Climate_vulnerability/Substrate/current/population_vulnerability_substrate_max_acc_current.rds")

######## Community-level patterns ################

community_vulnerability_max_current <- pop_vulnerability_max_current %>%
  mutate(TSM_weights = 1/(TSM_se^2),
         CTmax_weights = 1/(CTmax_se^2)) %>%
  group_by(lon, lat) %>%
  summarise(# ifelse statement is used here because in some locations, only one species is present.
    # Mean CTmax and maximum temperature at the community-level (weighted average and SE)
    community_CTmax = if_else(n() == 1, first(CTmax), sum(CTmax * CTmax_weights)/sum(CTmax_weights)), 
    community_CTmax_se = if_else(n() == 1, first(CTmax_se), sqrt(sum(CTmax_weights) * (n() - 1) / (((sum(CTmax_weights)^2) - (sum(CTmax_weights^2)))))),
    community_max_temp = first(max_temp), 
    community_max_temp_se = first(max_temp_se),
    # Mean TSM (weighted average and SE)
    community_TSM = if_else(n() == 1, first(TSM), sum(TSM * TSM_weights)/sum(TSM_weights)), 
    community_TSM_se = if_else(n() == 1, first(TSM_se), sqrt(sum(TSM_weights) * (n() - 1) / (((sum(TSM_weights)^2) - (sum(TSM_weights^2)))))),
    # Number of species
    n_species = n_distinct(tip.label), 
    # Number of species overheating
    n_species_overheating = sum(overheating_risk), 
    # Proportion of species overheating
    proportion_species_overheating = if_else(n() == 1, first(overheating_risk), mean(overheating_risk)), 
    proportion_species_overheating_se = if_else(n() == 1, 0, sd(overheating_risk)),
    # Sensitivity analyses accounting for uncertainty in CTmax
    n_species_overheating_strict95 = sum(overheating_risk_strict95), 
    n_species_overheating_strict50 = sum(overheating_risk_strict50),
    proportion_species_overheating_strict95 = if_else(n() == 1, first(overheating_risk_strict95), mean(overheating_risk_strict95)),
    proportion_species_overheating_se_strict95 = if_else(n() == 1, 0, sd(overheating_risk_strict95)),
    proportion_species_overheating_strict50 = if_else(n() == 1, first(overheating_risk_strict50), mean(overheating_risk_strict50)),
    proportion_species_overheating_se_strict50 = if_else(n() == 1, 0, sd(overheating_risk_strict50)),
    .groups = 'drop'
  )

rm(pop_vulnerability_max_current)

saveRDS(community_vulnerability_max_current, file="RData/Climate_vulnerability/Substrate/current/community_vulnerability_substrate_max_acc_current.rds")

rm(community_vulnerability_max_current)


###################################################################################################################
############### Acclimation to maximum weekly temperature on substrate, future climate (+2C) ######################

daily_CTmax_max_2C <- readRDS(file="RData/Climate_vulnerability/Substrate/future2C/daily_CTmax_substrate_max_acc_future2C.rds")

###### Daily TSM and overheating risk ##########

daily_vulnerability_max_2C <- daily_CTmax_max_2C %>% 
  mutate(daily_TSM = predicted_CTmax - max_temp,
         daily_TSM_se = predicted_CTmax_se,
         overheating_day = as.integer((predicted_CTmax - max_temp) < 0),
         upper_95CI_CTmax = predicted_CTmax + 1.96 * predicted_CTmax_se, # 95% CI
         upper_50CI_CTmax = predicted_CTmax + 0.6745 * predicted_CTmax_se) %>% # 50% CI
  # Here, overheating is considered when the upper bound of the confidence interval of CTmax is below max_temp
  mutate(overheating_day_strict95 = as.integer((upper_95CI_CTmax - max_temp) < 0),
         overheating_day_strict50 = as.integer((upper_50CI_CTmax - max_temp) < 0)) 

# Number of consecutive days of overheating
daily_consecutive_max_2C <- daily_CTmax_max_2C %>%  
  mutate(overheating_day = as.integer((predicted_CTmax - max_temp) < 0),
         upper_95CI_CTmax = predicted_CTmax + 1.96 * predicted_CTmax_se, 
         upper_50CI_CTmax = predicted_CTmax + 0.6745 * predicted_CTmax_se) %>% 
  mutate(overheating_day_strict95 = as.integer((upper_95CI_CTmax - max_temp) < 0),
         overheating_day_strict50 = as.integer((upper_50CI_CTmax - max_temp) < 0)) %>% 
  # Arrange by day and year
  group_by(tip.label, lon, lat, YEAR) %>%
  arrange(DOY) %>%
  # Calculate consecutive days of overheating
  mutate(consecutive_overheating_day = {
    rle_run <- rle(overheating_day)
    rep(rle_run$lengths * rle_run$values, times = rle_run$lengths)
  })


rm(daily_CTmax_max_2C)

########## Climate vulnerability metrics at the population-level  ###########

pop_vulnerability_max_2C <- daily_vulnerability_max_2C %>%
  mutate(TSM_weights = 1/(daily_TSM_se^2),
         CTmax_weights = 1/(predicted_CTmax_se^2)) %>% 
  group_by(tip.label, lon, lat) %>%
  summarise(
    # Mean CTmax and maximum temperature (weighted average and SE)
    CTmax = sum(predicted_CTmax * CTmax_weights)/sum(CTmax_weights), 
    CTmax_se = sqrt(sum(CTmax_weights) * (n() - 1) / (((sum(CTmax_weights)^2) - (sum(CTmax_weights^2))))),
    mean_max_temp = mean(max_temp),
    max_temp_se = sd(max_temp),
    # Mean TSM (weighted average and SE)
    TSM = sum(daily_TSM * TSM_weights)/sum(TSM_weights), 
    TSM_se = sqrt(sum(TSM_weights) * (n() - 1) / (((sum(TSM_weights)^2) - (sum(TSM_weights^2))))),
    # Number of overheating days and overheating risk
    overheating_days = sum(overheating_day),
    overheating_risk = as.integer(sum(overheating_day) > 0),
    # Sensitivity analyses accounting for uncertainty in CTmax
    overheating_days_strict95 = sum(overheating_day_strict95),
    overheating_days_strict50 = sum(overheating_day_strict50),
    overheating_risk_strict95 = as.integer(sum(overheating_day_strict95) > 0),
    overheating_risk_strict50 = as.integer(sum(overheating_day_strict50) > 0),
    .groups = 'drop'
  )

pop_vulnerability_max_2C <- pop_vulnerability_max_2C %>% rename(max_temp = mean_max_temp)

rm(daily_vulnerability_max_2C)

## Calculate number of consecutive overheating days
consecutive_overheating_days_2C <- daily_consecutive_max_2C %>% 
  group_by(tip.label, lon, lat) %>%
  summarise(consecutive_overheating_days = max(consecutive_overheating_day),
            .groups = 'drop')

rm(daily_consecutive_max_2C)

pop_vulnerability_max_2C <- pop_vulnerability_max_2C %>%
  left_join(consecutive_overheating_days_2C, by = c("tip.label", "lon", "lat"))

rm(consecutive_overheating_days_2C)

## Add original coordinates
pop_vulnerability_max_2C   <- pop_vulnerability_max_2C  %>% 
  rename(lon_adj = lon, lat_adj = lat) %>% 
  mutate(lon_lat = paste(lon_adj, lat_adj)) 

distinct_coord <- readRDS("RData/General_data/distinct_coordinates_adjusted.rds")
distinct_coord <- distinct_coord %>% 
  dplyr::select(lon_adj = lon, lat_adj = lat, lon = x, lat = y) %>% 
  mutate(lon_lat = paste(lon_adj, lat_adj)) %>% 
  dplyr::select(-lon_adj, -lat_adj)

pop_vulnerability_max_2C  <- left_join(pop_vulnerability_max_2C , distinct_coord, by="lon_lat")
pop_vulnerability_max_2C  <- pop_vulnerability_max_2C  %>% 
  dplyr::select(-lon_lat)

# Remove data from one coordinate because it is not in the TerraClimate database and can't be compared to future climate scenario
pop_vulnerability_max_2C<- subset(pop_vulnerability_max_2C, !(lon_adj == -5.7 & lat_adj == -15.95))

saveRDS(pop_vulnerability_max_2C, file="RData/Climate_vulnerability/Substrate/future2C/population_vulnerability_substrate_max_acc_future2C.rds")

######## Community-level patterns ################

community_vulnerability_max_2C <- pop_vulnerability_max_2C %>%
  mutate(TSM_weights = 1/(TSM_se^2),
         CTmax_weights = 1/(CTmax_se^2)) %>%
  group_by(lon, lat) %>%
  summarise(# ifelse statement is used here because in some locations, only one species is present.
    # Mean CTmax and maximum temperature at the community-level (weighted average and SE)
    community_CTmax = if_else(n() == 1, first(CTmax), sum(CTmax * CTmax_weights)/sum(CTmax_weights)), 
    community_CTmax_se = if_else(n() == 1, first(CTmax_se), sqrt(sum(CTmax_weights) * (n() - 1) / (((sum(CTmax_weights)^2) - (sum(CTmax_weights^2)))))),
    community_max_temp = first(max_temp), 
    community_max_temp_se = first(max_temp_se),
    # Mean TSM (weighted average and SE)
    community_TSM = if_else(n() == 1, first(TSM), sum(TSM * TSM_weights)/sum(TSM_weights)), 
    community_TSM_se = if_else(n() == 1, first(TSM_se), sqrt(sum(TSM_weights) * (n() - 1) / (((sum(TSM_weights)^2) - (sum(TSM_weights^2)))))),
    # Number of species
    n_species = n_distinct(tip.label), 
    # Number of species overheating
    n_species_overheating = sum(overheating_risk), 
    # Proportion of species overheating
    proportion_species_overheating = if_else(n() == 1, first(overheating_risk), mean(overheating_risk)), 
    proportion_species_overheating_se = if_else(n() == 1, 0, sd(overheating_risk)),
    # Sensitivity analyses accounting for uncertainty in CTmax
    n_species_overheating_strict95 = sum(overheating_risk_strict95), 
    n_species_overheating_strict50 = sum(overheating_risk_strict50),
    proportion_species_overheating_strict95 = if_else(n() == 1, first(overheating_risk_strict95), mean(overheating_risk_strict95)),
    proportion_species_overheating_se_strict95 = if_else(n() == 1, 0, sd(overheating_risk_strict95)),
    proportion_species_overheating_strict50 = if_else(n() == 1, first(overheating_risk_strict50), mean(overheating_risk_strict50)),
    proportion_species_overheating_se_strict50 = if_else(n() == 1, 0, sd(overheating_risk_strict50)),
    .groups = 'drop'
  )

rm(pop_vulnerability_max_2C)

saveRDS(community_vulnerability_max_2C, file="RData/Climate_vulnerability/Substrate/future2C/community_vulnerability_substrate_max_acc_future2C.rds")

rm(community_vulnerability_max_2C)


###################################################################################################################
############### Acclimation to maximum weekly temperature on substrate, future climate (+4C) ######################


daily_CTmax_max_4C <- readRDS(file="RData/Climate_vulnerability/Substrate/future4C/daily_CTmax_substrate_max_acc_future4C.rds")

###### Daily TSM and overheating risk ##########

daily_vulnerability_max_4C <- daily_CTmax_max_4C %>% 
  mutate(daily_TSM = predicted_CTmax - max_temp,
         daily_TSM_se = predicted_CTmax_se,
         overheating_day = as.integer((predicted_CTmax - max_temp) < 0),
         upper_95CI_CTmax = predicted_CTmax + 1.96 * predicted_CTmax_se, # 95% CI
         upper_50CI_CTmax = predicted_CTmax + 0.6745 * predicted_CTmax_se) %>% # 50% CI
  # Here, overheating is considered when the upper bound of the confidence interval of CTmax is below max_temp
  mutate(overheating_day_strict95 = as.integer((upper_95CI_CTmax - max_temp) < 0),
         overheating_day_strict50 = as.integer((upper_50CI_CTmax - max_temp) < 0)) 

# Number of consecutive days of overheating
daily_consecutive_max_4C <- daily_CTmax_max_4C %>%  
  mutate(overheating_day = as.integer((predicted_CTmax - max_temp) < 0),
         upper_95CI_CTmax = predicted_CTmax + 1.96 * predicted_CTmax_se, 
         upper_50CI_CTmax = predicted_CTmax + 0.6745 * predicted_CTmax_se) %>% 
  mutate(overheating_day_strict95 = as.integer((upper_95CI_CTmax - max_temp) < 0),
         overheating_day_strict50 = as.integer((upper_50CI_CTmax - max_temp) < 0)) %>% 
  # Arrange by day and year
  group_by(tip.label, lon, lat, YEAR) %>%
  arrange(DOY) %>%
  # Calculate consecutive days of overheating
  mutate(consecutive_overheating_day = {
    rle_run <- rle(overheating_day)
    rep(rle_run$lengths * rle_run$values, times = rle_run$lengths)
  })


rm(daily_CTmax_max_4C)

########## Climate vulnerability metrics at the population-level  ###########

pop_vulnerability_max_4C <- daily_vulnerability_max_4C %>%
  mutate(TSM_weights = 1/(daily_TSM_se^2),
         CTmax_weights = 1/(predicted_CTmax_se^2)) %>% 
  group_by(tip.label, lon, lat) %>%
  summarise(
    # Mean CTmax and maximum temperature (weighted average and SE)
    CTmax = sum(predicted_CTmax * CTmax_weights)/sum(CTmax_weights), 
    CTmax_se = sqrt(sum(CTmax_weights) * (n() - 1) / (((sum(CTmax_weights)^2) - (sum(CTmax_weights^2))))),
    mean_max_temp = mean(max_temp),
    max_temp_se = sd(max_temp),
    # Mean TSM (weighted average and SE)
    TSM = sum(daily_TSM * TSM_weights)/sum(TSM_weights), 
    TSM_se = sqrt(sum(TSM_weights) * (n() - 1) / (((sum(TSM_weights)^2) - (sum(TSM_weights^2))))),
    # Number of overheating days and overheating risk
    overheating_days = sum(overheating_day),
    overheating_risk = as.integer(sum(overheating_day) > 0),
    # Sensitivity analyses accounting for uncertainty in CTmax
    overheating_days_strict95 = sum(overheating_day_strict95),
    overheating_days_strict50 = sum(overheating_day_strict50),
    overheating_risk_strict95 = as.integer(sum(overheating_day_strict95) > 0),
    overheating_risk_strict50 = as.integer(sum(overheating_day_strict50) > 0),
    .groups = 'drop'
  )

pop_vulnerability_max_4C <- pop_vulnerability_max_4C %>% rename(max_temp = mean_max_temp)

rm(daily_vulnerability_max_4C)

## Calculate number of consecutive overheating days
consecutive_overheating_days_4C <- daily_consecutive_max_4C %>% 
  group_by(tip.label, lon, lat) %>%
  summarise(consecutive_overheating_days = max(consecutive_overheating_day),
            .groups = 'drop')

rm(daily_consecutive_max_4C)

pop_vulnerability_max_4C <- pop_vulnerability_max_4C %>%
  left_join(consecutive_overheating_days_4C, by = c("tip.label", "lon", "lat"))

rm(consecutive_overheating_days_4C)

## Add original coordinates
pop_vulnerability_max_4C   <- pop_vulnerability_max_4C  %>% 
  rename(lon_adj = lon, lat_adj = lat) %>% 
  mutate(lon_lat = paste(lon_adj, lat_adj)) 

distinct_coord <- readRDS("RData/General_data/distinct_coordinates_adjusted.rds")
distinct_coord <- distinct_coord %>% 
  dplyr::select(lon_adj = lon, lat_adj = lat, lon = x, lat = y) %>% 
  mutate(lon_lat = paste(lon_adj, lat_adj)) %>% 
  dplyr::select(-lon_adj, -lat_adj)

pop_vulnerability_max_4C  <- left_join(pop_vulnerability_max_4C , distinct_coord, by="lon_lat")
pop_vulnerability_max_4C  <- pop_vulnerability_max_4C  %>% 
  dplyr::select(-lon_lat)

# Remove data from one coordinate because it is not in the TerraClimate database and can't be compared to future climate scenario
pop_vulnerability_max_4C <- subset(pop_vulnerability_max_4C, !(lon_adj == -5.7 & lat_adj == -15.95))

saveRDS(pop_vulnerability_max_4C, file="RData/Climate_vulnerability/Substrate/future4C/population_vulnerability_substrate_max_acc_future4C.rds")

######## Community-level patterns ################

community_vulnerability_max_4C <- pop_vulnerability_max_4C %>%
  mutate(TSM_weights = 1/(TSM_se^2),
         CTmax_weights = 1/(CTmax_se^2)) %>%
  group_by(lon, lat) %>%
  summarise(# ifelse statement is used here because in some locations, only one species is present.
    # Mean CTmax and maximum temperature at the community-level (weighted average and SE)
    community_CTmax = if_else(n() == 1, first(CTmax), sum(CTmax * CTmax_weights)/sum(CTmax_weights)), 
    community_CTmax_se = if_else(n() == 1, first(CTmax_se), sqrt(sum(CTmax_weights) * (n() - 1) / (((sum(CTmax_weights)^2) - (sum(CTmax_weights^2)))))),
    community_max_temp = first(max_temp), 
    community_max_temp_se = first(max_temp_se),
    # Mean TSM (weighted average and SE)
    community_TSM = if_else(n() == 1, first(TSM), sum(TSM * TSM_weights)/sum(TSM_weights)), 
    community_TSM_se = if_else(n() == 1, first(TSM_se), sqrt(sum(TSM_weights) * (n() - 1) / (((sum(TSM_weights)^2) - (sum(TSM_weights^2)))))),
    # Number of species
    n_species = n_distinct(tip.label), 
    # Number of species overheating
    n_species_overheating = sum(overheating_risk), 
    # Proportion of species overheating
    proportion_species_overheating = if_else(n() == 1, first(overheating_risk), mean(overheating_risk)), 
    proportion_species_overheating_se = if_else(n() == 1, 0, sd(overheating_risk)),
    # Sensitivity analyses accounting for uncertainty in CTmax
    n_species_overheating_strict95 = sum(overheating_risk_strict95), 
    n_species_overheating_strict50 = sum(overheating_risk_strict50),
    proportion_species_overheating_strict95 = if_else(n() == 1, first(overheating_risk_strict95), mean(overheating_risk_strict95)),
    proportion_species_overheating_se_strict95 = if_else(n() == 1, 0, sd(overheating_risk_strict95)),
    proportion_species_overheating_strict50 = if_else(n() == 1, first(overheating_risk_strict50), mean(overheating_risk_strict50)),
    proportion_species_overheating_se_strict50 = if_else(n() == 1, 0, sd(overheating_risk_strict50)),
    .groups = 'drop'
  )

rm(pop_vulnerability_max_4C)

saveRDS(community_vulnerability_max_4C, file="RData/Climate_vulnerability/Substrate/future4C/community_vulnerability_substrate_max_acc_future4C.rds")

rm(community_vulnerability_max_4C)
