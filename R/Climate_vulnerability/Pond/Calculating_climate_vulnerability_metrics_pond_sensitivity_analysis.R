pacman::p_load(devtools,
               tidyverse,
               purrr,
               parallel,
               doParallel,
               abind,
               curl,
               zoo,
               data.table,
               metafor,
               future,
               furrr,
               future.apply,
               parallel)

# Set the seed for reproducibility
set.seed(123)

##############################################################################################################
############### Acclimation to mean weekly temperature in above ground vegetation, current climate  #########################

daily_CTmax_mean_current <- readRDS(file="RData/Climate_vulnerability/Pond/current/daily_CTmax_pond_mean_acc_current.rds")

# Assign a maximum se for observations with very large error. 
# This is capped to avoid large uncertainty to overestimate overheating probabilities
# A SD of 1 simulates values within ~3 degrees of the mean CTmax
cap_se <- 1

# Function to calculate overheating probability and SE
calculate_overheating_probability <- function(predicted_CTmax, predicted_CTmax_se, max_temp) {
  capped_se <- min(predicted_CTmax_se, cap_se)  # Take the predicted SE if under the capped SE
  prob_overheating <- pnorm(max_temp, mean = predicted_CTmax, sd = capped_se) # Probability that max temp exceeds CTmax distribution
  return(list(prob_overheating = prob_overheating))
}

# Calculate 5% and 95% percentile for each group
daily_percentiles_mean_current_sens <- daily_CTmax_mean_current %>%
  group_by(tip.label, lon, lat) %>%
  summarise(p5_max_temp = quantile(max_temp, 0.05),
            p95_max_temp = quantile(max_temp, 0.95))

# Filter data within 5% to 95% percentile range
daily_filtered_mean_current_sens <- daily_CTmax_mean_current %>%
  inner_join(daily_percentiles_mean_current_sens, by = c("tip.label", "lon", "lat")) %>%
  filter(max_temp >= p5_max_temp & max_temp <= p95_max_temp)

# Daily TSM and overheating risk 
daily_vulnerability_mean_current_sens <- daily_filtered_mean_current_sens %>% 
  rowwise() %>% 
  mutate(overheating_result = list(calculate_overheating_probability(predicted_CTmax, predicted_CTmax_se, max_temp)), # Apply function
         overheating_prob = overheating_result$prob_overheating, # retrieve overheating probability
         overheating_day = ifelse(overheating_prob > 0.5, 1, 0), # Consider overheating day when overheating probability > 0.5
         daily_TSM = predicted_CTmax - max_temp,
         daily_TSM_se = predicted_CTmax_se)  %>% 
  ungroup() %>% 
  dplyr::select(-overheating_result)

# Set number of days
n_days <- 910

########## Climate vulnerability metrics at the population-level  ###########
pop_vulnerability_mean_current_sens <- daily_vulnerability_mean_current_sens %>%
  mutate(TSM_weights = 1/(daily_TSM_se^2),
         CTmax_weights = 1/(predicted_CTmax_se^2)) %>% 
  group_by(tip.label, lon, lat) %>%
  summarise(
    # Mean CTmax and maximum temperature (weighted average and SE)
    CTmax = sum(predicted_CTmax * CTmax_weights)/sum(CTmax_weights), 
    CTmax_se = sqrt(sum(CTmax_weights) * (n() - 1) / (((sum(CTmax_weights)^2) - (sum(CTmax_weights^2))))),
    mean_max_temp = mean(max_temp),
    max_temp_se = sd(max_temp),
    # Mean TSM (weighted average and SE)
    TSM = sum(daily_TSM * TSM_weights)/sum(TSM_weights), 
    TSM_se = sqrt(sum(TSM_weights) * (n() - 1) / (((sum(TSM_weights)^2) - (sum(TSM_weights^2))))),
    # Combine daily overheating probabilities for each population
    overheating_probability = mean(overheating_prob),
    overheating_probability_se = sqrt(overheating_probability * (1 - overheating_probability)),
    .groups = 'drop') %>%
  rowwise() %>%
  mutate(
    overheating_days = n_days * overheating_probability,
    overheating_days_se = sqrt(n_days * overheating_probability * (1 - overheating_probability)), # SE in overheating days
    overheating_risk = ifelse(overheating_days >= 1, 1, 0) # Overheating risk when overheating days >= 1
  ) %>%
  ungroup() 

pop_vulnerability_mean_current_sens <- pop_vulnerability_mean_current_sens %>% rename(max_temp = mean_max_temp)

# Create a dataframe with only the 95th percentile of max_temp for each population
pop_data_95_mean_current_sens <- daily_filtered_mean_current_sens %>%
  group_by(tip.label, lon, lat) %>%
  slice_max(order_by = max_temp, n = 1) %>% 
  ungroup()

# Calculate TSM as the difference with the 95th percentile maximum temperature 
pop_vulnerability_mean_current_sens_95 <- pop_data_95_mean_current_sens %>% 
  rowwise() %>% 
  mutate(TSM_95 = predicted_CTmax - max_temp,
         TSM_95_se = predicted_CTmax_se,
         CTmax_95 = predicted_CTmax,
         CTmax_95_se = predicted_CTmax_se,
         max_temp_95 = max_temp,
         overheating_result_95 = list(calculate_overheating_probability(predicted_CTmax, predicted_CTmax_se, max_temp)), 
         overheating_probability_95 = overheating_result_95$prob_overheating, 
         overheating_risk_95 = ifelse(overheating_probability_95 > 0.5, 1, 0)) %>%   
  ungroup() %>% 
  dplyr::select(-overheating_result_95) 


# Combine data frames
pop_vulnerability_mean_current_sens <- pop_vulnerability_mean_current_sens %>%
  left_join(dplyr::select(pop_vulnerability_mean_current_sens_95,
                          tip.label, 
                          lon, 
                          lat, 
                          TSM_95, 
                          TSM_95_se, 
                          CTmax_95, 
                          CTmax_95_se, 
                          max_temp_95,
                          overheating_probability_95,
                          overheating_risk_95), 
            by = c("tip.label", "lon", "lat"))

rm(pop_vulnerability_mean_current_sens_95)

# Create a dataframe with only the max_temp for each population (minimum TSM)
pop_data_extreme_mean_current_sens <- daily_CTmax_mean_current  %>% 
  group_by(tip.label, lon, lat) %>%
  filter(max_temp == max(max_temp)) %>% 
  ungroup()

# Calculate TSM as the difference with the maximum temperature (most extreme TSM)
pop_vulnerability_extreme_mean_current_sens <- pop_data_extreme_mean_current_sens %>% 
  rowwise() %>% 
  mutate(TSM_extreme = predicted_CTmax - max_temp,
         TSM_extreme_se = predicted_CTmax_se,
         CTmax_extreme = predicted_CTmax,
         CTmax_extreme_se = predicted_CTmax_se,
         max_temp_extreme = max_temp,
         overheating_result_extreme = list(calculate_overheating_probability(predicted_CTmax, predicted_CTmax_se, max_temp)), 
         overheating_probability_extreme = overheating_result_extreme$prob_overheating, 
         overheating_risk_extreme = ifelse(overheating_probability_extreme > 0.5, 1, 0)) %>%   
  ungroup() %>% 
  dplyr::select(-overheating_result_extreme) 

# Join datasets
pop_vulnerability_mean_current_sens <- pop_vulnerability_mean_current_sens %>%
  left_join(dplyr::select(pop_vulnerability_extreme_mean_current_sens,
                          tip.label, 
                          lon, 
                          lat, 
                          TSM_extreme, 
                          TSM_extreme_se, 
                          CTmax_extreme, 
                          CTmax_extreme_se, 
                          max_temp_extreme,
                          overheating_probability_extreme,
                          overheating_risk_extreme), 
            by = c("tip.label", "lon", "lat"))

## Add original coordinates
pop_vulnerability_mean_current_sens   <- pop_vulnerability_mean_current_sens  %>% 
  rename(lon_adj = lon, lat_adj = lat) %>% 
  mutate(lon_lat = paste(lon_adj, lat_adj)) 

distinct_coord <- readRDS("RData/General_data/distinct_coordinates_adjusted.rds")
distinct_coord <- distinct_coord %>% 
  dplyr::select(lon_adj = lon, lat_adj = lat, lon = x, lat = y) %>% 
  mutate(lon_lat = paste(lon_adj, lat_adj)) %>% 
  dplyr::select(-lon_adj, -lat_adj)

pop_vulnerability_mean_current_sens  <- left_join(pop_vulnerability_mean_current_sens , distinct_coord, by="lon_lat")
pop_vulnerability_mean_current_sens  <- pop_vulnerability_mean_current_sens  %>% 
  dplyr::select(-lon_lat)

saveRDS(pop_vulnerability_mean_current_sens, file="RData/Climate_vulnerability/Pond/current/population_vulnerability_pond_mean_acc_current_sensitivity_analysis.rds")

######## Community-level patterns ################

community_vulnerability_mean_current_sens <- pop_vulnerability_mean_current_sens %>%
  mutate(TSM_weights = 1/(TSM_se^2),
         CTmax_weights = 1/(CTmax_se^2),
         TSM_extreme_weights = 1/(TSM_extreme_se^2),
         TSM_95_weights = 1/(TSM_95_se^2)) %>%
  group_by(lon, lat) %>%
  summarise(# ifelse statement is used here because in some locations, only one species is present.
    # Mean CTmax and maximum temperature at the community-level (weighted average and SE)
    community_CTmax = if_else(n() == 1, first(CTmax), sum(CTmax * CTmax_weights)/sum(CTmax_weights)), 
    community_CTmax_se = if_else(n() == 1, first(CTmax_se), sqrt(sum(CTmax_weights) * (n() - 1) / (((sum(CTmax_weights)^2) - (sum(CTmax_weights^2)))))),
    community_max_temp = first(max_temp), 
    community_max_temp_se = first(max_temp_se),
    # Mean TSM (weighted average and SE)
    community_TSM = if_else(n() == 1, first(TSM), sum(TSM * TSM_weights)/sum(TSM_weights)), 
    community_TSM_se = if_else(n() == 1, first(TSM_se), sqrt(sum(TSM_weights) * (n() - 1) / (((sum(TSM_weights)^2) - (sum(TSM_weights^2)))))),
    # Number of species
    n_species = n_distinct(tip.label), 
    # Number of species overheating
    n_species_overheating = sum(overheating_risk), 
    # Proportion of species overheating
    proportion_species_overheating = if_else(n() == 1, first(overheating_risk), mean(overheating_risk)), 
    proportion_species_overheating_se = if_else(n() == 1, 0, sd(overheating_risk)),
    # TSM calculated as the difference with the maximum body temperature 
    community_TSM_extreme = if_else(n() == 1, first(TSM_extreme), sum(TSM_extreme * TSM_extreme_weights)/sum(TSM_extreme_weights)), 
    community_TSM_extreme_se = if_else(n() == 1, first(TSM_extreme_se), sqrt(sum(TSM_extreme_weights) * (n() - 1) / (((sum(TSM_extreme_weights)^2) - (sum(TSM_extreme_weights^2)))))),
    # TSM calculated as the difference with the 95th percentile body temperature 
    community_TSM_95 = if_else(n() == 1, first(TSM_95), sum(TSM_95 * TSM_95_weights)/sum(TSM_95_weights)), 
    community_TSM_95_se = if_else(n() == 1, first(TSM_95_se), sqrt(sum(TSM_95_weights) * (n() - 1) / (((sum(TSM_95_weights)^2) - (sum(TSM_95_weights^2)))))),
    .groups = 'drop'
  )

saveRDS(community_vulnerability_mean_current_sens, file="RData/Climate_vulnerability/Pond/current/community_vulnerability_pond_mean_acc_current_sensitivity_analysis.rds")

rm(daily_CTmax_mean_current)
rm(daily_vulnerability_mean_current_sens)
rm(daily_percentiles_mean_current_sens)
rm(daily_filtered_mean_current_sens)
rm(pop_vulnerability_mean_current_sens)

##############################################################################################################
############### Acclimation to mean weekly temperature in above ground vegetation, future climate (+2C) #########################

daily_CTmax_mean_2C <- readRDS(file="RData/Climate_vulnerability/Pond/future2C/daily_CTmax_pond_mean_acc_future2C.rds")

# Assign a maximum se for observations with very large error. 
# This is capped to avoid large uncertainty to overestimate overheating probabilities
# A SD of 1 simulates values within ~3 degrees of the mean CTmax
cap_se <- 1

# Function to calculate overheating probability and SE
calculate_overheating_probability <- function(predicted_CTmax, predicted_CTmax_se, max_temp) {
  capped_se <- min(predicted_CTmax_se, cap_se)  # Take the predicted SE if under the capped SE
  prob_overheating <- pnorm(max_temp, mean = predicted_CTmax, sd = capped_se) # Probability that max temp exceeds CTmax distribution
  return(list(prob_overheating = prob_overheating))
}

# Calculate 5% and 95% percentile for each group
daily_percentiles_mean_2C_sens <- daily_CTmax_mean_2C %>%
  group_by(tip.label, lon, lat) %>%
  summarise(p5_max_temp = quantile(max_temp, 0.05),
            p95_max_temp = quantile(max_temp, 0.95))

# Filter data within 5% to 95% percentile range
daily_filtered_mean_2C_sens <- daily_CTmax_mean_2C %>%
  inner_join(daily_percentiles_mean_2C_sens, by = c("tip.label", "lon", "lat")) %>%
  filter(max_temp >= p5_max_temp & max_temp <= p95_max_temp)

# Daily TSM and overheating risk 
daily_vulnerability_mean_2C_sens <- daily_filtered_mean_2C_sens %>% 
  rowwise() %>% 
  mutate(overheating_result = list(calculate_overheating_probability(predicted_CTmax, predicted_CTmax_se, max_temp)), # Apply function
         overheating_prob = overheating_result$prob_overheating, # retrieve overheating probability
         overheating_day = ifelse(overheating_prob > 0.5, 1, 0), # Consider overheating day when overheating probability > 0.5
         daily_TSM = predicted_CTmax - max_temp,
         daily_TSM_se = predicted_CTmax_se)  %>% 
  ungroup() %>% 
  dplyr::select(-overheating_result)

# Set number of days
n_days <- 910

########## Climate vulnerability metrics at the population-level  ###########
pop_vulnerability_mean_2C_sens <- daily_vulnerability_mean_2C_sens %>%
  mutate(TSM_weights = 1/(daily_TSM_se^2),
         CTmax_weights = 1/(predicted_CTmax_se^2)) %>% 
  group_by(tip.label, lon, lat) %>%
  summarise(
    # Mean CTmax and maximum temperature (weighted average and SE)
    CTmax = sum(predicted_CTmax * CTmax_weights)/sum(CTmax_weights), 
    CTmax_se = sqrt(sum(CTmax_weights) * (n() - 1) / (((sum(CTmax_weights)^2) - (sum(CTmax_weights^2))))),
    mean_max_temp = mean(max_temp),
    max_temp_se = sd(max_temp),
    # Mean TSM (weighted average and SE)
    TSM = sum(daily_TSM * TSM_weights)/sum(TSM_weights), 
    TSM_se = sqrt(sum(TSM_weights) * (n() - 1) / (((sum(TSM_weights)^2) - (sum(TSM_weights^2))))),
    # Combine daily overheating probabilities for each population
    overheating_probability = mean(overheating_prob),
    overheating_probability_se = sqrt(overheating_probability * (1 - overheating_probability)),
    .groups = 'drop') %>%
  rowwise() %>%
  mutate(
    overheating_days = n_days * overheating_probability,
    overheating_days_se = sqrt(n_days * overheating_probability * (1 - overheating_probability)), # SE in overheating days
    overheating_risk = ifelse(overheating_days >= 1, 1, 0) # Overheating risk when overheating days >= 1
  ) %>%
  ungroup() 

pop_vulnerability_mean_2C_sens <- pop_vulnerability_mean_2C_sens %>% rename(max_temp = mean_max_temp)

# Create a dataframe with only the 95th percentile of max_temp for each population
pop_data_95_mean_2C_sens <- daily_filtered_mean_2C_sens %>%
  group_by(tip.label, lon, lat) %>%
  slice_max(order_by = max_temp, n = 1) %>% 
  ungroup()

# Calculate TSM as the difference with the 95th percentile maximum temperature 
pop_vulnerability_mean_2C_sens_95 <- pop_data_95_mean_2C_sens %>% 
  rowwise() %>% 
  mutate(TSM_95 = predicted_CTmax - max_temp,
         TSM_95_se = predicted_CTmax_se,
         CTmax_95 = predicted_CTmax,
         CTmax_95_se = predicted_CTmax_se,
         max_temp_95 = max_temp,
         overheating_result_95 = list(calculate_overheating_probability(predicted_CTmax, predicted_CTmax_se, max_temp)), 
         overheating_probability_95 = overheating_result_95$prob_overheating, 
         overheating_risk_95 = ifelse(overheating_probability_95 > 0.5, 1, 0)) %>%   
  ungroup() %>% 
  dplyr::select(-overheating_result_95) 


# Combine data frames
pop_vulnerability_mean_2C_sens <- pop_vulnerability_mean_2C_sens %>%
  left_join(dplyr::select(pop_vulnerability_mean_2C_sens_95,
                          tip.label, 
                          lon, 
                          lat, 
                          TSM_95, 
                          TSM_95_se, 
                          CTmax_95, 
                          CTmax_95_se, 
                          max_temp_95,
                          overheating_probability_95,
                          overheating_risk_95), 
            by = c("tip.label", "lon", "lat"))

rm(pop_vulnerability_mean_2C_sens_95)

# Create a dataframe with only the max_temp for each population (minimum TSM)
pop_data_extreme_mean_2C_sens <- daily_CTmax_mean_2C  %>% 
  group_by(tip.label, lon, lat) %>%
  filter(max_temp == max(max_temp)) %>% 
  ungroup()

# Calculate TSM as the difference with the maximum temperature (most extreme TSM)
pop_vulnerability_extreme_mean_2C_sens <- pop_data_extreme_mean_2C_sens %>% 
  rowwise() %>% 
  mutate(TSM_extreme = predicted_CTmax - max_temp,
         TSM_extreme_se = predicted_CTmax_se,
         CTmax_extreme = predicted_CTmax,
         CTmax_extreme_se = predicted_CTmax_se,
         max_temp_extreme = max_temp,
         overheating_result_extreme = list(calculate_overheating_probability(predicted_CTmax, predicted_CTmax_se, max_temp)), 
         overheating_probability_extreme = overheating_result_extreme$prob_overheating, 
         overheating_risk_extreme = ifelse(overheating_probability_extreme > 0.5, 1, 0)) %>%   
  ungroup() %>% 
  dplyr::select(-overheating_result_extreme) 

# Join datasets
pop_vulnerability_mean_2C_sens <- pop_vulnerability_mean_2C_sens %>%
  left_join(dplyr::select(pop_vulnerability_extreme_mean_2C_sens,
                          tip.label, 
                          lon, 
                          lat, 
                          TSM_extreme, 
                          TSM_extreme_se, 
                          CTmax_extreme, 
                          CTmax_extreme_se, 
                          max_temp_extreme,
                          overheating_probability_extreme,
                          overheating_risk_extreme), 
            by = c("tip.label", "lon", "lat"))

## Add original coordinates
pop_vulnerability_mean_2C_sens   <- pop_vulnerability_mean_2C_sens  %>% 
  rename(lon_adj = lon, lat_adj = lat) %>% 
  mutate(lon_lat = paste(lon_adj, lat_adj)) 

distinct_coord <- readRDS("RData/General_data/distinct_coordinates_adjusted.rds")
distinct_coord <- distinct_coord %>% 
  dplyr::select(lon_adj = lon, lat_adj = lat, lon = x, lat = y) %>% 
  mutate(lon_lat = paste(lon_adj, lat_adj)) %>% 
  dplyr::select(-lon_adj, -lat_adj)

pop_vulnerability_mean_2C_sens  <- left_join(pop_vulnerability_mean_2C_sens , distinct_coord, by="lon_lat")
pop_vulnerability_mean_2C_sens  <- pop_vulnerability_mean_2C_sens  %>% 
  dplyr::select(-lon_lat)

saveRDS(pop_vulnerability_mean_2C_sens, file="RData/Climate_vulnerability/Pond/future2C/population_vulnerability_pond_mean_acc_future2C_sensitivity_analysis.rds")

######## Community-level patterns ################

community_vulnerability_mean_2C_sens <- pop_vulnerability_mean_2C_sens %>%
  mutate(TSM_weights = 1/(TSM_se^2),
         CTmax_weights = 1/(CTmax_se^2),
         TSM_extreme_weights = 1/(TSM_extreme_se^2),
         TSM_95_weights = 1/(TSM_95_se^2)) %>%
  group_by(lon, lat) %>%
  summarise(# ifelse statement is used here because in some locations, only one species is present.
    # Mean CTmax and maximum temperature at the community-level (weighted average and SE)
    community_CTmax = if_else(n() == 1, first(CTmax), sum(CTmax * CTmax_weights)/sum(CTmax_weights)), 
    community_CTmax_se = if_else(n() == 1, first(CTmax_se), sqrt(sum(CTmax_weights) * (n() - 1) / (((sum(CTmax_weights)^2) - (sum(CTmax_weights^2)))))),
    community_max_temp = first(max_temp), 
    community_max_temp_se = first(max_temp_se),
    # Mean TSM (weighted average and SE)
    community_TSM = if_else(n() == 1, first(TSM), sum(TSM * TSM_weights)/sum(TSM_weights)), 
    community_TSM_se = if_else(n() == 1, first(TSM_se), sqrt(sum(TSM_weights) * (n() - 1) / (((sum(TSM_weights)^2) - (sum(TSM_weights^2)))))),
    # Number of species
    n_species = n_distinct(tip.label), 
    # Number of species overheating
    n_species_overheating = sum(overheating_risk), 
    # Proportion of species overheating
    proportion_species_overheating = if_else(n() == 1, first(overheating_risk), mean(overheating_risk)), 
    proportion_species_overheating_se = if_else(n() == 1, 0, sd(overheating_risk)),
    # TSM calculated as the difference with the maximum body temperature 
    community_TSM_extreme = if_else(n() == 1, first(TSM_extreme), sum(TSM_extreme * TSM_extreme_weights)/sum(TSM_extreme_weights)), 
    community_TSM_extreme_se = if_else(n() == 1, first(TSM_extreme_se), sqrt(sum(TSM_extreme_weights) * (n() - 1) / (((sum(TSM_extreme_weights)^2) - (sum(TSM_extreme_weights^2)))))),
    # TSM calculated as the difference with the 95th percentile body temperature 
    community_TSM_95 = if_else(n() == 1, first(TSM_95), sum(TSM_95 * TSM_95_weights)/sum(TSM_95_weights)), 
    community_TSM_95_se = if_else(n() == 1, first(TSM_95_se), sqrt(sum(TSM_95_weights) * (n() - 1) / (((sum(TSM_95_weights)^2) - (sum(TSM_95_weights^2)))))),
    .groups = 'drop'
  )

saveRDS(community_vulnerability_mean_2C_sens, file="RData/Climate_vulnerability/Pond/future2C/community_vulnerability_pond_mean_acc_future2C_sensitivity_analysis.rds")


rm(daily_CTmax_mean_2C)
rm(daily_vulnerability_mean_2C_sens)
rm(daily_percentiles_mean_2C_sens)
rm(daily_filtered_mean_2C_sens)
rm(pop_vulnerability_mean_2C_sens)

##############################################################################################################
############### Acclimation to mean weekly temperature in ponds, future climate (+4C) #########################

daily_CTmax_mean_4C <- readRDS(file="RData/Climate_vulnerability/Pond/future4C/daily_CTmax_pond_mean_acc_future4C.rds")

# Assign a maximum se for observations with very large error. 
# This is capped to avoid large uncertainty to overestimate overheating probabilities
# A SD of 1 simulates values within ~3 degrees of the mean CTmax
cap_se <- 1

# Function to calculate overheating probability and SE
calculate_overheating_probability <- function(predicted_CTmax, predicted_CTmax_se, max_temp) {
  capped_se <- min(predicted_CTmax_se, cap_se)  # Take the predicted SE if under the capped SE
  prob_overheating <- pnorm(max_temp, mean = predicted_CTmax, sd = capped_se) # Probability that max temp exceeds CTmax distribution
  return(list(prob_overheating = prob_overheating))
}

# Calculate 5% and 95% percentile for each group
daily_percentiles_mean_4C_sens <- daily_CTmax_mean_4C %>%
  group_by(tip.label, lon, lat) %>%
  summarise(p5_max_temp = quantile(max_temp, 0.05),
            p95_max_temp = quantile(max_temp, 0.95))

# Filter data within 5% to 95% percentile range
daily_filtered_mean_4C_sens <- daily_CTmax_mean_4C %>%
  inner_join(daily_percentiles_mean_4C_sens, by = c("tip.label", "lon", "lat")) %>%
  filter(max_temp >= p5_max_temp & max_temp <= p95_max_temp)

# Daily TSM and overheating risk 
daily_vulnerability_mean_4C_sens <- daily_filtered_mean_4C_sens %>% 
  rowwise() %>% 
  mutate(overheating_result = list(calculate_overheating_probability(predicted_CTmax, predicted_CTmax_se, max_temp)), # Apply function
         overheating_prob = overheating_result$prob_overheating, # retrieve overheating probability
         overheating_day = ifelse(overheating_prob > 0.5, 1, 0), # Consider overheating day when overheating probability > 0.5
         daily_TSM = predicted_CTmax - max_temp,
         daily_TSM_se = predicted_CTmax_se)  %>% 
  ungroup() %>% 
  dplyr::select(-overheating_result)

# Set number of days
n_days <- 910

########## Climate vulnerability metrics at the population-level  ###########
pop_vulnerability_mean_4C_sens <- daily_vulnerability_mean_4C_sens %>%
  mutate(TSM_weights = 1/(daily_TSM_se^2),
         CTmax_weights = 1/(predicted_CTmax_se^2)) %>% 
  group_by(tip.label, lon, lat) %>%
  summarise(
    # Mean CTmax and maximum temperature (weighted average and SE)
    CTmax = sum(predicted_CTmax * CTmax_weights)/sum(CTmax_weights), 
    CTmax_se = sqrt(sum(CTmax_weights) * (n() - 1) / (((sum(CTmax_weights)^2) - (sum(CTmax_weights^2))))),
    mean_max_temp = mean(max_temp),
    max_temp_se = sd(max_temp),
    # Mean TSM (weighted average and SE)
    TSM = sum(daily_TSM * TSM_weights)/sum(TSM_weights), 
    TSM_se = sqrt(sum(TSM_weights) * (n() - 1) / (((sum(TSM_weights)^2) - (sum(TSM_weights^2))))),
    # Combine daily overheating probabilities for each population
    overheating_probability = mean(overheating_prob),
    overheating_probability_se = sqrt(overheating_probability * (1 - overheating_probability)),
    .groups = 'drop') %>%
  rowwise() %>%
  mutate(
    overheating_days = n_days * overheating_probability,
    overheating_days_se = sqrt(n_days * overheating_probability * (1 - overheating_probability)), # SE in overheating days
    overheating_risk = ifelse(overheating_days >= 1, 1, 0), # Overheating risk when overheating days >= 1
  ) %>%
  ungroup() 

pop_vulnerability_mean_4C_sens <- pop_vulnerability_mean_4C_sens %>% rename(max_temp = mean_max_temp)

# Create a dataframe with only the 95th percentile of max_temp for each population
pop_data_95_mean_4C_sens <- daily_filtered_mean_4C_sens %>%
  group_by(tip.label, lon, lat) %>%
  slice_max(order_by = max_temp, n = 1) %>% 
  ungroup()

# Calculate TSM as the difference with the 95th percentile maximum temperature 
pop_vulnerability_mean_4C_sens_95 <- pop_data_95_mean_4C_sens %>% 
  rowwise() %>% 
  mutate(TSM_95 = predicted_CTmax - max_temp,
         TSM_95_se = predicted_CTmax_se,
         CTmax_95 = predicted_CTmax,
         CTmax_95_se = predicted_CTmax_se,
         max_temp_95 = max_temp,
         overheating_result_95 = list(calculate_overheating_probability(predicted_CTmax, predicted_CTmax_se, max_temp)), 
         overheating_probability_95 = overheating_result_95$prob_overheating, 
         overheating_risk_95 = ifelse(overheating_probability_95 > 0.5, 1, 0)) %>%   
  ungroup() %>% 
  dplyr::select(-overheating_result_95) 


# Combine data frames
pop_vulnerability_mean_4C_sens <- pop_vulnerability_mean_4C_sens %>%
  left_join(dplyr::select(pop_vulnerability_mean_4C_sens_95,
                          tip.label, 
                          lon, 
                          lat, 
                          TSM_95, 
                          TSM_95_se, 
                          CTmax_95, 
                          CTmax_95_se, 
                          max_temp_95,
                          overheating_probability_95,
                          overheating_risk_95), 
            by = c("tip.label", "lon", "lat"))

rm(pop_vulnerability_mean_4C_sens_95)

# Create a dataframe with only the max_temp for each population (minimum TSM)
pop_data_extreme_mean_4C_sens <- daily_CTmax_mean_4C  %>% 
  group_by(tip.label, lon, lat) %>%
  filter(max_temp == max(max_temp)) %>% 
  ungroup()

# Calculate TSM as the difference with the maximum temperature (most extreme TSM)
pop_vulnerability_extreme_mean_4C_sens <- pop_data_extreme_mean_4C_sens %>% 
  rowwise() %>% 
  mutate(TSM_extreme = predicted_CTmax - max_temp,
         TSM_extreme_se = predicted_CTmax_se,
         CTmax_extreme = predicted_CTmax,
         CTmax_extreme_se = predicted_CTmax_se,
         max_temp_extreme = max_temp,
         overheating_result_extreme = list(calculate_overheating_probability(predicted_CTmax, predicted_CTmax_se, max_temp)), 
         overheating_probability_extreme = overheating_result_extreme$prob_overheating, 
         overheating_risk_extreme = ifelse(overheating_probability_extreme > 0.5, 1, 0)) %>%   
  ungroup() %>% 
  dplyr::select(-overheating_result_extreme) 

# Join datasets
pop_vulnerability_mean_4C_sens <- pop_vulnerability_mean_4C_sens %>%
  left_join(dplyr::select(pop_vulnerability_extreme_mean_4C_sens,
                          tip.label, 
                          lon, 
                          lat, 
                          TSM_extreme, 
                          TSM_extreme_se, 
                          CTmax_extreme, 
                          CTmax_extreme_se, 
                          max_temp_extreme,
                          overheating_probability_extreme,
                          overheating_risk_extreme), 
            by = c("tip.label", "lon", "lat"))

## Add original coordinates
pop_vulnerability_mean_4C_sens   <- pop_vulnerability_mean_4C_sens  %>% 
  rename(lon_adj = lon, lat_adj = lat) %>% 
  mutate(lon_lat = paste(lon_adj, lat_adj)) 

distinct_coord <- readRDS("RData/General_data/distinct_coordinates_adjusted.rds")
distinct_coord <- distinct_coord %>% 
  dplyr::select(lon_adj = lon, lat_adj = lat, lon = x, lat = y) %>% 
  mutate(lon_lat = paste(lon_adj, lat_adj)) %>% 
  dplyr::select(-lon_adj, -lat_adj)

pop_vulnerability_mean_4C_sens  <- left_join(pop_vulnerability_mean_4C_sens , distinct_coord, by="lon_lat")
pop_vulnerability_mean_4C_sens  <- pop_vulnerability_mean_4C_sens  %>% 
  dplyr::select(-lon_lat)

saveRDS(pop_vulnerability_mean_4C_sens, file="RData/Climate_vulnerability/Pond/future4C/population_vulnerability_pond_mean_acc_future4C_sensitivity_analysis.rds")

######## Community-level patterns ################

community_vulnerability_mean_4C_sens <- pop_vulnerability_mean_4C_sens %>%
  mutate(TSM_weights = 1/(TSM_se^2),
         CTmax_weights = 1/(CTmax_se^2),
         TSM_extreme_weights = 1/(TSM_extreme_se^2),
         TSM_95_weights = 1/(TSM_95_se^2)) %>%
  group_by(lon, lat) %>%
  summarise(# ifelse statement is used here because in some locations, only one species is present.
    # Mean CTmax and maximum temperature at the community-level (weighted average and SE)
    community_CTmax = if_else(n() == 1, first(CTmax), sum(CTmax * CTmax_weights)/sum(CTmax_weights)), 
    community_CTmax_se = if_else(n() == 1, first(CTmax_se), sqrt(sum(CTmax_weights) * (n() - 1) / (((sum(CTmax_weights)^2) - (sum(CTmax_weights^2)))))),
    community_max_temp = first(max_temp), 
    community_max_temp_se = first(max_temp_se),
    # Mean TSM (weighted average and SE)
    community_TSM = if_else(n() == 1, first(TSM), sum(TSM * TSM_weights)/sum(TSM_weights)), 
    community_TSM_se = if_else(n() == 1, first(TSM_se), sqrt(sum(TSM_weights) * (n() - 1) / (((sum(TSM_weights)^2) - (sum(TSM_weights^2)))))),
    # Number of species
    n_species = n_distinct(tip.label), 
    # Number of species overheating
    n_species_overheating = sum(overheating_risk), 
    # Proportion of species overheating
    proportion_species_overheating = if_else(n() == 1, first(overheating_risk), mean(overheating_risk)), 
    proportion_species_overheating_se = if_else(n() == 1, 0, sd(overheating_risk)),
    # TSM calculated as the difference with the maximum body temperature 
    community_TSM_extreme = if_else(n() == 1, first(TSM_extreme), sum(TSM_extreme * TSM_extreme_weights)/sum(TSM_extreme_weights)), 
    community_TSM_extreme_se = if_else(n() == 1, first(TSM_extreme_se), sqrt(sum(TSM_extreme_weights) * (n() - 1) / (((sum(TSM_extreme_weights)^2) - (sum(TSM_extreme_weights^2)))))),
    # TSM calculated as the difference with the 95th percentile body temperature 
    community_TSM_95 = if_else(n() == 1, first(TSM_95), sum(TSM_95 * TSM_95_weights)/sum(TSM_95_weights)), 
    community_TSM_95_se = if_else(n() == 1, first(TSM_95_se), sqrt(sum(TSM_95_weights) * (n() - 1) / (((sum(TSM_95_weights)^2) - (sum(TSM_95_weights^2)))))),
    .groups = 'drop'
  )

saveRDS(community_vulnerability_mean_4C_sens, file="RData/Climate_vulnerability/Pond/future4C/community_vulnerability_pond_mean_acc_future4C_sensitivity_analysis.rds")
