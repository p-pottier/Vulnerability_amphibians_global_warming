pacman::p_load(devtools,
               NicheMapR, # devtools::install_github('mrke/NicheMapR')
               microclima, #devtools::install_github('ilyamaclean/microclima')
               tidyverse,
               purrr,
               raster,
               letsR,
               parallel,
               doParallel,
               ncdf4,
               RNetCDF,
               ncmeta,
               abind,
               ncdf4.helpers,
               curl,
               zoo,
               sf,
               viridis,
               rnaturalearth,
               rnaturalearthdata,
               mgcv,
               gamm4,
               mapproj,
               ape,
               phytools,
               MASS,
               brms,
               MCMCglmm,
               data.table,
               gridExtra,
               cowplot,
               metafor,
               future,
               future.apply,
               parallel)


results_imputation <- readRDS("RData/Imputation/results/imputation_5th_cycle.Rds")  

CTmax_data<- dplyr::select(results_imputation, CTmax=filled_mean_UTL5, lowerCI = lower_mean_UTL, upperCI=upper_mean_UTL, acclimation_temp, tip.label, imputed) # Select relevant columns

original_data<-dplyr::filter(CTmax_data, imputed=="no") # Original experimental data
imputed_data<-dplyr::filter(CTmax_data, imputed=="yes") # Imputed data

# Calculate standard error of each observation
imputed_data <- imputed_data %>% 
  mutate(se= (upperCI-CTmax)/1.96)

# Group data by species
species_data <- imputed_data %>%
  group_by(tip.label)

temp_species<- readRDS("RData/Biophysical_modelling/Pond/2C/species_daily_temp_warmest_days_pond_future2C.rds")
temp_species$tip.label <- gsub("_", " ", temp_species$tip.label)

temp_species$tip.label[temp_species$tip.label =="Scinax x signatus"] <- "Scinax x-signatus"
temp_species$tip.label[temp_species$tip.label =="Pristimantis w nigrum"] <- "Pristimantis w-nigrum"

saveRDS(temp_species, file="RData/Biophysical_modelling/Pond/2C/species_daily_temp_warmest_days_pond_future2C_adj.rds")

# Run meta-analytic models to calculate species-level ARR and intercept; and predict the CTmax of each day once acclimated to the mean weekly temperature

temp_species <- temp_species %>% dplyr::select(tip.label, lon, lat, YEAR, DOY, max_temp, mean_weekly_temp, max_weekly_temp)

## Create function
species_meta <- function(species_name, species_data, temp_species) {
  
  cat("Processing:", species_name, "\n")
  
  dat <- dplyr::filter(species_data, tip.label == species_name)
  dat2 <- dplyr::filter(temp_species, tip.label == species_name)
  
  # Fit a meta-analytic model
  fit <- metafor::rma(yi = CTmax, 
                      sei = se, 
                      mod = ~ acclimation_temp, 
                      data = dat)
  
  int_slope <- coef(fit)
  se <- fit$se
  
  cat("Get model coefficients:\n")
  coefs <- data.frame(tip.label = dat$tip.label,
                      intercept = coef(fit)[1],
                      intercept_se = fit$se[1],
                      slope = coef(fit)[2],
                      slope_se = fit$se[2])
  print(head(coefs))
  
  
  prediction_mean <- predict(fit, newmods = dat2$mean_weekly_temp)
  prediction_max <- predict(fit, newmods = dat2$max_weekly_temp)
  
  cat("Generate predictions, mean temp:\n")
  print(head(prediction_mean))
  cat("Generate predictions, max temp:\n")
  print(head(prediction_max))
  
  daily_CTmax_pond_mean_acc_future2C <- dplyr::select((cbind(dat2, cbind(predicted_CTmax = prediction_mean$pred, predicted_CTmax_se = prediction_mean$se))), -max_weekly_temp)
  daily_CTmax_pond_max_acc_future2C <- dplyr::select((cbind(dat2, cbind(predicted_CTmax = prediction_max$pred, predicted_CTmax_se = prediction_max$se))), -mean_weekly_temp)
  
  return(list(coefs, daily_CTmax_pond_mean_acc_future2C, daily_CTmax_pond_max_acc_future2C))
  
}

# Create chunks of 3 species at a time
species_list <- unique(species_data$tip.label)
chunk_size <- 3 
num_chunks <- ceiling(length(species_list) / chunk_size)

# Split the species list into chunks
chunk_species_list <- split(species_list, 
                            cut(1:length(species_list), 
                                breaks = num_chunks,
                                labels = FALSE))

# Now, create larger chunks of small chunks
# Running all chunks at once will require an enormous amount of RAM, so we proceed with 175 chunks at a time in 10 batches.
larger_chunk_size <- 175
num_larger_chunks <- ceiling(num_chunks / larger_chunk_size)

# Split the chunk list into larger chunks
larger_chunk_list <- split(chunk_species_list, cut(1:length(chunk_species_list), breaks = num_larger_chunks, labels = FALSE))


# Set up parallel processing 
cl <- makeCluster(16)

# Load packages on nodes
clusterEvalQ(cl, {
  library(dplyr)
  library(metafor)
})

# Check processing time
Sys.time()

# Processing for first larger chunk
current_larger_chunk <- larger_chunk_list[[1]]
result_list_1 <- list()

# Loop over the small chunks within the current larger chunk
for (i in seq_along(current_larger_chunk)) {
  current_species <- current_larger_chunk[[i]]
  
  # Filter data for only the species in the current chunk
  chunk_species_data <- dplyr::filter(species_data, tip.label %in% current_species)
  chunk_temp_species <- dplyr::filter(temp_species, tip.label %in% current_species)
  
  # Export only the filtered data and the current species list to the cluster
  clusterExport(cl, c("chunk_species_data", "chunk_temp_species", "current_species", "species_meta"))
  
  # Call species_meta for each species in the chunk
  result_chunk <- parallel::parLapply(cl, current_species, function(x) species_meta(x, chunk_species_data, chunk_temp_species))
  
  result_list_1 <- c(result_list_1, result_chunk)
}

species_ARR_pond_future2C_1 <- do.call(rbind, lapply(result_list_1, function(x) x[[1]]))
daily_CTmax_pond_mean_acc_future2C_1 <- do.call(rbind, lapply(result_list_1, function(x) x[[2]]))
daily_CTmax_pond_max_acc_future2C_1 <- do.call(rbind, lapply(result_list_1, function(x) x[[3]]))

rm(chunk_species_data)
rm(chunk_temp_species)
rm(result_chunk)
rm(result_list_1)

Sys.time()

# Save the results for first chunk
saveRDS(species_ARR_pond_future2C_1, file="RData/Climate_vulnerability/Pond/future2C/temp_files_ARR/species_ARR_pond_future2C_1st_chunk.rds")
saveRDS(daily_CTmax_pond_mean_acc_future2C_1, file="RData/Climate_vulnerability/Pond/future2C/temp_files_mean_acc/daily_CTmax_pond_mean_acc_future2C_1st_chunk.rds")
saveRDS(daily_CTmax_pond_max_acc_future2C_1, file="RData/Climate_vulnerability/Pond/future2C/temp_files_max_acc/daily_CTmax_pond_max_acc_future2C_1st_chunk.rds")

################################

Sys.time()

# Processing for second larger chunk
current_larger_chunk <- larger_chunk_list[[2]]
result_list_2 <- list()

# Loop over the small chunks within the current larger chunk
for (i in seq_along(current_larger_chunk)) {
  current_species <- current_larger_chunk[[i]]
  
  # Filter data for only the species in the current chunk
  chunk_species_data <- dplyr::filter(species_data, tip.label %in% current_species)
  chunk_temp_species <- dplyr::filter(temp_species, tip.label %in% current_species)
  
  # Export only the filtered data and the current species list to the cluster
  clusterExport(cl, c("chunk_species_data", "chunk_temp_species", "current_species", "species_meta"))
  
  # Call species_meta for each species in the chunk
  result_chunk <- parallel::parLapply(cl, current_species, function(x) species_meta(x, chunk_species_data, chunk_temp_species))
  
  result_list_2 <- c(result_list_2, result_chunk)
}

species_ARR_pond_future2C_2 <- do.call(rbind, lapply(result_list_2, function(x) x[[1]]))
daily_CTmax_pond_mean_acc_future2C_2 <- do.call(rbind, lapply(result_list_2, function(x) x[[2]]))
daily_CTmax_pond_max_acc_future2C_2 <- do.call(rbind, lapply(result_list_2, function(x) x[[3]]))

rm(chunk_species_data)
rm(chunk_temp_species)
rm(result_chunk)
rm(result_list_2)

Sys.time()

# Save the results for first chunk
saveRDS(species_ARR_pond_future2C_2, file="RData/Climate_vulnerability/Pond/future2C/temp_files_ARR/species_ARR_pond_future2C_2nd_chunk.rds")
saveRDS(daily_CTmax_pond_mean_acc_future2C_2, file="RData/Climate_vulnerability/Pond/future2C/temp_files_mean_acc/daily_CTmax_pond_mean_acc_future2C_2nd_chunk.rds")
saveRDS(daily_CTmax_pond_max_acc_future2C_2, file="RData/Climate_vulnerability/Pond/future2C/temp_files_max_acc/daily_CTmax_pond_max_acc_future2C_2nd_chunk.rds")

###################

Sys.time()

# Processing for second larger chunk
current_larger_chunk <- larger_chunk_list[[3]]
result_list_3 <- list()

# Loop over the small chunks within the current larger chunk
for (i in seq_along(current_larger_chunk)) {
  current_species <- current_larger_chunk[[i]]
  
  # Filter data for only the species in the current chunk
  chunk_species_data <- dplyr::filter(species_data, tip.label %in% current_species)
  chunk_temp_species <- dplyr::filter(temp_species, tip.label %in% current_species)
  
  # Export only the filtered data and the current species list to the cluster
  clusterExport(cl, c("chunk_species_data", "chunk_temp_species", "current_species", "species_meta"))
  
  # Call species_meta for each species in the chunk
  result_chunk <- parallel::parLapply(cl, current_species, function(x) species_meta(x, chunk_species_data, chunk_temp_species))
  
  result_list_3 <- c(result_list_3, result_chunk)
}

species_ARR_pond_future2C_3 <- do.call(rbind, lapply(result_list_3, function(x) x[[1]]))
daily_CTmax_pond_mean_acc_future2C_3 <- do.call(rbind, lapply(result_list_3, function(x) x[[2]]))
daily_CTmax_pond_max_acc_future2C_3 <- do.call(rbind, lapply(result_list_3, function(x) x[[3]]))

rm(chunk_species_data)
rm(chunk_temp_species)
rm(result_chunk)
rm(result_list_3)

Sys.time()

# Save the results for first chunk
saveRDS(species_ARR_pond_future2C_3, file="RData/Climate_vulnerability/Pond/future2C/temp_files_ARR/species_ARR_pond_future2C_3rd_chunk.rds")
saveRDS(daily_CTmax_pond_mean_acc_future2C_3, file="RData/Climate_vulnerability/Pond/future2C/temp_files_mean_acc/daily_CTmax_pond_mean_acc_future2C_3rd_chunk.rds")
saveRDS(daily_CTmax_pond_max_acc_future2C_3, file="RData/Climate_vulnerability/Pond/future2C/temp_files_max_acc/daily_CTmax_pond_max_acc_future2C_3rd_chunk.rds")

######################

Sys.time()

# Processing for second larger chunk
current_larger_chunk <- larger_chunk_list[[4]]
result_list_4 <- list()

# Loop over the small chunks within the current larger chunk
for (i in seq_along(current_larger_chunk)) {
  current_species <- current_larger_chunk[[i]]
  
  # Filter data for only the species in the current chunk
  chunk_species_data <- dplyr::filter(species_data, tip.label %in% current_species)
  chunk_temp_species <- dplyr::filter(temp_species, tip.label %in% current_species)
  
  # Export only the filtered data and the current species list to the cluster
  clusterExport(cl, c("chunk_species_data", "chunk_temp_species", "current_species", "species_meta"))
  
  # Call species_meta for each species in the chunk
  result_chunk <- parallel::parLapply(cl, current_species, function(x) species_meta(x, chunk_species_data, chunk_temp_species))
  
  result_list_4 <- c(result_list_4, result_chunk)
}

species_ARR_pond_future2C_4 <- do.call(rbind, lapply(result_list_4, function(x) x[[1]]))
daily_CTmax_pond_mean_acc_future2C_4 <- do.call(rbind, lapply(result_list_4, function(x) x[[2]]))
daily_CTmax_pond_max_acc_future2C_4 <- do.call(rbind, lapply(result_list_4, function(x) x[[3]]))

rm(chunk_species_data)
rm(chunk_temp_species)
rm(result_chunk)
rm(result_list_4)

Sys.time()

# Save the results for first chunk
saveRDS(species_ARR_pond_future2C_4, file="RData/Climate_vulnerability/Pond/future2C/temp_files_ARR/species_ARR_pond_future2C_4th_chunk.rds")
saveRDS(daily_CTmax_pond_mean_acc_future2C_4, file="RData/Climate_vulnerability/Pond/future2C/temp_files_mean_acc/daily_CTmax_pond_mean_acc_future2C_4th_chunk.rds")
saveRDS(daily_CTmax_pond_max_acc_future2C_4, file="RData/Climate_vulnerability/Pond/future2C/temp_files_max_acc/daily_CTmax_pond_max_acc_future2C_4th_chunk.rds")

######################

Sys.time()

# Processing for second larger chunk
current_larger_chunk <- larger_chunk_list[[5]]
result_list_5 <- list()

# Loop over the small chunks within the current larger chunk
for (i in seq_along(current_larger_chunk)) {
  current_species <- current_larger_chunk[[i]]
  
  # Filter data for only the species in the current chunk
  chunk_species_data <- dplyr::filter(species_data, tip.label %in% current_species)
  chunk_temp_species <- dplyr::filter(temp_species, tip.label %in% current_species)
  
  # Export only the filtered data and the current species list to the cluster
  clusterExport(cl, c("chunk_species_data", "chunk_temp_species", "current_species", "species_meta"))
  
  # Call species_meta for each species in the chunk
  result_chunk <- parallel::parLapply(cl, current_species, function(x) species_meta(x, chunk_species_data, chunk_temp_species))
  
  result_list_5 <- c(result_list_5, result_chunk)
}

species_ARR_pond_future2C_5 <- do.call(rbind, lapply(result_list_5, function(x) x[[1]]))
daily_CTmax_pond_mean_acc_future2C_5 <- do.call(rbind, lapply(result_list_5, function(x) x[[2]]))
daily_CTmax_pond_max_acc_future2C_5 <- do.call(rbind, lapply(result_list_5, function(x) x[[3]]))

rm(chunk_species_data)
rm(chunk_temp_species)
rm(result_chunk)
rm(result_list_5)

Sys.time()

# Save the results for first chunk
saveRDS(species_ARR_pond_future2C_5, file="RData/Climate_vulnerability/Pond/future2C/temp_files_ARR/species_ARR_pond_future2C_5th_chunk.rds")
saveRDS(daily_CTmax_pond_mean_acc_future2C_5, file="RData/Climate_vulnerability/Pond/future2C/temp_files_mean_acc/daily_CTmax_pond_mean_acc_future2C_5th_chunk.rds")
saveRDS(daily_CTmax_pond_max_acc_future2C_5, file="RData/Climate_vulnerability/Pond/future2C/temp_files_max_acc/daily_CTmax_pond_max_acc_future2C_5th_chunk.rds")

######################

Sys.time()

# Processing for second larger chunk
current_larger_chunk <- larger_chunk_list[[6]]
result_list_6 <- list()

# Loop over the small chunks within the current larger chunk
for (i in seq_along(current_larger_chunk)) {
  current_species <- current_larger_chunk[[i]]
  
  # Filter data for only the species in the current chunk
  chunk_species_data <- dplyr::filter(species_data, tip.label %in% current_species)
  chunk_temp_species <- dplyr::filter(temp_species, tip.label %in% current_species)
  
  # Export only the filtered data and the current species list to the cluster
  clusterExport(cl, c("chunk_species_data", "chunk_temp_species", "current_species", "species_meta"))
  
  # Call species_meta for each species in the chunk
  result_chunk <- parallel::parLapply(cl, current_species, function(x) species_meta(x, chunk_species_data, chunk_temp_species))
  
  result_list_6 <- c(result_list_6, result_chunk)
}

species_ARR_pond_future2C_6 <- do.call(rbind, lapply(result_list_6, function(x) x[[1]]))
daily_CTmax_pond_mean_acc_future2C_6 <- do.call(rbind, lapply(result_list_6, function(x) x[[2]]))
daily_CTmax_pond_max_acc_future2C_6 <- do.call(rbind, lapply(result_list_6, function(x) x[[3]]))

rm(chunk_species_data)
rm(chunk_temp_species)
rm(result_chunk)
rm(result_list_6)

Sys.time()

# Save the results for first chunk
saveRDS(species_ARR_pond_future2C_6, file="RData/Climate_vulnerability/Pond/future2C/temp_files_ARR/species_ARR_pond_future2C_6th_chunk.rds")
saveRDS(daily_CTmax_pond_mean_acc_future2C_6, file="RData/Climate_vulnerability/Pond/future2C/temp_files_mean_acc/daily_CTmax_pond_mean_acc_future2C_6th_chunk.rds")
saveRDS(daily_CTmax_pond_max_acc_future2C_6, file="RData/Climate_vulnerability/Pond/future2C/temp_files_max_acc/daily_CTmax_pond_max_acc_future2C_6th_chunk.rds")

######################

Sys.time()

# Processing for second larger chunk
current_larger_chunk <- larger_chunk_list[[7]]
result_list_7 <- list()

# Loop over the small chunks within the current larger chunk
for (i in seq_along(current_larger_chunk)) {
  current_species <- current_larger_chunk[[i]]
  
  # Filter data for only the species in the current chunk
  chunk_species_data <- dplyr::filter(species_data, tip.label %in% current_species)
  chunk_temp_species <- dplyr::filter(temp_species, tip.label %in% current_species)
  
  # Export only the filtered data and the current species list to the cluster
  clusterExport(cl, c("chunk_species_data", "chunk_temp_species", "current_species", "species_meta"))
  
  # Call species_meta for each species in the chunk
  result_chunk <- parallel::parLapply(cl, current_species, function(x) species_meta(x, chunk_species_data, chunk_temp_species))
  
  result_list_7 <- c(result_list_7, result_chunk)
}

species_ARR_pond_future2C_7 <- do.call(rbind, lapply(result_list_7, function(x) x[[1]]))
daily_CTmax_pond_mean_acc_future2C_7 <- do.call(rbind, lapply(result_list_7, function(x) x[[2]]))
daily_CTmax_pond_max_acc_future2C_7 <- do.call(rbind, lapply(result_list_7, function(x) x[[3]]))

rm(chunk_species_data)
rm(chunk_temp_species)
rm(result_chunk)
rm(result_list_7)

Sys.time()

# Save the results for first chunk
saveRDS(species_ARR_pond_future2C_7, file="RData/Climate_vulnerability/Pond/future2C/temp_files_ARR/species_ARR_pond_future2C_7th_chunk.rds")
saveRDS(daily_CTmax_pond_mean_acc_future2C_7, file="RData/Climate_vulnerability/Pond/future2C/temp_files_mean_acc/daily_CTmax_pond_mean_acc_future2C_7th_chunk.rds")
saveRDS(daily_CTmax_pond_max_acc_future2C_7, file="RData/Climate_vulnerability/Pond/future2C/temp_files_max_acc/daily_CTmax_pond_max_acc_future2C_7th_chunk.rds")

######################

Sys.time()

# Processing for second larger chunk
current_larger_chunk <- larger_chunk_list[[8]]
result_list_8 <- list()

# Loop over the small chunks within the current larger chunk
for (i in seq_along(current_larger_chunk)) {
  current_species <- current_larger_chunk[[i]]
  
  # Filter data for only the species in the current chunk
  chunk_species_data <- dplyr::filter(species_data, tip.label %in% current_species)
  chunk_temp_species <- dplyr::filter(temp_species, tip.label %in% current_species)
  
  # Export only the filtered data and the current species list to the cluster
  clusterExport(cl, c("chunk_species_data", "chunk_temp_species", "current_species", "species_meta"))
  
  # Call species_meta for each species in the chunk
  result_chunk <- parallel::parLapply(cl, current_species, function(x) species_meta(x, chunk_species_data, chunk_temp_species))
  
  result_list_8 <- c(result_list_8, result_chunk)
}

species_ARR_pond_future2C_8 <- do.call(rbind, lapply(result_list_8, function(x) x[[1]]))
daily_CTmax_pond_mean_acc_future2C_8 <- do.call(rbind, lapply(result_list_8, function(x) x[[2]]))
daily_CTmax_pond_max_acc_future2C_8 <- do.call(rbind, lapply(result_list_8, function(x) x[[3]]))

rm(chunk_species_data)
rm(chunk_temp_species)
rm(result_chunk)
rm(result_list_8)

Sys.time()

# Save the results for first chunk
saveRDS(species_ARR_pond_future2C_8, file="RData/Climate_vulnerability/Pond/future2C/temp_files_ARR/species_ARR_pond_future2C_8th_chunk.rds")
saveRDS(daily_CTmax_pond_mean_acc_future2C_8, file="RData/Climate_vulnerability/Pond/future2C/temp_files_mean_acc/daily_CTmax_pond_mean_acc_future2C_8th_chunk.rds")
saveRDS(daily_CTmax_pond_max_acc_future2C_8, file="RData/Climate_vulnerability/Pond/future2C/temp_files_max_acc/daily_CTmax_pond_max_acc_future2C_8th_chunk.rds")

######################

Sys.time()

# Processing for second larger chunk
current_larger_chunk <- larger_chunk_list[[9]]
result_list_9 <- list()

# Loop over the small chunks within the current larger chunk
for (i in seq_along(current_larger_chunk)) {
  current_species <- current_larger_chunk[[i]]
  
  # Filter data for only the species in the current chunk
  chunk_species_data <- dplyr::filter(species_data, tip.label %in% current_species)
  chunk_temp_species <- dplyr::filter(temp_species, tip.label %in% current_species)
  
  # Export only the filtered data and the current species list to the cluster
  clusterExport(cl, c("chunk_species_data", "chunk_temp_species", "current_species", "species_meta"))
  
  # Call species_meta for each species in the chunk
  result_chunk <- parallel::parLapply(cl, current_species, function(x) species_meta(x, chunk_species_data, chunk_temp_species))
  
  result_list_9 <- c(result_list_9, result_chunk)
}

species_ARR_pond_future2C_9 <- do.call(rbind, lapply(result_list_9, function(x) x[[1]]))
daily_CTmax_pond_mean_acc_future2C_9 <- do.call(rbind, lapply(result_list_9, function(x) x[[2]]))
daily_CTmax_pond_max_acc_future2C_9 <- do.call(rbind, lapply(result_list_9, function(x) x[[3]]))

rm(chunk_species_data)
rm(chunk_temp_species)
rm(result_chunk)
rm(result_list_9)

Sys.time()

# Save the results for first chunk
saveRDS(species_ARR_pond_future2C_9, file="RData/Climate_vulnerability/Pond/future2C/temp_files_ARR/species_ARR_pond_future2C_9th_chunk.rds")
saveRDS(daily_CTmax_pond_mean_acc_future2C_9, file="RData/Climate_vulnerability/Pond/future2C/temp_files_mean_acc/daily_CTmax_pond_mean_acc_future2C_9th_chunk.rds")
saveRDS(daily_CTmax_pond_max_acc_future2C_9, file="RData/Climate_vulnerability/Pond/future2C/temp_files_max_acc/daily_CTmax_pond_max_acc_future2C_9th_chunk.rds")

######################

Sys.time()

# Processing for second larger chunk
current_larger_chunk <- larger_chunk_list[[10]]
result_list_10 <- list()

# Loop over the small chunks within the current larger chunk
for (i in seq_along(current_larger_chunk)) {
  current_species <- current_larger_chunk[[i]]
  
  # Filter data for only the species in the current chunk
  chunk_species_data <- dplyr::filter(species_data, tip.label %in% current_species)
  chunk_temp_species <- dplyr::filter(temp_species, tip.label %in% current_species)
  
  # Export only the filtered data and the current species list to the cluster
  clusterExport(cl, c("chunk_species_data", "chunk_temp_species", "current_species", "species_meta"))
  
  # Call species_meta for each species in the chunk
  result_chunk <- parallel::parLapply(cl, current_species, function(x) species_meta(x, chunk_species_data, chunk_temp_species))
  
  result_list_10 <- c(result_list_10, result_chunk)
}

species_ARR_pond_future2C_10 <- do.call(rbind, lapply(result_list_10, function(x) x[[1]]))
daily_CTmax_pond_mean_acc_future2C_10 <- do.call(rbind, lapply(result_list_10, function(x) x[[2]]))
daily_CTmax_pond_max_acc_future2C_10 <- do.call(rbind, lapply(result_list_10, function(x) x[[3]]))

rm(chunk_species_data)
rm(chunk_temp_species)
rm(result_chunk)
rm(result_list_10)

Sys.time()

# Save the results for first chunk
saveRDS(species_ARR_pond_future2C_10, file="RData/Climate_vulnerability/Pond/future2C/temp_files_ARR/species_ARR_pond_future2C_10th_chunk.rds")
saveRDS(daily_CTmax_pond_mean_acc_future2C_10, file="RData/Climate_vulnerability/Pond/future2C/temp_files_mean_acc/daily_CTmax_pond_mean_acc_future2C_10th_chunk.rds")
saveRDS(daily_CTmax_pond_max_acc_future2C_10, file="RData/Climate_vulnerability/Pond/future2C/temp_files_max_acc/daily_CTmax_pond_max_acc_future2C_10th_chunk.rds")

######################

# Stop the cluster
stopCluster(cl)
gc()

# Combine results from all chunks and save 

species_ARR_pond_future2C <- distinct(rbind(species_ARR_pond_future2C_1,
                                                 species_ARR_pond_future2C_2,
                                                 species_ARR_pond_future2C_3,
                                                 species_ARR_pond_future2C_4,
                                                 species_ARR_pond_future2C_5,
                                                 species_ARR_pond_future2C_6,
                                                 species_ARR_pond_future2C_7,
                                                 species_ARR_pond_future2C_8,
                                                 species_ARR_pond_future2C_9,
                                                 species_ARR_pond_future2C_10))

daily_CTmax_pond_mean_acc_future2C <- rbind(daily_CTmax_pond_mean_acc_future2C_1,
                                                 daily_CTmax_pond_mean_acc_future2C_2,
                                                 daily_CTmax_pond_mean_acc_future2C_3,
                                                 daily_CTmax_pond_mean_acc_future2C_4,
                                                 daily_CTmax_pond_mean_acc_future2C_5,
                                                 daily_CTmax_pond_mean_acc_future2C_6,
                                                 daily_CTmax_pond_mean_acc_future2C_7,
                                                 daily_CTmax_pond_mean_acc_future2C_8,
                                                 daily_CTmax_pond_mean_acc_future2C_9,
                                                 daily_CTmax_pond_mean_acc_future2C_10)

daily_CTmax_pond_max_acc_future2C <- rbind(daily_CTmax_pond_max_acc_future2C_1,
                                                daily_CTmax_pond_max_acc_future2C_2,
                                                daily_CTmax_pond_max_acc_future2C_3,
                                                daily_CTmax_pond_max_acc_future2C_4,
                                                daily_CTmax_pond_max_acc_future2C_5,
                                                daily_CTmax_pond_max_acc_future2C_6,
                                                daily_CTmax_pond_max_acc_future2C_7,
                                                daily_CTmax_pond_max_acc_future2C_8,
                                                daily_CTmax_pond_max_acc_future2C_9,
                                                daily_CTmax_pond_max_acc_future2C_10)


saveRDS(species_ARR_pond_future2C, file="RData/Climate_vulnerability/Pond/future2C/species_ARR_pond_future2C.rds")
saveRDS(daily_CTmax_pond_mean_acc_future2C, file="RData/Climate_vulnerability/Pond/future2C/daily_CTmax_pond_mean_acc_future2C.rds")
saveRDS(daily_CTmax_pond_max_acc_future2C, file="RData/Climate_vulnerability/Pond/future2C/daily_CTmax_pond_max_acc_future2C.rds")
