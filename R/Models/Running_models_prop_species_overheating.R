
# Load packages
pacman::p_load(tidyverse, 
               mgcv,
               gamm4,
               future,
               future.apply, 
               furrr,
               futile.logger,
               MCMCglmm,
               ape,
               phytools,
               lmerTest,
               ggeffects,
               emmeans)

# Load community-level data
community_sub_current <- readRDS("RData/Climate_vulnerability/Substrate/current/community_vulnerability_substrate_mean_acc_current.rds")
community_sub_future2C <- readRDS("RData/Climate_vulnerability/Substrate/future2C/community_vulnerability_substrate_mean_acc_future2C.rds")
community_sub_future4C <- readRDS("RData/Climate_vulnerability/Substrate/future4C/community_vulnerability_substrate_mean_acc_future4C.rds")

community_arb_current <- readRDS("RData/Climate_vulnerability/Arboreal/current/community_vulnerability_arboreal_mean_acc_current.rds")
community_arb_future2C <- readRDS("RData/Climate_vulnerability/Arboreal/future2C/community_vulnerability_arboreal_mean_acc_future2C.rds")
community_arb_future4C <- readRDS("RData/Climate_vulnerability/Arboreal/future4C/community_vulnerability_arboreal_mean_acc_future4C.rds")

# Function to run models estimating the mean overheating risk (i.e., proportion of species overheating) 
run_community_proportion_overheating_analysis <- function(dataset, habitat_scenario) {
  
  data <- dataset
  
  # Run model
  model <- gamm4::gamm4(proportion_species_overheating ~ s(lat, bs = "tp"),
                        data = data,
                        weights = data$n_species,
                        family = binomial(),
                        REML = TRUE)
  
  # Generate data set for predictions
  new_data <- data.frame(
    lat = seq(min(data$lat), max(data$lat), length = 1000),
    proportion_species_overheating = NA, 
    n_species = NA)
  
  # Predict for each latitude value
  pred <- predict(model$gam, newdata = new_data, type = "response", se.fit = TRUE)
  new_data$overheating_risk_pred <- pred$fit
  new_data$overheating_risk_pred_se <- pred$se.fit
  
  # Calculate 95% confidence intervals
  new_data <- mutate(new_data, 
                     upper = overheating_risk_pred + 1.96 * overheating_risk_pred_se,
                     lower = overheating_risk_pred - 1.96 * overheating_risk_pred_se)
  
  # Model summaries 
  summary_gam <- capture.output(summary(model$gam)) # Generalised additive model
  summary_mer <- capture.output(summary(model$mer)) # Mixed effect regression
  
  # Save model and predictions
  saveRDS(summary_gam, file = paste0("RData/Models/prop_species_overheating/summary_GAM_community_lat_proportion_sp_overheating_", habitat_scenario, ".rds"))
  saveRDS(summary_mer, file = paste0("RData/Models/prop_species_overheating/summary_MER_community_lat_proportion_sp_overheating_", habitat_scenario, ".rds"))
  saveRDS(new_data, file = paste0("RData/Models/prop_species_overheating/predictions_community_lat_proportion_sp_overheating_", habitat_scenario, ".rds"))
}


# Create a list of datasets
dataset_list <- list(
  arboreal_current = community_arb_current,
  arboreal_future2C = community_arb_future2C,
  arboreal_future4C = community_arb_future4C,
  substrate_current = community_sub_current,
  substrate_future2C = community_sub_future2C,
  substrate_future4C = community_sub_future4C
)

# Set up parallel processing
plan(multicore(workers=3))

# Run function
results <- future_lapply(
  names(dataset_list), 
  function(x) {run_community_proportion_overheating_analysis(dataset_list[[x]], x)},
  future.packages = c("gamm4", "mgcv", "dplyr")
)

########################################
# Run analyses with lme4 to get mean estimates in each microhabitat and scenario
## We could not estimate those using MCMCglmm - the model did not mix, even after increasing iterations. 

all_community_data <- bind_rows(
  community_sub_current %>% mutate(habitat_scenario = "substrate_current"), 
  community_sub_future2C %>% mutate(habitat_scenario = "substrate_future2C"), 
  community_sub_future4C %>% mutate(habitat_scenario = "substrate_future4C"), 
  community_arb_current %>% mutate(habitat_scenario = "arboreal_current"), 
  community_arb_future2C %>% mutate(habitat_scenario = "arboreal_future2C"), 
  community_arb_future4C %>% mutate(habitat_scenario = "arboreal_future4C")
)

all_community_data <- all_community_data %>% mutate(obs = as.character(row_number()))

all_community_data <- as.data.frame(all_community_data)

set.seed(123)

# Intercept-less model 
model_prop <- glmer(proportion_species_overheating ~ habitat_scenario - 1 + (1 |obs), 
                    family = "binomial",
                    weights = n_species,
                    control = glmerControl(optimizer = "bobyqa",
                                            optCtrl = list(maxfun = 1000000000)),
                    data = all_community_data)



# Get predictions
predictions <- as.data.frame(ggpredict(model_prop, 
                                       terms = "habitat_scenario", 
                                       type = "random", 
                                       interval = "confidence", 
                                       nsim = 1000))

predictions <- predictions %>% rename(habitat_scenario = x, 
                                      prediction = predicted,
                                      se = std.error, 
                                      lower_CI = conf.low, 
                                      upper_CI = conf.high) %>% dplyr::select(-group)

# Save model summaries and predictions
saveRDS(model_prop, file = "RData/Models/prop_species_overheating/model_lme4_prop_species_overheating.rds")
saveRDS(predictions, file = "RData/Models/prop_species_overheating/predictions_lme4_prop_species_overheating.rds")


###### Contrasts 
all_community_data$habitat_scenario <- as.factor(all_community_data$habitat_scenario)

# Run model
model_prop_contrast <- glmer(proportion_species_overheating ~ relevel(habitat_scenario, ref = "substrate_current") + (1 |obs), 
                             family = "binomial",
                             weights = n_species,
                             control = glmerControl(optimizer = "bobyqa",
                                                    optCtrl = list(maxfun = 1000000000)),
                             data = all_community_data)
# Save model
saveRDS(model_prop_contrast, file = "RData/Models/prop_species_overheating/model_lme4_prop_species_overheating_contrast.rds")

##############################################
### Subset of overheating communities ### 

# Filter to overheating communities 
all_community_data <- filter(all_community_data, n_species_overheating > 0)

# Run model
# Intercept-less model 
model_prop_overheating_communities <- glmer(proportion_species_overheating ~ habitat_scenario - 1 + (1 |obs), 
                                            family = "binomial",
                                            weights = n_species,
                                            control = glmerControl(optimizer = "bobyqa",
                                                                   optCtrl = list(maxfun = 1000000000)),
                                            data = all_community_data)



# Get predictions
predictions_overheating_communities <- as.data.frame(ggpredict(model_prop_overheating_communities, 
                                                              terms = "habitat_scenario", 
                                                              type = "random", 
                                                              interval = "confidence", 
                                                              nsim = 1000))

predictions_overheating_communities <- predictions_overheating_communities %>% rename(habitat_scenario = x, 
                                      prediction = predicted,
                                      se = std.error, 
                                      lower_CI = conf.low, 
                                      upper_CI = conf.high) %>% dplyr::select(-group)


# Save model summaries and predictions
saveRDS(model_prop_overheating_communities, file = "RData/Models/prop_species_overheating/model_lme4_prop_species_overheating_overheating_communities.rds")
saveRDS(predictions_overheating_communities, file = "RData/Models/prop_species_overheating/predictions_lme4_prop_species_overheating_overheating_communities.rds")
