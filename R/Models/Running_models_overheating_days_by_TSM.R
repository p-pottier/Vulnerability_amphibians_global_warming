
# Load packages
pacman::p_load(tidyverse, 
               mgcv,
               gamm4,
               future,
               future.apply, 
               furrr,
               futile.logger,
               MCMCglmm,
               ape,
               phytools,
               lmerTest,
               ggeffects,
               emmeans)

# Load population-level data

## Substrate
pop_sub_current <- readRDS("RData/Climate_vulnerability/Substrate/current/population_vulnerability_substrate_mean_acc_current.rds")
pop_sub_future2C <- readRDS("RData/Climate_vulnerability/Substrate/future2C/population_vulnerability_substrate_mean_acc_future2C.rds")
pop_sub_future4C <- readRDS("RData/Climate_vulnerability/Substrate/future4C/population_vulnerability_substrate_mean_acc_future4C.rds")

## Arboreal
pop_arb_current <- readRDS("RData/Climate_vulnerability/Arboreal/current/population_vulnerability_arboreal_mean_acc_current.rds")
pop_arb_future2C <- readRDS("RData/Climate_vulnerability/Arboreal/future2C/population_vulnerability_arboreal_mean_acc_future2C.rds")
pop_arb_future4C <- readRDS("RData/Climate_vulnerability/Arboreal/future4C/population_vulnerability_arboreal_mean_acc_future4C.rds")


# Function to run the MCMCglmm for each habitat scenario
run_model <- function(dataset, habitat_scenario) {
  
  split_names <- strsplit(as.character(dataset$tip.label), ' ')
  dataset$genus <- sapply(split_names, `[`, 1)
  dataset$species <- sapply(split_names, `[`, 2)
  
  dataset <- dataset %>% mutate(obs = as.character(row_number()))
  
  data <- dataset
  
  # Set the seed for reproducibility
  set.seed(123)
  
  # Fit the model
  model <-  glmer(overheating_days ~ TSM + (1|genus/species/obs), 
                  family = "poisson",
                  control = glmerControl(optimizer = "bobyqa",
                                         optCtrl = list(maxfun = 1000000000)),
                  data = data)
  
  # Get predictions
  predictions <- data.frame(emmeans(model, 
                                    specs = "TSM", 
                                    data = data, 
                                    at = list(TSM = seq(min(data$TSM), max(data$TSM), length=100)), 
                                    type="response"))
  
  predictions <- predictions %>% rename(prediction = rate)
                               
  saveRDS(model, file = paste0("RData/Models/overheating_days/model_lme4_overheating_days_by_TSM_", habitat_scenario, ".rds"))
  saveRDS(predictions, file = paste0("RData/Models/overheating_days/predictions_lme4_overheating_days_by_TSM_", habitat_scenario, ".rds"))
}

dataset_list <- list(substrate_current = pop_sub_current, 
                     substrate_future2C = pop_sub_future2C,
                     substrate_future4C = pop_sub_future4C, 
                     arboreal_current = pop_arb_current, 
                     arboreal_future2C = pop_arb_future2C,
                     arboreal_future4C = pop_arb_future4C)

plan(sequential)

results <- future_lapply(names(dataset_list), function(x) {
  run_model(dataset_list[[x]], x)
}, future.packages = c("lme4", "emmeans", "ggeffects", "dplyr"))
