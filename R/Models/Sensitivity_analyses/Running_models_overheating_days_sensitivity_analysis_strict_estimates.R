
# Load packages
pacman::p_load(tidyverse, 
               mgcv,
               gamm4,
               future,
               future.apply, 
               furrr,
               futile.logger,
               lme4,
               ape,
               phytools,
               lmerTest,
               emmeans,
               ggeffects)

# Load population-level data
## Substrate
pop_sub_current <- readRDS("RData/Climate_vulnerability/Substrate/current/population_vulnerability_substrate_mean_acc_current.rds")
pop_sub_future2C <- readRDS("RData/Climate_vulnerability/Substrate/future2C/population_vulnerability_substrate_mean_acc_future2C.rds")
pop_sub_future4C <- readRDS("RData/Climate_vulnerability/Substrate/future4C/population_vulnerability_substrate_mean_acc_future4C.rds")

## Arboreal
pop_arb_current <- readRDS("RData/Climate_vulnerability/Arboreal/current/population_vulnerability_arboreal_mean_acc_current.rds")
pop_arb_future2C <- readRDS("RData/Climate_vulnerability/Arboreal/future2C/population_vulnerability_arboreal_mean_acc_future2C.rds")
pop_arb_future4C <- readRDS("RData/Climate_vulnerability/Arboreal/future4C/population_vulnerability_arboreal_mean_acc_future4C.rds")

## We do not load pond data because none of the species overheat in water bodies


####################### Sensitivity analyses #############################

# Here we only consider overheating events when maximum temperatures exceed 50% of the predicted distribution of CTmax

# Function to run population-level overheating_days models in parallel (sensitivity analysis, 50%)
run_overheating_days_analysis_strict50 <- function(dataset, habitat_scenario) {
  
  split_names <- strsplit(as.character(dataset$tip.label), ' ')
  dataset$genus <- sapply(split_names, `[`, 1)
  dataset$species <- sapply(split_names, `[`, 2)
  
  data <- dataset 
  
  # Run model
  model <- gamm4::gamm4(overheating_days_strict50 ~ s(lat, bs = "tp"), 
                        random = ~  (1 | genus/species),
                        data = data,
                        family = poisson(),
                        REML = TRUE)
  
  # Generate data set for predictions
  new_data <- data.frame(
    lat = seq(min(data$lat), max(data$lat), length = 1000),
    overheating_days_strict50 = NA, 
    genus = NA, 
    species = NA)
  
  # Predict for each latitude value
  pred <- predict(model$gam, newdata = new_data, type = "response", se.fit = TRUE)
  new_data$overheating_days_pred <- pred$fit
  new_data$overheating_days_pred_se <- pred$se.fit
  
  # Calculate 95% confidence intervals
  new_data <- mutate(new_data, 
                     upper = overheating_days_pred + 1.96 * overheating_days_pred_se,
                     lower = overheating_days_pred - 1.96 * overheating_days_pred_se)
  
  # Model summaries 
  summary_gam <- capture.output(summary(model$gam)) # Generalised additive model
  summary_mer <- capture.output(summary(model$mer)) # Mixed effect regression
  
  # Save model and predictions
  saveRDS(summary_gam, file = paste0("RData/Models/overheating_days/sensitivity_analyses/summary_GAM_lat_overheating_days_strict50_", habitat_scenario, ".rds"))
  saveRDS(summary_mer, file = paste0("RData/Models/overheating_days/sensitivity_analyses/summary_MER_lat_overheating_days_strict50_", habitat_scenario, ".rds"))
  saveRDS(new_data, file = paste0("RData/Models/overheating_days/sensitivity_analyses/predictions_pop_lat_overheating_days_strict50_", habitat_scenario, ".rds"))
}

# Create a list of all the datasets
dataset_list <- list(
  arboreal_current = pop_arb_current,
  arboreal_future2C = pop_arb_future2C,
  arboreal_future4C = pop_arb_future4C,
  substrate_current = pop_sub_current,
  substrate_future2C = pop_sub_future2C,
  substrate_future4C = pop_sub_future4C
)

plan(sequential)

# Run function
results <- future_lapply(
  names(dataset_list), 
  function(x) {run_overheating_days_analysis_strict50(dataset_list[[x]], x)},
  future.packages = c("gamm4", "mgcv", "dplyr")
)



########################################
# Run analyses with lme4 to estimate mean estimates in each microhabitat and scenario

all_data <- bind_rows(
  pop_sub_current %>% mutate(habitat_scenario = "substrate_current"), 
  pop_sub_future2C %>% mutate(habitat_scenario = "substrate_future2C"), 
  pop_sub_future4C %>% mutate(habitat_scenario = "substrate_future4C"), 
  pop_arb_current %>% mutate(habitat_scenario = "arboreal_current"), 
  pop_arb_future2C %>% mutate(habitat_scenario = "arboreal_future2C"), 
  pop_arb_future4C %>% mutate(habitat_scenario = "arboreal_future4C")
)
# Load training data for taxonomic information
training_data <- readRDS("RData/General_data/pre_data_for_imputation.rds")
training_data <- dplyr::select(training_data, tip.label, family)

all_data <- distinct(left_join(all_data, training_data, by="tip.label"))

split_names <- strsplit(as.character(all_data$tip.label), ' ')
all_data$genus <- sapply(split_names, `[`, 1)
all_data$species <- sapply(split_names, `[`, 2)

all_data <- as.data.frame(all_data)

set.seed(123)

# Run model
## Note that this model fails if we add an observation-level random effect
model_days_strict50 <-  glmer(overheating_days_strict50 ~ habitat_scenario - 1 + (1|genus/species), 
                              family = "poisson",
                              control = glmerControl(optimizer = "bobyqa",
                                                     optCtrl = list(maxfun = 1000000000)),
                              data = all_data)


# Get predictions
predictions <- as.data.frame(ggpredict(model_days_strict50, 
                                       terms = "habitat_scenario", 
                                       type = "simulate", 
                                       interval = "confidence", 
                                       nsim = 1000))

predictions <- predictions %>% rename(habitat_scenario = x, 
                                      prediction = predicted,
                                      se = std.error, 
                                      lower_CI = conf.low, 
                                      upper_CI = conf.high) %>% dplyr::select(-group)


# Save model and predictions
saveRDS(model_days_strict50, file = "RData/Models/overheating_days/sensitivity_analyses/model_lme4_overheating_days_strict50.rds")
saveRDS(predictions, file = "RData/Models/overheating_days/sensitivity_analyses/predictions_lme4_overheating_days_strict50.rds")

# Contrasts
all_data$habitat_scenario <- as.factor(all_data$habitat_scenario)

model_days_strict50_contrast <-  glmer(overheating_days_strict50 ~ habitat_scenario + (1|genus/species), 
                                       family = "poisson",
                                       control = glmerControl(optimizer = "bobyqa",
                                                              optCtrl = list(maxfun = 1000000000)),
                                       data = all_data)


# Save model
saveRDS(model_days_strict50_contrast, file = "RData/Models/overheating_days/sensitivity_analyses/model_lme4_overheating_days_contrast_strict50.rds")

##########

# Here we only consider overheating events when maximum temperatures exceed 95% of the predicted distribution of CTmax

# Function to run population-level overheating_days models in parallel (sensitivity analysis, 95%)
run_overheating_days_analysis_strict95 <- function(dataset, habitat_scenario) {
  
  split_names <- strsplit(as.character(dataset$tip.label), ' ')
  dataset$genus <- sapply(split_names, `[`, 1)
  dataset$species <- sapply(split_names, `[`, 2)
  
  data <- dataset 
  
  # Run model
  model <- gamm4::gamm4(overheating_days_strict95 ~ s(lat, bs = "tp"), 
                        random = ~  (1 | genus/species),
                        data = data,
                        family = poisson(),
                        REML = TRUE)
  
  # Generate data set for predictions
  new_data <- data.frame(
    lat = seq(min(data$lat), max(data$lat), length = 1000),
    overheating_days_strict95 = NA, 
    genus = NA, 
    species = NA)
  
  # Predict for each latitude value
  pred <- predict(model$gam, newdata = new_data, type = "response", se.fit = TRUE)
  new_data$overheating_days_pred <- pred$fit
  new_data$overheating_days_pred_se <- pred$se.fit
  
  # Calculate 95% confidence intervals
  new_data <- mutate(new_data, 
                     upper = overheating_days_pred + 1.96 * overheating_days_pred_se,
                     lower = overheating_days_pred - 1.96 * overheating_days_pred_se)
  
  # Model summaries 
  summary_gam <- capture.output(summary(model$gam)) # Generalised additive model
  summary_mer <- capture.output(summary(model$mer)) # Mixed effect regression
  
  # Save model and predictions
  saveRDS(summary_gam, file = paste0("RData/Models/overheating_days/sensitivity_analyses/summary_GAM_lat_overheating_days_strict95_", habitat_scenario, ".rds"))
  saveRDS(summary_mer, file = paste0("RData/Models/overheating_days/sensitivity_analyses/summary_MER_lat_overheating_days_strict95_", habitat_scenario, ".rds"))
  saveRDS(new_data, file = paste0("RData/Models/overheating_days/sensitivity_analyses/predictions_pop_lat_overheating_days_strict95_", habitat_scenario, ".rds"))
}


# Run function
results <- future_lapply(
  names(dataset_list), 
  function(x) {run_overheating_days_analysis_strict95(dataset_list[[x]], x)},
  future.packages = c("gamm4", "mgcv", "dplyr")
)

########################################
# Run analyses with lme4 to estimate mean estimates in each microhabitat and scenario

# Run model
model_days_strict95 <-  glmer(overheating_days_strict95 ~ habitat_scenario - 1 + (1|genus/species), 
                              family = "poisson",
                              control = glmerControl(optimizer = "bobyqa",
                                                     optCtrl = list(maxfun = 1000000000)),
                              data = all_data)


# Get predictions
predictions <- as.data.frame(ggpredict(model_days_strict95, 
                                       terms = "habitat_scenario", 
                                       type = "simulate", 
                                       interval = "confidence", 
                                       nsim = 1000))

predictions <- predictions %>% rename(habitat_scenario = x, 
                                      prediction = predicted,
                                      se = std.error, 
                                      lower_CI = conf.low, 
                                      upper_CI = conf.high) %>% dplyr::select(-group)
# Save model 
saveRDS(model_days_strict95, file = "RData/Models/overheating_days/sensitivity_analyses/model_lme4_overheating_days_strict95.rds")
saveRDS(predictions, file = "RData/Models/overheating_days/sensitivity_analyses/predictions_lme4_overheating_days_strict95.rds")

# Contrasts
model_days_strict95_contrast <-  glmer(overheating_days_strict95 ~ habitat_scenario + (1|genus/species), 
                                       family = "poisson",
                                       control = glmerControl(optimizer = "bobyqa",
                                                              optCtrl = list(maxfun = 1000000000)),
                                       data = all_data)


saveRDS(model_days_strict95_contrast, file = "RData/Models/overheating_days/sensitivity_analyses/model_lme4_overheating_days_contrast_strict95.rds")

